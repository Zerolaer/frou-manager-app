import{j as e,s as j}from"./index-DEjx_rPC.js";import{r as o}from"./vendor-CqGws4Uo.js";import{b as ue,i as he,a as Q,c as J,d as Pe,s as je,e as Ge,f as F,g as ve,h as De,j as Te}from"./utils-DyBHi9Eu.js";import{U as se,u as fe}from"./ModalSystem-C_RBbtD1.js";import{M as we,a as $,b as ie,c as xe,d as _e,e as Ee}from"./ModalForm-CkGhW_bH.js";import{C as Le,c as We,P as Oe,X as Ae}from"./icons-BC5Gm12n.js";import{C as Ie,T as Fe}from"./TaskViewModal-CMQfo4aX.js";import{u as Re}from"./errorHandler-Cx-r6NKo.js";import{u as qe}from"./useSupabaseAuth-B2dq7EbK.js";import{T as Z,e as ne,f as ae}from"./constants-FoW-FSWv.js";import"./supabase-BmeMSZYH.js";function ee(n,i){if(n.one!==void 0&&i===1)return n.one;const d=i%10,u=i%100;return d===1&&u!==11?n.singularNominative.replace("{{count}}",String(i)):d>=2&&d<=4&&(u<10||u>20)?n.singularGenitive.replace("{{count}}",String(i)):n.pluralGenitive.replace("{{count}}",String(i))}function k(n){return(i,d)=>d?.addSuffix?d.comparison&&d.comparison>0?n.future?ee(n.future,i):"через "+ee(n.regular,i):n.past?ee(n.past,i):ee(n.regular,i)+" назад":ee(n.regular,i)}const $e={lessThanXSeconds:k({regular:{one:"меньше секунды",singularNominative:"меньше {{count}} секунды",singularGenitive:"меньше {{count}} секунд",pluralGenitive:"меньше {{count}} секунд"},future:{one:"меньше, чем через секунду",singularNominative:"меньше, чем через {{count}} секунду",singularGenitive:"меньше, чем через {{count}} секунды",pluralGenitive:"меньше, чем через {{count}} секунд"}}),xSeconds:k({regular:{singularNominative:"{{count}} секунда",singularGenitive:"{{count}} секунды",pluralGenitive:"{{count}} секунд"},past:{singularNominative:"{{count}} секунду назад",singularGenitive:"{{count}} секунды назад",pluralGenitive:"{{count}} секунд назад"},future:{singularNominative:"через {{count}} секунду",singularGenitive:"через {{count}} секунды",pluralGenitive:"через {{count}} секунд"}}),halfAMinute:(n,i)=>i?.addSuffix?i.comparison&&i.comparison>0?"через полминуты":"полминуты назад":"полминуты",lessThanXMinutes:k({regular:{one:"меньше минуты",singularNominative:"меньше {{count}} минуты",singularGenitive:"меньше {{count}} минут",pluralGenitive:"меньше {{count}} минут"},future:{one:"меньше, чем через минуту",singularNominative:"меньше, чем через {{count}} минуту",singularGenitive:"меньше, чем через {{count}} минуты",pluralGenitive:"меньше, чем через {{count}} минут"}}),xMinutes:k({regular:{singularNominative:"{{count}} минута",singularGenitive:"{{count}} минуты",pluralGenitive:"{{count}} минут"},past:{singularNominative:"{{count}} минуту назад",singularGenitive:"{{count}} минуты назад",pluralGenitive:"{{count}} минут назад"},future:{singularNominative:"через {{count}} минуту",singularGenitive:"через {{count}} минуты",pluralGenitive:"через {{count}} минут"}}),aboutXHours:k({regular:{singularNominative:"около {{count}} часа",singularGenitive:"около {{count}} часов",pluralGenitive:"около {{count}} часов"},future:{singularNominative:"приблизительно через {{count}} час",singularGenitive:"приблизительно через {{count}} часа",pluralGenitive:"приблизительно через {{count}} часов"}}),xHours:k({regular:{singularNominative:"{{count}} час",singularGenitive:"{{count}} часа",pluralGenitive:"{{count}} часов"}}),xDays:k({regular:{singularNominative:"{{count}} день",singularGenitive:"{{count}} дня",pluralGenitive:"{{count}} дней"}}),aboutXWeeks:k({regular:{singularNominative:"около {{count}} недели",singularGenitive:"около {{count}} недель",pluralGenitive:"около {{count}} недель"},future:{singularNominative:"приблизительно через {{count}} неделю",singularGenitive:"приблизительно через {{count}} недели",pluralGenitive:"приблизительно через {{count}} недель"}}),xWeeks:k({regular:{singularNominative:"{{count}} неделя",singularGenitive:"{{count}} недели",pluralGenitive:"{{count}} недель"}}),aboutXMonths:k({regular:{singularNominative:"около {{count}} месяца",singularGenitive:"около {{count}} месяцев",pluralGenitive:"около {{count}} месяцев"},future:{singularNominative:"приблизительно через {{count}} месяц",singularGenitive:"приблизительно через {{count}} месяца",pluralGenitive:"приблизительно через {{count}} месяцев"}}),xMonths:k({regular:{singularNominative:"{{count}} месяц",singularGenitive:"{{count}} месяца",pluralGenitive:"{{count}} месяцев"}}),aboutXYears:k({regular:{singularNominative:"около {{count}} года",singularGenitive:"около {{count}} лет",pluralGenitive:"около {{count}} лет"},future:{singularNominative:"приблизительно через {{count}} год",singularGenitive:"приблизительно через {{count}} года",pluralGenitive:"приблизительно через {{count}} лет"}}),xYears:k({regular:{singularNominative:"{{count}} год",singularGenitive:"{{count}} года",pluralGenitive:"{{count}} лет"}}),overXYears:k({regular:{singularNominative:"больше {{count}} года",singularGenitive:"больше {{count}} лет",pluralGenitive:"больше {{count}} лет"},future:{singularNominative:"больше, чем через {{count}} год",singularGenitive:"больше, чем через {{count}} года",pluralGenitive:"больше, чем через {{count}} лет"}}),almostXYears:k({regular:{singularNominative:"почти {{count}} год",singularGenitive:"почти {{count}} года",pluralGenitive:"почти {{count}} лет"},future:{singularNominative:"почти через {{count}} год",singularGenitive:"почти через {{count}} года",pluralGenitive:"почти через {{count}} лет"}})},Ve=(n,i,d)=>$e[n](i,d),ze={full:"EEEE, d MMMM y 'г.'",long:"d MMMM y 'г.'",medium:"d MMM y 'г.'",short:"dd.MM.y"},He={full:"H:mm:ss zzzz",long:"H:mm:ss z",medium:"H:mm:ss",short:"H:mm"},Xe={any:"{{date}}, {{time}}"},Ke={date:ue({formats:ze,defaultWidth:"full"}),time:ue({formats:He,defaultWidth:"full"}),dateTime:ue({formats:Xe,defaultWidth:"any"})},pe=["воскресенье","понедельник","вторник","среду","четверг","пятницу","субботу"];function Ye(n){const i=pe[n];switch(n){case 0:return"'в прошлое "+i+" в' p";case 1:case 2:case 4:return"'в прошлый "+i+" в' p";case 3:case 5:case 6:return"'в прошлую "+i+" в' p"}}function ye(n){const i=pe[n];return n===2?"'во "+i+" в' p":"'в "+i+" в' p"}function Ue(n){const i=pe[n];switch(n){case 0:return"'в следующее "+i+" в' p";case 1:case 2:case 4:return"'в следующий "+i+" в' p";case 3:case 5:case 6:return"'в следующую "+i+" в' p"}}const Be={lastWeek:(n,i,d)=>{const u=n.getDay();return he(n,i,d)?ye(u):Ye(u)},yesterday:"'вчера в' p",today:"'сегодня в' p",tomorrow:"'завтра в' p",nextWeek:(n,i,d)=>{const u=n.getDay();return he(n,i,d)?ye(u):Ue(u)},other:"P"},Qe=(n,i,d,u)=>{const p=Be[n];return typeof p=="function"?p(i,d,u):p},Je={narrow:["до н.э.","н.э."],abbreviated:["до н. э.","н. э."],wide:["до нашей эры","нашей эры"]},Ze={narrow:["1","2","3","4"],abbreviated:["1-й кв.","2-й кв.","3-й кв.","4-й кв."],wide:["1-й квартал","2-й квартал","3-й квартал","4-й квартал"]},et={narrow:["Я","Ф","М","А","М","И","И","А","С","О","Н","Д"],abbreviated:["янв.","фев.","март","апр.","май","июнь","июль","авг.","сент.","окт.","нояб.","дек."],wide:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"]},tt={narrow:["Я","Ф","М","А","М","И","И","А","С","О","Н","Д"],abbreviated:["янв.","фев.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],wide:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"]},nt={narrow:["В","П","В","С","Ч","П","С"],short:["вс","пн","вт","ср","чт","пт","сб"],abbreviated:["вск","пнд","втр","срд","чтв","птн","суб"],wide:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"]},at={narrow:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утро",afternoon:"день",evening:"веч.",night:"ночь"},abbreviated:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утро",afternoon:"день",evening:"веч.",night:"ночь"},wide:{am:"ДП",pm:"ПП",midnight:"полночь",noon:"полдень",morning:"утро",afternoon:"день",evening:"вечер",night:"ночь"}},it={narrow:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утра",afternoon:"дня",evening:"веч.",night:"ночи"},abbreviated:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утра",afternoon:"дня",evening:"веч.",night:"ночи"},wide:{am:"ДП",pm:"ПП",midnight:"полночь",noon:"полдень",morning:"утра",afternoon:"дня",evening:"вечера",night:"ночи"}},st=(n,i)=>{const d=Number(n),u=i?.unit;let p;return u==="date"?p="-е":u==="week"||u==="minute"||u==="second"?p="-я":p="-й",d+p},rt={ordinalNumber:st,era:Q({values:Je,defaultWidth:"wide"}),quarter:Q({values:Ze,defaultWidth:"wide",argumentCallback:n=>n-1}),month:Q({values:et,defaultWidth:"wide",formattingValues:tt,defaultFormattingWidth:"wide"}),day:Q({values:nt,defaultWidth:"wide"}),dayPeriod:Q({values:at,defaultWidth:"any",formattingValues:it,defaultFormattingWidth:"wide"})},ot=/^(\d+)(-?(е|я|й|ое|ье|ая|ья|ый|ой|ий|ый))?/i,lt=/\d+/i,ct={narrow:/^((до )?н\.?\s?э\.?)/i,abbreviated:/^((до )?н\.?\s?э\.?)/i,wide:/^(до нашей эры|нашей эры|наша эра)/i},dt={any:[/^д/i,/^н/i]},ut={narrow:/^[1234]/i,abbreviated:/^[1234](-?[ыои]?й?)? кв.?/i,wide:/^[1234](-?[ыои]?й?)? квартал/i},mt={any:[/1/i,/2/i,/3/i,/4/i]},ft={narrow:/^[яфмаисонд]/i,abbreviated:/^(янв|фев|март?|апр|ма[йя]|июн[ья]?|июл[ья]?|авг|сент?|окт|нояб?|дек)\.?/i,wide:/^(январ[ья]|феврал[ья]|марта?|апрел[ья]|ма[йя]|июн[ья]|июл[ья]|августа?|сентябр[ья]|октябр[ья]|октябр[ья]|ноябр[ья]|декабр[ья])/i},pt={narrow:[/^я/i,/^ф/i,/^м/i,/^а/i,/^м/i,/^и/i,/^и/i,/^а/i,/^с/i,/^о/i,/^н/i,/^я/i],any:[/^я/i,/^ф/i,/^мар/i,/^ап/i,/^ма[йя]/i,/^июн/i,/^июл/i,/^ав/i,/^с/i,/^о/i,/^н/i,/^д/i]},gt={narrow:/^[впсч]/i,short:/^(вс|во|пн|по|вт|ср|чт|че|пт|пя|сб|су)\.?/i,abbreviated:/^(вск|вос|пнд|пон|втр|вто|срд|сре|чтв|чет|птн|пят|суб).?/i,wide:/^(воскресень[ея]|понедельника?|вторника?|сред[аы]|четверга?|пятниц[аы]|суббот[аы])/i},ht={narrow:[/^в/i,/^п/i,/^в/i,/^с/i,/^ч/i,/^п/i,/^с/i],any:[/^в[ос]/i,/^п[он]/i,/^в/i,/^ср/i,/^ч/i,/^п[ят]/i,/^с[уб]/i]},vt={narrow:/^([дп]п|полн\.?|полд\.?|утр[оа]|день|дня|веч\.?|ноч[ьи])/i,abbreviated:/^([дп]п|полн\.?|полд\.?|утр[оа]|день|дня|веч\.?|ноч[ьи])/i,wide:/^([дп]п|полночь|полдень|утр[оа]|день|дня|вечера?|ноч[ьи])/i},xt={any:{am:/^дп/i,pm:/^пп/i,midnight:/^полн/i,noon:/^полд/i,morning:/^у/i,afternoon:/^д[ен]/i,evening:/^в/i,night:/^н/i}},yt={ordinalNumber:Pe({matchPattern:ot,parsePattern:lt,valueCallback:n=>parseInt(n,10)}),era:J({matchPatterns:ct,defaultMatchWidth:"wide",parsePatterns:dt,defaultParseWidth:"any"}),quarter:J({matchPatterns:ut,defaultMatchWidth:"wide",parsePatterns:mt,defaultParseWidth:"any",valueCallback:n=>n+1}),month:J({matchPatterns:ft,defaultMatchWidth:"wide",parsePatterns:pt,defaultParseWidth:"any"}),day:J({matchPatterns:gt,defaultMatchWidth:"wide",parsePatterns:ht,defaultParseWidth:"any"}),dayPeriod:J({matchPatterns:vt,defaultMatchWidth:"wide",parsePatterns:xt,defaultParseWidth:"any"})},re={code:"ru",formatDistance:Ve,formatLong:Ke,formatRelative:Qe,localize:rt,match:yt,options:{weekStartsOn:1,firstWeekContainsDate:1}},be=["#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1","#a855f7","#ec4899","#f43f5e","#64748b"];function bt({open:n,onClose:i,userId:d,onCreated:u}){const[p,v]=o.useState(""),[G,R]=o.useState(be[8]),[N,E]=o.useState(!1),{createStandardFooter:A}=fe();async function q(){const x=p.trim();if(x){E(!0);try{let S="",D=x,h=await j.from("tasks_projects").insert({user_id:d,name:x,color:G}).select("id,name").single();if(h.error){const w=await j.from("tasks_projects").insert({user_id:d,name:x}).select("id,name").single();if(w.error)return;S=w.data.id,D=w.data.name}else S=h.data.id,D=h.data.name;u({id:S,name:D,color:G}),v(""),i()}finally{E(!1)}}}return e.jsx(se,{open:n,onClose:i,title:"Новый проект",footer:A({label:"Создать",onClick:q,loading:N,disabled:!p.trim()},{label:"Отмена",onClick:i}),children:e.jsxs(we,{children:[e.jsx($,{label:"Название",required:!0,children:e.jsx(ie,{value:p,onChange:x=>v(x.target.value),placeholder:"Например, Website Redesign",autoFocus:!0})}),e.jsx($,{label:"Цвет",children:e.jsx("div",{className:"grid grid-cols-7 gap-2",children:be.map(x=>e.jsx("button",{onClick:()=>R(x),title:x,className:`w-8 h-8 rounded-full border-2 transition-all ${G===x?"border-gray-900":"border-gray-200"}`,style:{backgroundColor:x}},x))})})]})})}const jt=["#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1","#a855f7","#ec4899","#f43f5e","#64748b"];function wt({userId:n,activeId:i,onChange:d}){const[u,p]=o.useState([]),[v,G]=o.useState(!1),[R,N]=o.useState(!1),[E,A]=o.useState(!1),{createSimpleFooter:q,createDangerFooter:x}=fe();o.useEffect(()=>{n&&(async()=>{const r=await j.from("tasks_projects").select("id,name,color,position").order("position",{ascending:!0}).order("created_at",{ascending:!0});if(!r.error){N(!0),A(!0),p([{id:"ALL",name:"Все проекты",color:null},...r.data||[]]);return}const g=await j.from("tasks_projects").select("id,name").order("created_at",{ascending:!0});g.error||p([{id:"ALL",name:"Все проекты",color:null},...g.data||[]])})()},[n]);const S=o.useRef(null);function D(r){S.current=r}async function h(r){const g=S.current;if(S.current=null,!g||g===r)return;if(!E){const s=[...u],c=s.findIndex(P=>P.id===g),b=s.findIndex(P=>P.id===r);if(c<0||b<0)return;const[I]=s.splice(c,1);s.splice(b,0,I),p(s);return}const z=[...u],te=z.findIndex(s=>s.id===g),a=z.findIndex(s=>s.id===r);if(te<0||a<0)return;const[l]=z.splice(te,1);z.splice(a,0,l);const t=z.map((s,c)=>({...s,position:c}));p(t),await Promise.all(t.map(s=>j.from("tasks_projects").update({position:s.position}).eq("id",s.id)))}const[w,y]=o.useState(!1),[C,M]=o.useState({x:0,y:0}),[f,L]=o.useState(null),W=o.useRef(null);o.useEffect(()=>{const r=g=>{w&&W.current&&!W.current.contains(g.target)&&y(!1)};return document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[w]);function H(r,g){g.id!=="ALL"&&(r.preventDefault(),L(g),M({x:r.clientX,y:r.clientY}),y(!0))}const[Y,V]=o.useState(!1),[X,U]=o.useState(""),[m,T]=o.useState(!1);async function _(){if(!f)return;const r=X.trim();r&&(await j.from("tasks_projects").update({name:r}).eq("id",f.id),p(u.map(g=>g.id===f.id?{...g,name:r}:g)),V(!1))}async function K(){f&&(await j.from("tasks_projects").delete().eq("id",f.id),p(u.filter(r=>r.id!==f.id)),i===f.id&&d(null),T(!1))}async function oe(r){f&&(R&&await j.from("tasks_projects").update({color:r}).eq("id",f.id),p(u.map(g=>g.id===f.id?{...g,color:r}:g)),y(!1))}function le(r){p(g=>[...g,{id:r.id,name:r.name,color:r.color}]),d(r.id)}return e.jsxs("aside",{className:"tasks-projects rounded-xl border border-gray-200 bg-white",style:{width:280},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700",children:"Проекты"}),e.jsx("button",{className:"btn btn-outline w-[34px] h-[34px] p-0 flex items-center justify-center",onClick:()=>G(!0),children:"+"})]}),e.jsx("div",{className:"space-y-1",children:u.map(r=>e.jsx("div",{children:e.jsxs("button",{draggable:r.id!=="ALL",onDragStart:()=>D(r.id),onDragOver:g=>{g.preventDefault()},onDrop:()=>h(r.id),onClick:()=>d(r.id),onContextMenu:g=>H(g,r),className:`w-full rounded-lg border px-3 py-2 text-left flex items-center gap-2 ${i===r.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:bg-gray-50"}`,title:r.name,children:[e.jsx("span",{className:"mr-2 inline-flex items-center",style:{color:r.color||"#94a3b8"},children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",stroke:"currentColor","stroke-width":"1.5",children:e.jsx("path",{d:"M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"})})}),e.jsx("span",{className:"truncate",children:r.name})]})},r.id))}),w&&f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:()=>y(!1)}),e.jsxs("div",{className:"ctx-menu",ref:W,style:{left:C.x,top:C.y,minWidth:200,padding:6},children:[e.jsx("div",{className:"dd-item",onClick:()=>{U(f.name),V(!0),y(!1)},children:"Переименовать"}),e.jsxs("div",{className:"dd-item",children:[e.jsx("div",{className:"mb-1 text-xs text-gray-500",children:"Цвет"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(7, 18px)",gap:6},children:jt.map(r=>e.jsx("button",{onClick:()=>oe(r),style:{width:18,height:18,borderRadius:9999,background:r,border:"1px solid rgba(0,0,0,.08)"}},r))})]}),e.jsx("div",{className:"dd-item",style:{color:"#b91c1c"},onClick:()=>{T(!0),y(!1)},children:"Удалить"})]})]}),e.jsx(bt,{open:v,onClose:()=>G(!1),userId:n,onCreated:le}),e.jsx(se,{open:Y,onClose:()=>V(!1),title:"Переименовать проект",footer:q({label:"Сохранить",onClick:_,disabled:!X.trim()},{label:"Отмена",onClick:()=>V(!1)}),children:e.jsx("input",{className:"border rounded-lg px-3 py-2 text-sm w-full",value:X,onChange:r=>U(r.target.value)})}),e.jsx(se,{open:m,onClose:()=>T(!1),title:"Удалить проект?",footer:x({label:"Удалить",onClick:K},{label:"Отмена",onClick:()=>T(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Проект и связанные задачи будут удалены."})})]})}function kt({anchor:n,onPrev:i,onNext:d}){const u=je(n,{weekStartsOn:1}),p=Ge(u,6);return e.jsxs("div",{className:"timeline",children:[e.jsx("button",{className:"nav-left btn btn-outline w-[34px] h-[34px] p-0 flex items-center justify-center week-nav",onClick:i,"aria-label":"Предыдущая неделя",children:e.jsx(Le,{size:16})}),e.jsxs("div",{className:"range",children:[F(u,"d MMM",{locale:re})," — ",F(p,"d MMM, yyyy",{locale:re})]}),e.jsx("button",{className:"nav-right btn btn-outline w-[34px] h-[34px] p-0 flex items-center justify-center week-nav",onClick:d,"aria-label":"Следующая неделя",children:e.jsx(We,{size:16})})]})}function Nt({open:n,onClose:i,onSubmit:d,dateLabel:u,projects:p=[],activeProject:v}){const[G,R]=o.useState(""),[N,E]=o.useState(""),[A,q]=o.useState("normal"),[x,S]=o.useState(""),[D,h]=o.useState([]),[w,y]=o.useState(""),[C,M]=o.useState(!1),{createStandardFooter:f}=fe(),L=v&&v!=="ALL"?v:"",[W,H]=o.useState(L);o.useEffect(()=>{n&&H(v&&v!=="ALL"?v:"")},[n,v]);function Y(){const m=w.trim();m&&(h(T=>[...T,{id:String(Date.now()),text:m,done:!1}]),y(""))}function V(m){h(T=>T.map(_=>_.id===m?{..._,done:!_.done}:_))}function X(m){h(T=>T.filter(_=>_.id!==m))}async function U(){const m=G.trim();if(m&&W){M(!0);try{await d(m,N,String(A),x.trim(),D,W),R(""),E(""),q("normal"),S(""),h([]),y(""),i()}finally{M(!1)}}}return e.jsx(se,{size:"lg",open:n,onClose:i,title:"Новая задача",subtitle:u,footer:f({label:"Добавить",onClick:U,loading:C,disabled:!W||!G.trim()},{label:"Отмена",onClick:i}),children:e.jsxs(we,{children:[e.jsx($,{label:"Проект",required:!0,children:e.jsxs(xe,{value:W,onChange:m=>H(m.target.value),children:[e.jsx("option",{value:"",children:v==="ALL"?"Выберите проект":"Текущий проект выбран"}),(p||[]).map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})}),e.jsx($,{label:"Название задачи",required:!0,children:e.jsx(ie,{value:G,onChange:m=>R(m.target.value),placeholder:"Название задачи"})}),e.jsx($,{label:"Описание",children:e.jsx(_e,{value:N,onChange:m=>E(m.target.value),placeholder:"Подробности задачи",rows:4})}),e.jsxs(Ee,{cols:2,children:[e.jsx($,{label:"Приоритет",children:e.jsxs(xe,{value:A,onChange:m=>q(m.target.value),children:[e.jsx("option",{value:"low",children:"Низкий"}),e.jsx("option",{value:"normal",children:"Обычный"}),e.jsx("option",{value:"high",children:"Высокий"})]})}),e.jsx($,{label:"Тег",children:e.jsx(ie,{value:x,onChange:m=>S(m.target.value),placeholder:"Напр. Work"})})]}),e.jsx($,{label:"Чек-лист",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ie,{value:w,onChange:m=>y(m.target.value),placeholder:"Добавить пункт"}),e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2",onClick:Y,disabled:!w.trim(),children:[e.jsx(Oe,{className:"w-4 h-4"}),"Добавить"]})]}),D.length>0&&e.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:D.map(m=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded",children:[e.jsx(Ie,{checked:m.done,onToggle:()=>V(m.id)}),e.jsx("span",{className:`text-sm flex-1 ${m.done?"line-through text-gray-400":""}`,children:m.text}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600 p-1",onClick:()=>X(m.id),title:"Удалить",children:e.jsx(Ae,{className:"w-4 h-4"})})]},m.id))})]})})]})})}function me(n,i){if(!n||typeof n!="string"||!/^#?[0-9a-fA-F]{6}$/.test(n))return"rgba(0,0,0,0)";const d=n.startsWith("#")?n.slice(1):n,u=parseInt(d.slice(0,2),16),p=parseInt(d.slice(2,4),16),v=parseInt(d.slice(4,6),16);return`rgba(${u}, ${p}, ${v}, ${i})`}function Ot(){const{handleError:n,handleSuccess:i}=Re(),{userId:d}=qe(),[u,p]=o.useState(null),v=o.useRef(null);function G(a){v.current={id:a.id,from:a.date}}async function R(a){const l=v.current;if(v.current=null,!l||!d)return;const t={...C},s=t[l.from]||[],c=s.find(B=>B.id===l.id),b=s.findIndex(B=>B.id===l.id);b>=0&&s.splice(b,1);const I=t[a]||=[],P=I.length;c&&I.push({...c,date:a,position:P}),M(t),await j.from("tasks_items").update({date:a,position:P}).eq("id",l.id)}const[N,E]=o.useState(()=>je(new Date,{weekStartsOn:1})),[A,q]=o.useState(()=>ve(new Date,{weekStartsOn:1})),x=F(new Date,"yyyy-MM-dd");o.useEffect(()=>{q(ve(N,{weekStartsOn:1}))},[N]);const[S,D]=o.useState([]),[h,w]=o.useState(Z),y=o.useMemo(()=>{const a={};for(const l of S)a[l.id]=l.color||void 0;return a},[S]);o.useEffect(()=>{d&&(async()=>{const a=await j.from("tasks_projects").select("id,name,color").order("created_at",{ascending:!0});if(!a.error){const t=a.data||[];D(t),h||w(Z);return}const l=await j.from("tasks_projects").select("id,name").order("created_at",{ascending:!0});if(!l.error){const t=l.data||[];D(t),h||w(Z)}})()},[d]);const[C,M]=o.useState({});o.useEffect(()=>{if(!d||!h){M({});return}const a=j.from("tasks_items").select("id,project_id,title,description,date,position,priority,tag,todos,status").gte("date",F(N,"yyyy-MM-dd")).lte("date",F(A,"yyyy-MM-dd")).order("date",{ascending:!0}).order("position",{ascending:!0});(h===Z?a:a.eq("project_id",h)).then(({data:t})=>{const s={};(t||[]).forEach(c=>{const b=c.date;(s[b]||=[]).push({id:c.id,project_id:c.project_id,title:c.title,description:c.description,date:c.date,position:c.position,priority:c.priority,tag:c.tag,todos:c.todos||[],status:c.status||ne.OPEN})}),M(s)})},[d,h,N,A]);const[f,L]=o.useState({open:!1,x:0,y:0,task:null,dayKey:void 0});o.useEffect(()=>{const a=l=>{l.key==="Escape"&&L(t=>({...t,open:!1}))};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[]);async function W(a,l){try{const s=(C[l]||[]).length,{data:c,error:b}=await j.from("tasks_items").insert({project_id:a.project_id||h,title:a.title,description:a.description||null,date:l,position:s,priority:a.priority||null,tag:a.tag||null,todos:Array.isArray(a.todos)?a.todos:[]}).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();if(!b&&c){const I={id:c.id,title:c.title,description:c.description||void 0,date:c.date,position:c.position,priority:c.priority||void 0,tag:c.tag||void 0,todos:c.todos||[]},P={...C};(P[l]||=[]).push(I),M(P)}}finally{L(t=>({...t,open:!1}))}}async function H(a,l){try{await j.from("tasks_items").delete().eq("id",a.id);const t={...C},s=t[l]||[],c=s.findIndex(b=>b.id===a.id);c>=0&&(s.splice(c,1),t[l]=s),M(t)}finally{L(t=>({...t,open:!1}))}}const Y=o.useMemo(()=>{const a=[],l=new Date(N);for(let t=0;t<7;t++)a.push(new Date(l.getFullYear(),l.getMonth(),l.getDate()+t));return a},[N]),[V,X]=o.useState(!1),[U,m]=o.useState(""),[T,_]=o.useState(!1),[K,oe]=o.useState(null),[le,r]=o.useState(""),[g,z]=o.useState("");async function te(a,l,t,s,c,b){if(!d||!K)return;const I=b||(h&&h!==Z?h:null);if(!I)return;const P=(a??le).trim(),B=l??g,ke=t??ae.NORMAL,Ne=s??"",Se=Array.isArray(c)?c:[];if(!P)return;const ce=F(K,"yyyy-MM-dd"),Ce=C[ce]?.length||0,{data:O,error:de}=await j.from("tasks_items").insert({project_id:I,title:P,description:B,date:ce,position:Ce,priority:ke,tag:Ne,todos:Se}).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();if(!de&&O){const Me={id:O.id,project_id:O.project_id,title:O.title,description:O.description,date:O.date,position:O.position,priority:O.priority,tag:O.tag,todos:O.todos||[]},ge={...C};(ge[ce]||=[]).push(Me),M(ge),i(`Задача "${P}" создана`),r(""),z(""),_(!1)}else de&&n(de,"Создание задачи")}return e.jsxs("div",{className:"tasks-page",children:[e.jsx(wt,{userId:d,activeId:h,onChange:w}),e.jsx("section",{className:"tasks-board",children:e.jsxs("div",{className:"week-grid",children:[e.jsx("div",{className:"week-head",children:e.jsx(kt,{anchor:N,onPrev:()=>E(a=>Te(a)),onNext:()=>E(a=>De(a,1))})}),Y.map(a=>{const l=F(a,"yyyy-MM-dd");return e.jsxs("div",{onDragOver:t=>t.preventDefault(),onDrop:()=>R(l),className:`day-col ${[0,6].includes(new Date(a).getDay())?"is-weekend":""} ${l===x?"is-today":""}`,children:[e.jsxs("div",{className:"day-head",children:[e.jsx("span",{children:F(a,"EEE, d MMM",{locale:re})}),e.jsx("button",{className:"btn btn-outline btn-xs add-on-hover",onClick:()=>{oe(a),_(!0)},children:"+ Задача"})]}),e.jsx("div",{className:"day-body",children:(C[l]||[]).map(t=>e.jsx("div",{className:`task-card ${t.status===ne.CLOSED?"is-closed":""}`,style:{backgroundColor:y[t.project_id]?me(y[t.project_id],.1):void 0,border:y[t.project_id]?`1px solid ${me(y[t.project_id],.5)}`:"1px solid #e5e7eb"},onContextMenu:s=>{s.preventDefault(),s.stopPropagation(),L({open:!0,x:s.clientX,y:s.clientY,task:t,dayKey:l})},onMouseDownCapture:s=>{s.button===2&&(s.preventDefault(),s.stopPropagation())},onDragStart:()=>G(t),onClick:s=>{f.open||p(t)},draggable:!0,children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.priority?e.jsx("span",{className:"inline-block rounded-full "+(t.priority===ae.HIGH?"w-2.5 h-2.5 bg-red-500":t.priority===ae.LOW?"w-2.5 h-2.5 bg-green-500":t.priority===ae.MEDIUM?"w-2.5 h-2.5 bg-yellow-500":"w-2.5 h-2.5 bg-gray-300")}):null,t.tag?e.jsx("span",{className:"px-2 py-0.5 text-xs rounded-full leading-none uppercase",style:{backgroundColor:y[t.project_id]?me(y[t.project_id],.2):"#e5e7eb",color:"#111827"},children:t.tag}):null]}),e.jsx("div",{className:"leading-tight clamp-2 break-words mb-2",children:e.jsx("span",{className:"font-medium",children:t.title})}),e.jsx("div",{className:"text-xs text-gray-500 mt-0",children:(()=>{const s=Array.isArray(t.todos)?t.todos.length:0;return`${Array.isArray(t.todos)?t.todos.filter(b=>b.done).length:0}/${s}`})()})]})},t.id))})]},l)})]})}),e.jsx(Nt,{open:T,projects:S,activeProject:h,onClose:()=>_(!1),dateLabel:K?F(K,"d MMMM, EEEE",{locale:re}):"",onSubmit:async(a,l,t,s,c,b)=>{await te(a,l,t,s,c,b)}}),e.jsx(Fe,{open:!!u,onClose:()=>p(null),task:u,onUpdated:a=>{if(!a)return;const l={...C},t=l[a.date||""]||[],s=t.findIndex(c=>c.id===a.id);s>=0&&(t[s]={...t[s],...a},M(l))}}),f.open&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:()=>L(a=>({...a,open:!1}))}),e.jsxs("div",{className:"ctx-menu",style:{left:f.x,top:f.y},children:[e.jsx("div",{className:"ctx-item",onClick:()=>f.task&&f.dayKey&&W(f.task,f.dayKey),children:"Дублировать"}),e.jsx("div",{className:"ctx-item",onClick:async()=>{f.task&&f.dayKey&&(await j.from("tasks_items").update({status:ne.CLOSED}).eq("id",f.task.id),M(a=>{const l={...a},t=[...l[f.dayKey]||[]],s=t.findIndex(c=>c.id===f.task.id);return s>=0&&(t[s]={...t[s],status:ne.CLOSED}),l[f.dayKey]=t,l}),L(a=>({...a,open:!1})))},children:"Выполнить"}),e.jsx("div",{className:"ctx-item text-red-600",onClick:()=>f.task&&f.dayKey&&H(f.task,f.dayKey),children:"Удалить"})]})]})]})}export{Ot as default};
