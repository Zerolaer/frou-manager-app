import{s as T,j as e}from"./index-Dl3xerX_.js";import{S as an}from"./LoadingStates-DcX5nDeq.js";import{r as l}from"./vendor-5APVzNZg.js";import{M as ln,U as oe,a as rn,b as cn,u as on}from"./ModalSystem-zUQVNNbI.js";import{P as ve,b as dn,T as un,C as mn,c as fn,d as xn,E as pn}from"./icons-BBrol7Dz.js";import{f as hn}from"./format-CfBjB5Ts.js";import{u as vn}from"./errorHandler-6EP6Ox9l.js";import{u as Nn}from"./useSupabaseAuth-Bfp9L3vQ.js";import{C as he,F as W,M as ee,a as Ie,b as gn,c as De,d as jn}from"./constants-FoW-FSWv.js";import"./supabase-7cNBIxai.js";function yn({open:p,onClose:v,userId:u,categoryId:m,categoryName:g,monthIndex:N,year:f,onApply:c}){const[b,h]=l.useState(!0),[t,w]=l.useState([]),[j,F]=l.useState(""),[_,A]=l.useState(""),P=l.useRef({}),z=(i,y,C=350)=>{clearTimeout(P.current[i]),P.current[i]=setTimeout(y,C)},de=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][N];l.useMemo(()=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"EUR"}),[]);const G=l.useRef(null);l.useEffect(()=>{p&&(async()=>{h(!0);const{data:i,error:y}=await T.from("finance_entries").select("id, amount, note, included, position, created_at").eq("category_id",m).eq("year",f).eq("month",N+1).order("position",{ascending:!0}).order("created_at",{ascending:!0});if(y){console.error(y),h(!1);return}const C=(i||[]).map(E=>({id:E.id,amount:Number(E.amount)||0,note:E.note,included:!!E.included,position:E.position??0}));w(C),h(!1)})()},[p,m,N,f]);function H(i){return i.reduce((y,C)=>y+(C.included?C.amount:0),0)}async function ue(){const i=Number(String(j).replace(",","."));if(!u||isNaN(i))return;const y={user_id:u,category_id:m,year:f,month:N+1,amount:i,note:_,included:!0,position:t.length},{data:C,error:E}=await T.from("finance_entries").insert(y).select("id, amount, note, included, position").single();if(E){console.error(E);return}const I=[...t,{id:C.id,amount:Number(C.amount)||0,note:C.note,included:!!C.included,position:C.position??t.length}];w(I),F(""),A(""),c(H(I))}function L(i,y){w(C=>{const E=C.map(I=>I.id===i?{...I,...y}:I);return c(H(E)),E})}function te(i,y){const C=Number(String(y).replace(",","."));L(i,{amount:isNaN(C)?0:C}),z("amt:"+i,async()=>{const{error:E}=await T.from("finance_entries").update({amount:isNaN(C)?0:C}).eq("id",i);E&&console.error(E)})}function B(i,y){L(i,{note:y}),z("note:"+i,async()=>{const{error:C}=await T.from("finance_entries").update({note:y}).eq("id",i);C&&console.error(C)})}async function J(i,y){L(i,{included:y});const{error:C}=await T.from("finance_entries").update({included:y}).eq("id",i);C&&console.error(C)}async function se(i){const{error:y}=await T.from("finance_entries").delete().eq("id",i);if(y){console.error(y);return}const C=t.filter(E=>E.id!==i);C.forEach((E,I)=>{E.position=I}),w(C),c(H(C)),await Promise.all(C.map((E,I)=>T.from("finance_entries").update({position:I}).eq("id",E.id)))}function U(i){G.current=i}function $(i){i.preventDefault()}async function ae(i){const y=G.current;if(G.current=null,!y||y===i)return;const C=t.findIndex(O=>O.id===y),E=t.findIndex(O=>O.id===i);if(C<0||E<0)return;const I=t.slice(),[le]=I.splice(C,1);I.splice(E,0,le),I.forEach((O,Q)=>{O.position=Q}),w(I),c(H(I)),await Promise.all(I.map((O,Q)=>T.from("finance_entries").update({position:Q}).eq("id",O.id)))}return e.jsx(ln,{open:p,onClose:v,title:e.jsxs("span",{bodyClassName:"p-0",children:[e.jsx("b",{children:g})," · ",de," ",f]}),footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn btn-outline",onClick:v,children:"Закрыть"})}),size:"md",children:e.jsxs("div",{className:"editor-body",children:[b&&e.jsx("div",{className:"loading-overlay",children:"Загрузка…"}),e.jsxs("div",{className:"editor-add",children:[e.jsx("input",{type:"number",placeholder:"Сумма (€)",value:j,onChange:i=>F(i.target.value),className:"editor-input number"}),e.jsx("input",{placeholder:"Описание (необязательно)",value:_,onChange:i=>A(i.target.value),className:"editor-input text"}),e.jsxs("button",{className:"btn btn-outline flex items-center gap-2",onClick:ue,children:[e.jsx(ve,{className:"w-4 h-4"}),"Добавить"]})]}),e.jsxs("div",{children:[t.map(i=>e.jsxs("div",{className:"entry-row "+(i.included?"":"entry-disabled"),draggable:!0,onDragStart:()=>U(i.id),onDragOver:$,onDrop:()=>ae(i.id),children:[e.jsx("div",{className:"entry-drag",children:e.jsx(dn,{className:"w-4 h-4"})}),e.jsxs("label",{className:"chk",children:[e.jsx("input",{type:"checkbox",checked:i.included,onChange:y=>J(i.id,y.target.checked)}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",children:e.jsx("path",{fill:"currentColor",d:"M8.143 13.314 4.829 10l-1.18 1.18 4.494 4.494 8-8-1.18-1.18z"})})})]}),e.jsx("input",{type:"number",className:"editor-input entry-amount",value:String(i.amount),onChange:y=>te(i.id,y.target.value)}),e.jsx("input",{className:"editor-input entry-note",value:i.note||"",onChange:y=>B(i.id,y.target.value)}),e.jsxs("button",{className:"btn btn-danger btn-sm flex items-center gap-1",onClick:()=>se(i.id),children:[e.jsx(un,{className:"w-4 h-4"}),"Удалить"]})]},i.id)),!b&&t.length===0&&e.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"Ещё нет записей."})]})]})})}function Cn({value:p,onChange:v,fullWidth:u}){const[m,g]=l.useState(!1),N=l.useRef(null);l.useEffect(()=>{const c=b=>{N.current&&(N.current.contains(b.target)||g(!1))};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[]);const f=p==="income"?"Доходы":"Расходы";return e.jsxs("div",{ref:N,className:`dd-wrap ${u?"block":""}`,children:[e.jsxs("button",{type:"button",className:`btn btn-outline dd-btn ${u?"full":""}`,style:{justifyContent:"flex-start"},onClick:()=>g(c=>!c),children:[e.jsx("span",{style:{pointerEvents:"none"},children:f}),e.jsx("span",{style:{marginLeft:"auto",opacity:.7},children:"▾"})]}),m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dd-backdrop",onClick:()=>g(!1)}),e.jsxs("div",{className:`dd-menu ${u?"full":""}`,children:[e.jsx("div",{className:`dd-item ${p==="income"?"dd-active":""}`,onClick:()=>{v("income"),g(!1)},children:"Доходы"}),e.jsx("div",{className:`dd-item ${p==="expense"?"dd-active":""}`,onClick:()=>{v("expense"),g(!1)},children:"Расходы"})]})]})]})}const Ae=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function bn({open:p,onClose:v,year:u,incomeByMonth:m,expenseByMonth:g}){const N=m.reduce((h,t)=>h+t,0),f=g.reduce((h,t)=>h+t,0),c=N-f,b=Math.max(...m,...g,1);return e.jsxs(oe,{open:p,onClose:v,title:`Годовая статистика — ${u}`,size:"lg",footer:e.jsx(rn,{right:e.jsx(cn,{variant:"secondary",onClick:v,children:"Закрыть"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-lg font-semibold",children:N})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-lg font-semibold",children:f})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-lg font-semibold",children:c})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Доходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:m.map((h,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Ae[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${h/b*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:h})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Расходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:g.map((h,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Ae[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-red-500",style:{width:`${h/b*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:h})]},t))})]})]})]})}function wn({value:p,years:v,onChange:u}){const[m,g]=l.useState(!1),N=l.useRef(null);return l.useEffect(()=>{function f(c){m&&c.key==="Escape"&&g(!1)}return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[m]),e.jsxs("div",{className:"dd-wrap",children:[e.jsx("button",{ref:N,className:"btn btn-outline dd-btn",onClick:()=>g(f=>!f),children:p}),m&&e.jsx("div",{className:"dd-backdrop",onClick:()=>g(!1)}),m&&e.jsx("div",{className:"dd-menu",children:v.map(f=>e.jsx("div",{className:"dd-item "+(f===p?"dd-active":""),onClick:()=>{u(f),g(!1)},children:f},f))})]})}function En({year:p,years:v,onYearChange:u,onAddCategory:m,onShowStats:g}){return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(wn,{value:p,years:v,onChange:u})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{className:"btn flex items-center gap-2",onClick:m,children:[e.jsx(ve,{className:"w-4 h-4"}),"Добавить категорию"]}),e.jsxs("button",{className:"btn btn-outline text-gray-900 flex items-center gap-2",onClick:g,children:[e.jsx(mn,{className:"w-4 h-4"}),"Годовая статистика"]})]})]})}function Re({title:p,onAdd:v}){return e.jsxs("div",{className:"finance-section",children:[e.jsx("span",{children:p}),e.jsxs("button",{className:"btn btn-outline btn-xs text-gray-900 flex items-center gap-1",onClick:v,children:[e.jsx(ve,{className:"w-3 h-3"}),"Категория"]})]})}function Oe({type:p,row:v,values:u,isCurrentYear:m,currentMonth:g,hasChildren:N,collapsed:f,onToggleCollapse:c,onNameContext:b,onCellContext:h,onCellEdit:t,fmt:w,ctxCatHighlight:j,ctxCellHighlight:F}){const _={id:v.id,name:v.name,type:p};return e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell "+(j===v.id?"ctx-active":""),children:e.jsxs("div",{className:"cell-head cell-name flex items-center gap-2",children:[e.jsx("button",{className:"shrink-0 rounded-md hover:bg-gray-100 w-6 h-6 flex items-center justify-center",onClick:()=>c(v.id),title:N?f?"Развернуть":"Свернуть":"Категория",children:N?f?e.jsx(fn,{className:"w-4 h-4"}):e.jsx(xn,{className:"w-4 h-4"}):""}),e.jsx("span",{className:"flex-1 truncate",children:v.name}),e.jsx("button",{className:"icon-btn menu-btn",onClick:A=>b(A,_),onContextMenu:A=>b(A,_),"aria-label":"Действия с категорией",children:e.jsx(pn,{size:16})})]})}),u.map((A,P)=>e.jsx("div",{className:"finance-cell "+(m&&P===g?"col-current ":"")+(F&&F.type===p&&F.catId===v.id&&F.month===P?"ctx-active":""),onContextMenu:z=>h(z,p,v.id,P,A),children:e.jsx("button",{className:"cell-btn",onClick:()=>t(p,v.id,P),children:w(A)})},P))]})}function Sn({pos:p,onClose:v,onRename:u,onAddSub:m,onDelete:g,canAddSub:N=!0}){const f=l.useRef([]),[c,b]=l.useState(0);return l.useEffect(()=>{const h=t=>{t.key==="Escape"&&(t.preventDefault(),v()),t.key==="ArrowDown"&&(t.preventDefault(),b(w=>Math.min(w+1,f.current.length-1))),t.key==="ArrowUp"&&(t.preventDefault(),b(w=>Math.max(w-1,0))),(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),f.current[c]?.click())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[c,v]),l.useEffect(()=>{f.current[0]?.focus()},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:v,onContextMenu:h=>h.preventDefault(),"aria-hidden":!0}),e.jsxs("div",{className:"ctx-menu",style:{left:p.x,top:p.y},role:"menu","aria-label":"Действия с категорией",onContextMenu:h=>h.preventDefault(),children:[e.jsx("div",{ref:h=>f.current[0]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:u,"aria-label":"Переименовать категорию","data-active":c===0,children:"Переименовать"}),N&&e.jsx("div",{ref:h=>f.current[1]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:m,"aria-label":"Добавить подкатегорию","data-active":c===1,children:"+ Подкатегория"}),e.jsx("div",{ref:h=>f.current[2]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:g,"aria-label":"Удалить категорию","data-active":c===2,style:{color:"#b91c1c"},children:"Удалить"})]})]})}function _n({pos:p,onClose:v,canCopy:u,hasClipboard:m,onCopy:g,onPaste:N}){const f=l.useMemo(()=>{const t=[];return u&&t.push({label:"Копировать записи",onClick:g,aria:"Копировать записи"}),m&&t.push({label:"Вставить записи (заменить)",onClick:N,aria:"Вставить записи (заменить)"}),t},[u,m,g,N]),c=l.useRef([]),[b,h]=l.useState(0);return l.useEffect(()=>{const t=w=>{w.key==="Escape"&&(w.preventDefault(),v()),w.key==="ArrowDown"&&(w.preventDefault(),h(j=>Math.min(j+1,f.length-1))),w.key==="ArrowUp"&&(w.preventDefault(),h(j=>Math.max(j-1,0))),(w.key==="Enter"||w.key===" ")&&(w.preventDefault(),c.current[b]?.click())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[b,v,f.length]),l.useEffect(()=>{c.current[0]?.focus()},[f.length]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:v,onContextMenu:t=>t.preventDefault(),"aria-hidden":!0}),e.jsx("div",{className:"ctx-menu",style:{left:p.x,top:p.y},role:"menu","aria-label":"Действия с ячейкой",onContextMenu:t=>t.preventDefault(),children:f.map((t,w)=>e.jsx("div",{ref:j=>c.current[w]=j,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:t.onClick,"aria-label":t.aria,"data-active":b===w,children:t.label},w))})]})}function Te(p,v,u,m){const N=window.innerWidth,f=window.innerHeight;let c=p,b=v;return c+u+8>N&&(c=Math.max(8,N-u-8)),b+m+8>f&&(b=Math.max(8,f-m-8)),c<8&&(c=8),b<8&&(b=8),{x:c,y:b}}function Fe(p){const u={},m={};for(const c of p)u[c.id]=c,c.parent_id&&(m[c.parent_id]||=[]).push(c.id);const g={};function N(c){if(!m[c])return Array(12).fill(0);if(g[c])return g[c].slice();const b=Array(12).fill(0);for(const h of m[c]){const t=u[h];if(t)for(let j=0;j<12;j++)b[j]+=t.values?.[j]??0;const w=N(h);for(let j=0;j<12;j++)b[j]+=w[j]||0}return g[c]=b.slice(),b}const f={};for(const c of Object.keys(m))f[c]=N(c);return f}const Pe=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function kn(){const p=l.useCallback((m,g,N)=>{try{localStorage.setItem(he.FINANCE(m,g),JSON.stringify(N))}catch(f){console.warn("Failed to write finance cache:",f)}},[]),v=l.useCallback((m,g)=>{try{const N=localStorage.getItem(he.FINANCE(m,g));return N?JSON.parse(N):null}catch(N){return console.warn("Failed to read finance cache:",N),null}},[]),u=l.useCallback((m,g)=>{try{localStorage.removeItem(he.FINANCE(m,g))}catch(N){console.warn("Failed to clear finance cache:",N)}},[]);return{writeCache:p,readCache:v,clearCache:u}}function Le(p,v){return v.find(u=>u.id===p)}const ne=p=>hn(p);function Yn(){const{handleError:p,handleSuccess:v}=vn(),{userId:u}=Nn(),{writeCache:m,readCache:g}=kn(),{createSimpleFooter:N,createDangerFooter:f}=on(),c=new Date,b=c.getFullYear(),h=c.getMonth(),[t,w]=l.useState(b),[j,F]=l.useState([]),[_,A]=l.useState([]),[P,z]=l.useState({}),Ne=l.useMemo(()=>_e(j,P),[j,P]),de=l.useMemo(()=>_e(_,P),[_,P]),[G,H]=l.useState(!0),[ue,L]=l.useState(!1),[te,B]=l.useState(W.INCOME),[J,se]=l.useState(""),[U,$]=l.useState(null),[ae,i]=l.useState(!1),[y,C]=l.useState(null),[E,I]=l.useState(0),[le,O]=l.useState(!1),[Q,Ye]=l.useState({x:0,y:0}),[R,ge]=l.useState(null),[me,Y]=l.useState(!1),[qe,He]=l.useState({x:0,y:0}),[fe,Ue]=l.useState(null),[K,$e]=l.useState(null),[Be,je]=l.useState(!1),[Xe,We]=l.useState(null),[ze,ye]=l.useState(!1),[Ke,Z]=l.useState(!1),[xe,Ce]=l.useState(""),[Ve,ie]=l.useState(!1),[be,X]=l.useState(null),[we,q]=l.useState(null);l.useEffect(()=>{if(!u)return;const n=g(u,t);n?(F(n.income??[]),A(n.expense??[]),H(!1)):H(!0),(async()=>{const[s,o]=await Promise.all([T.from("finance_categories").select("id,name,type,parent_id").order("created_at",{ascending:!0}),T.from("finance_entries").select("category_id,month,amount,included").eq("year",t)]);if(s.error||o.error){p(s.error||o.error,"Загрузка финансовых данных"),H(!1);return}const a=s.data||[],d=o.data||[],r={};for(const x of a)r[x.id]=Array(ee).fill(0);for(const x of d){if(!x.included)continue;const D=Math.min(11,Math.max(0,x.month-1)),M=x.category_id;r[M]||(r[M]=Array(ee).fill(0)),r[M][D]+=Number(x.amount)||0}const S=a.filter(x=>x.type===W.INCOME).map(x=>({id:x.id,name:x.name,parent_id:x.parent_id,values:r[x.id]||Array(ee).fill(0)})),k=a.filter(x=>x.type===W.EXPENSE).map(x=>({id:x.id,name:x.name,parent_id:x.parent_id,values:r[x.id]||Array(ee).fill(0)}));F(S),A(k),H(!1),m(u,t,{income:S.map(({id:x,name:D,values:M,parent_id:pe})=>({id:x,name:D,values:M,parent_id:pe})),expense:k.map(({id:x,name:D,values:M,parent_id:pe})=>({id:x,name:D,values:M,parent_id:pe}))})})()},[u,t]);const re=l.useMemo(()=>Pe.map((n,s)=>j.reduce((o,a)=>o+(a.values?.[s]??0),0)),[j]),ce=l.useMemo(()=>Pe.map((n,s)=>_.reduce((o,a)=>o+(a.values?.[s]??0),0)),[_]),Ge=l.useMemo(()=>re.map((n,s)=>n-ce[s]),[re,ce]);l.useMemo(()=>{const n={};return j.forEach(s=>{s.parent_id&&(n[s.parent_id]=(n[s.parent_id]||0)+1)}),n},[j]),l.useMemo(()=>{const n={};return _.forEach(s=>{s.parent_id&&(n[s.parent_id]=(n[s.parent_id]||0)+1)}),n},[_]);const Ee=l.useMemo(()=>Fe(j),[j]),Se=l.useMemo(()=>Fe(_),[_]);function _e(n,s){const o=n.filter(r=>!r.parent_id),a={};n.forEach(r=>{r.parent_id&&(a[r.parent_id]||=[]).push(r)});const d=[];return o.forEach(r=>{d.push(r),s[r.id]||(a[r.id]||[]).forEach(S=>d.push(S))}),n.filter(r=>r.parent_id&&!o.find(S=>S.id===r.parent_id)).forEach(r=>d.push(r)),d}async function Je(){const n=J.trim();if(!n||!u)return;const s=te,o={user_id:u,type:s,name:n};U&&(o.parent_id=U.id);const{data:a,error:d}=await T.from("finance_categories").insert(o).select("id,name,type,parent_id").single();if(d){p(d,"Создание категории");return}const r={id:a.id,name:a.name,type:a.type,parent_id:a.parent_id,values:Array(ee).fill(0)};if(s===W.INCOME){const S=[j,r];F(S),m(u,t,{income:S.map(({id:k,name:x,values:D,parent_id:M})=>({id:k,name:x,values:D,parent_id:M})),expense:_.map(({id:k,name:x,values:D,parent_id:M})=>({id:k,name:x,values:D,parent_id:M}))})}else{const S=[_,r];A(S),m(u,t,{income:j.map(({id:k,name:x,values:D,parent_id:M})=>({id:k,name:x,values:D,parent_id:M})),expense:S.map(({id:k,name:x,values:D,parent_id:M})=>({id:k,name:x,values:D,parent_id:M}))})}v(`Категория "${n}" создана`),L(!1),se(""),B(W.INCOME),$(null)}function ke(n,s){n.preventDefault(),n.stopPropagation(),me&&Y(!1),q(null),X(s.id);const o=Te(n.clientX,n.clientY,De,gn);Ye({x:o.x,y:o.y}),ge(s),O(!0)}function Qe(){O(!1),ge(null),X(null)}async function Ze(){const n=xe.trim();if(!n||!R){Z(!1);return}const{error:s}=await T.from("finance_categories").update({name:n}).eq("id",R.id);if(s){p(s,"Создание категории");return}if(R.type==="income"){const o=j.map(a=>a.id===R.id?{...a,name:n}:a);F(o),m(u,t,{income:o.map(({id:a,name:d,values:r,parent_id:S})=>({id:a,name:d,values:r,parent_id:S})),expense:_.map(({id:a,name:d,values:r,parent_id:S})=>({id:a,name:d,values:r,parent_id:S}))})}else{const o=_.map(a=>a.id===R.id?{...a,name:n}:a);A(o),m(u,t,{income:j.map(({id:a,name:d,values:r,parent_id:S})=>({id:a,name:d,values:r,parent_id:S})),expense:o.map(({id:a,name:d,values:r,parent_id:S})=>({id:a,name:d,values:r,parent_id:S}))})}Z(!1)}async function en(){if(!R)return;const{error:n}=await T.from("finance_categories").delete().eq("id",R.id);if(n){p(n,"Создание категории");return}if(R.type==="income"){const s=j.filter(o=>o.id!==R.id);F(s),m(u,t,{income:s.map(({id:o,name:a,values:d,parent_id:r})=>({id:o,name:a,values:d,parent_id:r})),expense:_.map(({id:o,name:a,values:d,parent_id:r})=>({id:o,name:a,values:d,parent_id:r}))})}else{const s=_.filter(o=>o.id!==R.id);A(s),m(u,t,{income:j.map(({id:o,name:a,values:d,parent_id:r})=>({id:o,name:a,values:d,parent_id:r})),expense:s.map(({id:o,name:a,values:d,parent_id:r})=>({id:o,name:a,values:d,parent_id:r}))})}ie(!1)}async function Me(n,s,o,a,d){n.preventDefault(),n.stopPropagation(),le&&O(!1),me&&Y(!1),X(null),q({type:s,catId:o,month:a});const r={category_id:o,year:t,month:a+1},S=!!K&&K.length>0;if(!S&&(!d||d===0)){q(null);return}const k=Te(n.clientX,n.clientY,De,jn);Ue({catId:o,type:s,month:a}),He({x:k.x,y:k.y}),je(!1),Y(!0);const{data:x}=await T.from("finance_entries").select("amount, note, included, position").match(r).order("position",{ascending:!0}).order("created_at",{ascending:!0}),D=(x||[]).map(M=>({amount:Number(M.amount)||0,note:M.note,included:!!M.included,position:M.position??0}));if(We(D),!D.length&&!S){Y(!1),q(null);return}je(D.length>0)}async function nn(){const n=Xe||[];if(!n.length){Y(!1),q(null);return}$e(n.slice());try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{}Y(!1),q(null)}async function tn(){if(!fe||!K||!K.length||!u)return;const{catId:n,type:s,month:o}=fe,a={category_id:n,year:t,month:o+1};await T.from("finance_entries").delete().match(a);const d=K.map((k,x)=>({where:a,user_id:u,amount:k.amount,note:k.note,included:k.included,position:x}));await T.from("finance_entries").insert(d);const r=d.filter(k=>k.included).reduce((k,x)=>k+(x.amount||0),0),S=k=>k.map(x=>x.id===n?{...x,values:x.values.map((D,M)=>M===o?r:D)}:x);s==="income"?F(S(j)):A(S(_)),Y(!1),q(null)}if(l.useEffect(()=>{const n=o=>{o.key==="Escape"&&(O(!1),Y(!1),X(null),q(null))},s=()=>{O(!1),Y(!1),X(null),q(null)};return window.addEventListener("keydown",n),window.addEventListener("wheel",s,{passive:!0}),()=>{window.removeEventListener("keydown",n),window.removeEventListener("wheel",s)}},[]),G)return e.jsx("div",{className:"p-4",children:e.jsx(an,{rows:10,columns:13})});const V=t===b,sn=Array.from({length:7}).map((n,s)=>b-3+s);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6 finance-page",onContextMenu:n=>{n.preventDefault()},children:[e.jsx(En,{year:t,years:sn,onYearChange:w,onAddCategory:()=>{B(W.INCOME),$(null),L(!0)},onShowStats:()=>ye(!0)}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Категория"})}),Ie.map((n,s)=>e.jsx("div",{className:"finance-cell "+(V&&s===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsx(Re,{title:"Доходы",onAdd:()=>{B(W.INCOME),$(null),L(!0)}}),Ne.map(n=>{const s=!!Ee[n.id],o=s?Ee[n.id]:n.values;return e.jsx(Oe,{type:"income",row:n,values:o,isCurrentYear:V,currentMonth:h,hasChildren:s,collapsed:!!P[n.id],onToggleCollapse:a=>z(d=>({...d,[a]:!d[a]})),onNameContext:(a,d)=>ke(a,d),onCellContext:Me,onCellEdit:(a,d,r)=>{C({id:d,name:n.name,type:a}),I(r),i(!0)},fmt:ne,ctxCatHighlight:be,ctxCellHighlight:we})}),e.jsx(Re,{title:"Расходы",onAdd:()=>{B(W.EXPENSE),$(null),L(!0)}}),de.map(n=>{const s=!!Se[n.id],o=s?Se[n.id]:n.values;return e.jsx(Oe,{type:"expense",row:n,values:o,isCurrentYear:V,currentMonth:h,hasChildren:s,collapsed:!!P[n.id],onToggleCollapse:a=>z(d=>({...d,[a]:!d[a]})),onNameContext:(a,d)=>ke(a,d),onCellContext:Me,onCellEdit:(a,d,r)=>{C({id:d,name:n.name,type:a}),I(r),i(!0)},fmt:ne,ctxCatHighlight:be,ctxCellHighlight:we})})]}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Показатель"})}),Ie.map((n,s)=>e.jsx("div",{className:"finance-cell "+(V&&s===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Доходы"})}),re.map((n,s)=>e.jsx("div",{className:"finance-cell "+(V&&s===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:ne(n)})},s))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Расходы"})}),ce.map((n,s)=>e.jsx("div",{className:"finance-cell "+(V&&s===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:ne(n)})},s))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:700},children:"Баланс"})}),Ge.map((n,s)=>e.jsx("div",{className:"finance-cell "+(V&&s===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",style:{fontWeight:700},children:ne(n)})},s))]})]})]}),le&&R&&e.jsx(Sn,{pos:Q,canAddSub:!(Le(R.id,j)||Le(R.id,_))?.parent_id,onClose:Qe,onRename:()=>{Ce(R.name),Z(!0),O(!1),X(null)},onAddSub:()=>{B(R.type),$({id:R.id,name:R.name}),L(!0),O(!1),X(null)},onDelete:()=>{ie(!0),O(!1),X(null)}}),me&&fe&&e.jsx(_n,{pos:qe,onClose:()=>{Y(!1),q(null)},canCopy:Be,hasClipboard:!!(K&&K.length>0),onCopy:nn,onPaste:tn}),e.jsxs(oe,{open:ue,onClose:()=>{L(!1),$(null)},title:U?"Новая подкатегория":"Новая категория",subtitle:U?`Родитель: ${U.name}`:void 0,footer:N({label:U?"Добавить подкатегорию":"Добавить категорию",onClick:Je,disabled:!J.trim()},{label:"Отмена",onClick:()=>{L(!1),$(null)}}),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Тип"}),e.jsx("div",{className:"flex-1",children:e.jsx(Cn,{value:te,onChange:B,fullWidth:!0})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Название"}),e.jsx("input",{value:J,onChange:n=>se(n.target.value),placeholder:U?"Напр. Коммунальные":"Напр. Жильё",className:"border rounded-lg px-3 py-2 text-sm flex-1"})]})]}),e.jsx(oe,{open:Ke,onClose:()=>Z(!1),title:"Переименовать категорию",footer:N({label:"Сохранить",onClick:Ze,disabled:!xe.trim()},{label:"Отмена",onClick:()=>Z(!1)}),children:e.jsx("input",{value:xe,onChange:n=>Ce(n.target.value),className:"border rounded-lg px-3 py-2 text-sm w-full",autoFocus:!0})}),e.jsx(oe,{open:Ve,onClose:()=>ie(!1),title:"Удалить категорию?",footer:f({label:"Удалить",onClick:en},{label:"Отмена",onClick:()=>ie(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Все записи в этой категории будут удалены без возможности восстановления."})}),ae&&y&&e.jsx(yn,{open:ae,onClose:()=>i(!1),userId:u,categoryId:y.id,categoryName:y.name,monthIndex:E,year:t,onApply:n=>{const s=o=>o.map(a=>a.id===y.id?{...a,values:a.values.map((d,r)=>r===E?n:d)}:a);y.type==="income"?F(s(j)):A(s(_))}}),e.jsx(bn,{open:ze,onClose:()=>ye(!1),year:t,incomeByMonth:re,expenseByMonth:ce})]})}export{Yn as default};
