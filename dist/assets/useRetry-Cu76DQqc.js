var R=Object.defineProperty;var p=(t,s,e)=>s in t?R(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var y=(t,s,e)=>p(t,typeof s!="symbol"?s+"":s,e);import{r as d,j as r,A as f}from"./index-De27cj0q.js";import{u as E}from"./errorHandler-B8Obt8fF.js";class N extends d.Component{constructor(e){super(e);y(this,"retryTimeoutId",null);y(this,"handleRetry",()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0,retryCount:this.state.retryCount+1})});y(this,"handleReset",()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0,retryCount:0})});this.state={hasError:!1,retryCount:0}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,i){const{pageName:n,onError:l,maxRetries:c=3}=this.props,{retryCount:u}=this.state;console.error(`Error in ${n}:`,e,i),l==null||l(e,i),u<c&&(this.retryTimeoutId=setTimeout(()=>{this.setState(o=>({hasError:!1,error:void 0,errorInfo:void 0,retryCount:o.retryCount+1}))},Math.pow(2,u)*1e3))}componentWillUnmount(){this.retryTimeoutId&&clearTimeout(this.retryTimeoutId)}render(){if(this.state.hasError){const{pageName:e,fallback:i}=this.props,{error:n,retryCount:l}=this.state;return i||r.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:r.jsxs("div",{className:"max-w-md w-full bg-white rounded-xl shadow-lg p-6",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[r.jsx("div",{className:"text-red-500 text-2xl",children:"⚠️"}),r.jsxs("div",{children:[r.jsxs("h2",{className:"text-lg font-semibold text-red-600",children:["Ошибка в ",e]}),r.jsx("p",{className:"text-sm text-gray-600",children:"Произошла неожиданная ошибка. Попробуйте обновить страницу."})]})]}),!1,r.jsxs("div",{className:"flex gap-2",children:[r.jsx(f,{variant:"primary",size:"sm",onClick:this.handleRetry,ariaLabel:`Попробовать снова (попытка ${l+1})`,children:"Попробовать снова"}),r.jsx(f,{variant:"secondary",size:"sm",onClick:this.handleReset,ariaLabel:"Сбросить и начать заново",children:"Сбросить"}),r.jsx(f,{variant:"ghost",size:"sm",onClick:()=>window.location.reload(),ariaLabel:"Обновить страницу",children:"Обновить страницу"})]}),l>0&&r.jsxs("p",{className:"text-xs text-gray-500 mt-3",children:["Попытка ",l," из 3"]})]})})}return this.props.children}}const C={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2,retryCondition:t=>(t==null?void 0:t.code)==="NETWORK_ERROR"||(t==null?void 0:t.code)==="TIMEOUT"||(t==null?void 0:t.status)>=500&&(t==null?void 0:t.status)<600||(t==null?void 0:t.status)===429,onRetry:(t,s)=>{console.warn(`Retry attempt ${t} after error:`,s)}};function g(t,s){const e=s.baseDelay*Math.pow(s.backoffMultiplier,t-1),i=Math.random()*.1*e,n=Math.min(e+i,s.maxDelay);return Math.floor(n)}function b(t){return new Promise(s=>setTimeout(s,t))}async function j(t,s={}){const e={...C,...s};let i=null;for(let n=1;n<=e.maxRetries+1;n++)try{return{data:await t(),error:null,attempts:n,success:!0}}catch(l){if(i=l instanceof Error?l:new Error(String(l)),n===e.maxRetries+1||!e.retryCondition(i))break;e.onRetry(n,i);const c=g(n,e);await b(c)}return{data:null,error:i,attempts:e.maxRetries+1,success:!1}}function v(){const{handleError:t}=E(),[s,e]=d.useState(!1),[i,n]=d.useState(0);return{executeWithRetry:d.useCallback(async(c,u={})=>{e(!0),n(0);const o=await j(c,{...u,onRetry:(h,m)=>{var a;n(h),(a=u.onRetry)==null||a.call(u,h,m)}});return e(!1),o.success?o.data:(t(o.error,"Операция завершилась с ошибкой"),null)},[t]),isRetrying:s,retryCount:i}}function k(){const{executeWithRetry:t,isRetrying:s,retryCount:e}=v(),[i,n]=d.useState(!1),[l,c]=d.useState(null);return{executeApiCall:d.useCallback(async(o,h={})=>{n(!0),c(null);const m=await t(o,{maxRetries:3,baseDelay:1e3,retryCondition:a=>(a==null?void 0:a.code)==="NETWORK_ERROR"||(a==null?void 0:a.code)==="TIMEOUT"||(a==null?void 0:a.status)>=500&&(a==null?void 0:a.status)<600||(a==null?void 0:a.status)===429,onRetry:(a,x)=>{console.log(`Retry attempt ${a} for API call:`,x)},...h});return n(!1),m===null&&c(new Error("API call failed after retries")),m},[t]),isLoading:i||s,retryCount:e,error:l,clearError:()=>c(null)}}export{N as P,k as u};
