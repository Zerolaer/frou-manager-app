import{j as e,s as d}from"./index-DEjx_rPC.js";import{r as i}from"./vendor-CqGws4Uo.js";import{U as J,u as K}from"./ModalSystem-C_RBbtD1.js";import{T as X,P as Y,E as Z}from"./icons-BC5Gm12n.js";function U({checked:o,onToggle:a}){return e.jsxs("label",{className:"chk",style:{lineHeight:0},children:[e.jsx("input",{type:"checkbox",checked:o,onChange:a}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8.5 11.586l6.793-6.793a1 1 0 011.414 0z",clipRule:"evenodd"})})})]})}function ee({open:o,onClose:a,task:s,onUpdated:n}){const[c,u]=i.useState(""),[p,N]=i.useState(""),[h,w]=i.useState(""),[b,C]=i.useState(""),[f,S]=i.useState(""),[x,g]=i.useState([]),[y,_]=i.useState("open"),[$,k]=i.useState(!1),[L,T]=i.useState(!1),[P,R]=i.useState([]),[j,M]=i.useState(""),[O,D]=i.useState(!1),v=i.useRef(null),{createDangerFooter:q}=K();i.useEffect(()=>{const t=r=>{v.current&&(v.current.contains(r.target)||k(!1))};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),i.useEffect(()=>{o&&(console.log("TaskViewModal: Loading task data",s),u(s?.title||""),N(s?.description||""),w(s?.priority||""),C(s?.tag||""),S(s?.date||""),g(Array.isArray(s?.todos)?s.todos:[]),_(s?.status||"open"),M(s?.project_id||""))},[o,s]),i.useEffect(()=>{o&&(async()=>{const{data:t}=await d.from("tasks_projects").select("id,name").order("created_at",{ascending:!0});R(t||[])})()},[o]);function V(){const t=Math.random().toString(36).slice(2);g(r=>[...r,{id:t,text:"Новая подзадача",done:!1}])}function z(t){g(r=>r.map(l=>l.id===t?{...l,done:!l.done}:l))}function A(t){g(r=>r.filter(l=>l.id!==t))}async function I(t){if(!s)return;_(t);const{data:r,error:l}=await d.from("tasks_items").update({status:t}).eq("id",s.id).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();!l&&r&&n(r)}async function F(t){if(!s)return;M(t||"");const{data:r,error:l}=await d.from("tasks_items").update({project_id:t}).eq("id",s.id).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();!l&&r&&n(r)}async function H(){if(!s)return;const t={project_id:j||null,title:c,description:p,date:f||null,position:(s.position??0)+1,priority:h||null,tag:b||null,todos:x,status:y},{data:r,error:l}=await d.from("tasks_items").insert(t).select("id").single();if(!l&&r?.id){const{data:m}=await d.from("tasks_items").select("id,project_id,title,description,date,position,priority,tag,todos,status").eq("id",r.id).single();m&&n(m)}}async function E(){if(s){D(!0);try{await d.from("tasks_items").delete().eq("id",s.id),a()}finally{D(!1)}}}const B=i.useCallback(async()=>{if(!s)return!1;T(!0);const t={title:c,description:p,priority:h||null,tag:b||null,date:f||null,todos:x,status:y,project_id:j||null},{data:r,error:l}=await d.from("tasks_items").update(t).eq("id",s.id).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();return T(!1),!l&&r?(n(r),!0):!1},[s,c,p,h,b,f,x,y,j,n]),Q=async()=>{await B()&&a()},W=x.filter(t=>t.done).length,G=x.length;return e.jsx(J,{open:o,onClose:a,title:"Задача",size:"xl",headerRight:e.jsxs("div",{className:"relative",ref:v,children:[e.jsx("button",{className:"h-8 w-8 grid place-items-center rounded-lg border border-gray-300 bg-white hover:bg-gray-50",onClick:()=>k(t=>!t),"aria-label":"Меню",children:e.jsx(Z,{className:"w-4 h-4"})}),$&&e.jsxs("div",{className:"absolute right-0 mt-2 min-w-48 rounded-xl border border-gray-200 bg-white p-1 shadow-xl",children:[e.jsx("div",{className:"dd-item",onClick:H,children:"Дублировать"}),e.jsx("div",{className:"dd-item text-red-600",onClick:E,children:"Удалить"})]})]}),footer:q({label:"Удалить",onClick:E,loading:O},{label:"Сохранить",onClick:Q,loading:L},{label:"Закрыть",onClick:a}),children:e.jsxs("div",{className:"grid grid-cols-[1fr_280px] gap-6 max-md:grid-cols-1",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Название"}),e.jsx("input",{value:c,onChange:t=>u(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-base font-semibold",placeholder:"Название задачи"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Описание"}),e.jsx("textarea",{value:p,onChange:t=>N(t.target.value),className:"w-full min-h-[140px] rounded-lg border border-gray-300 p-3",placeholder:"Добавьте детали задачи…"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Подзадачи"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[W," / ",G]})]}),e.jsx("ul",{className:"mt-2 space-y-2",children:x.map(t=>e.jsxs("li",{className:"flex items-center gap-2 rounded-xl border border-gray-200 p-2",children:[e.jsx(U,{checked:t.done,onToggle:()=>z(t.id)}),e.jsx("input",{value:t.text,onChange:r=>g(l=>l.map(m=>m.id===t.id?{...m,text:r.target.value}:m)),className:"flex-1 bg-transparent outline-none"}),e.jsxs("button",{className:"h-8 rounded-lg border border-gray-200 px-2 text-sm hover:bg-gray-50 flex items-center gap-1",onClick:()=>A(t.id),children:[e.jsx(X,{className:"w-4 h-4"}),"Удалить"]})]},t.id))}),e.jsxs("button",{className:"h-9 px-4 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 mt-3 flex items-center gap-2",onClick:V,children:[e.jsx(Y,{className:"w-4 h-4"}),"Подзадача"]})]})]}),e.jsxs("aside",{className:"space-y-4",children:[e.jsxs("section",{className:"space-y-2 rounded-xl border border-gray-200 p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Статус"}),e.jsx(te,{value:y,onChange:I,fullWidth:!0})]}),e.jsxs("section",{className:"space-y-2 rounded-xl border border-gray-200 p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Приоритет"}),e.jsx(se,{value:h,onChange:w})]}),e.jsxs("section",{className:"space-y-2 rounded-xl border border-gray-200 p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Тег"}),e.jsx("input",{value:b||"",onChange:t=>C(t.target.value),placeholder:"Введите тег",className:"h-9 w-full rounded-xl border border-gray-200 px-3"})]}),e.jsxs("section",{className:"space-y-2 rounded-xl border border-gray-200 p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Дата"}),e.jsx(re,{value:f||"",onChange:S})]}),e.jsxs("section",{className:"space-y-2 rounded-xl border border-gray-200 p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Проект"}),e.jsxs("select",{value:j,onChange:t=>F(t.target.value||null),className:"h-9 w-full rounded-xl border border-gray-200 px-3 bg-white",children:[e.jsx("option",{value:"",children:"Без проекта"}),P.map(t=>e.jsx("option",{value:t.id,children:t.name||"Без названия"},t.id))]})]})]})]})})}function te({value:o,onChange:a,fullWidth:s}){return e.jsxs("div",{className:(s?"w-full ":"")+"flex rounded-full border border-gray-200 bg-gray-100 p-1 text-xs",children:[e.jsx("button",{className:"flex-1 rounded-full px-3 py-1 text-center "+(o==="open"?"bg-white shadow-sm":"opacity-70 hover:opacity-100"),onClick:()=>a("open"),children:"Открытая"}),e.jsx("button",{className:"flex-1 rounded-full px-3 py-1 text-center "+(o==="closed"?"bg-white shadow-sm":"opacity-70 hover:opacity-100"),onClick:()=>a("closed"),children:"Закрытая"})]})}function se({value:o,onChange:a}){const s="h-8 px-3 rounded-full border text-sm inline-flex items-center justify-center transition";return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:`${s} ${o==="low"?"border-blue-300 bg-blue-50 text-blue-700":"border-gray-200 text-gray-700 hover:bg-gray-50"}`,onClick:()=>a("low"),children:"Low"}),e.jsx("button",{type:"button",className:`${s} ${o==="medium"?"border-amber-300 bg-amber-50 text-amber-700":"border-gray-200 text-gray-700 hover:bg-gray-50"}`,onClick:()=>a("medium"),children:"Med"}),e.jsx("button",{type:"button",className:`${s} ${o==="high"?"border-rose-300 bg-rose-50 text-rose-700":"border-gray-200 text-gray-700 hover:bg-gray-50"}`,onClick:()=>a("high"),children:"High"}),e.jsx("button",{type:"button",className:`${s} ${o===""?"bg-white shadow-sm":"border-gray-200 text-gray-500 hover:bg-gray-50"}`,onClick:()=>a(""),title:"Без приоритета",children:"Нет"})]})}function re({value:o,onChange:a}){function s(u){return u.toISOString().slice(0,10)}const n=new Date,c=new Date(Date.now()+864e5);return e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:o||"",onChange:u=>a(u.target.value),className:"h-9 w-full rounded-xl border border-gray-200 px-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"h-8 rounded-lg border border-gray-200 px-2 text-sm hover:bg-gray-50",onClick:()=>a(s(n)),children:"Сегодня"}),e.jsx("button",{type:"button",className:"h-8 rounded-lg border border-gray-200 px-2 text-sm hover:bg-gray-50",onClick:()=>a(s(c)),children:"Завтра"})]})]})}const ne=Object.freeze(Object.defineProperty({__proto__:null,default:ee},Symbol.toStringTag,{value:"Module"}));export{U as C,ee as T,ne as a};
