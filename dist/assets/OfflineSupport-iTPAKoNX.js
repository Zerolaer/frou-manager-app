import{j as r,A as d,a as h}from"./index-C94S2Pq2.js";import{r as a}from"./vendor-CqGws4Uo.js";import"./supabase-BmeMSZYH.js";function f(){const[t,e]=a.useState(navigator.onLine),[s,n]=a.useState(!1);return a.useEffect(()=>{const i=()=>{e(!0),s&&(h("Соединение восстановлено","polite"),n(!1))},o=()=>{e(!1),n(!0),h("Соединение потеряно. Работа в автономном режиме","assertive")};return window.addEventListener("online",i),window.addEventListener("offline",o),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",o)}},[s]),{isOnline:t,wasOffline:s}}const S=()=>{const{isOnline:t}=f(),[e,s]=a.useState(!1);return a.useEffect(()=>{if(!t)s(!0);else{const n=setTimeout(()=>{s(!1)},3e3);return()=>clearTimeout(n)}},[t]),e?r.jsx("div",{className:"fixed top-0 left-0 right-0 z-50 bg-orange-500 text-white px-4 py-2 text-center text-sm",children:r.jsxs("div",{className:"flex items-center justify-center gap-2",children:[r.jsx("span",{children:"⚠️"}),r.jsx("span",{children:t?"Соединение восстановлено":"Нет подключения к интернету"})]})}):null};class g{queue=[];isProcessing=!1;add(e,s){const n={id:s||`operation_${Date.now()}_${Math.random()}`,operation:e,timestamp:Date.now(),retries:0};return this.queue.push(n),this.saveToStorage(),n.id}async process(){if(!(this.isProcessing||this.queue.length===0)){for(this.isProcessing=!0;this.queue.length>0;){const e=this.queue[0];try{await e.operation(),this.queue.shift(),this.saveToStorage()}catch(s){e.retries++,e.retries>=3?(this.queue.shift(),console.error("Operation failed after 3 retries:",e.id,s)):this.queue.push(this.queue.shift()),this.saveToStorage();break}}this.isProcessing=!1}}clear(){this.queue=[],this.saveToStorage()}getQueue(){return[...this.queue]}saveToStorage(){try{localStorage.setItem("offlineQueue",JSON.stringify(this.queue))}catch(e){console.error("Failed to save offline queue:",e)}}loadFromStorage(){try{const e=localStorage.getItem("offlineQueue");e&&(this.queue=JSON.parse(e))}catch(e){console.error("Failed to load offline queue:",e)}}}const l=new g;function p(){const{isOnline:t}=f(),[e,s]=a.useState(0);a.useEffect(()=>{l.loadFromStorage(),s(l.getQueue().length)},[]),a.useEffect(()=>{t&&e>0&&l.process().then(()=>{s(l.getQueue().length)})},[t,e]);const n=a.useCallback((c,u)=>{const m=l.add(c,u);return s(l.getQueue().length),m},[]),i=a.useCallback(async()=>{await l.process(),s(l.getQueue().length)},[]),o=a.useCallback(()=>{l.clear(),s(0)},[]);return{isOnline:t,queueLength:e,addOfflineOperation:n,processQueue:i,clearQueue:o}}const O=()=>{const{queueLength:t,processQueue:e,clearQueue:s}=p(),[n,i]=a.useState(!1);return t===0?null:r.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:r.jsxs("div",{className:"bg-blue-600 text-white rounded-lg shadow-lg p-4 max-w-sm",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("span",{className:"font-medium",children:[t," операций в очереди"]}),r.jsx("button",{onClick:()=>i(!n),className:"text-white hover:text-gray-200","aria-label":n?"Свернуть":"Развернуть",children:n?"−":"+"})]}),n&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("p",{className:"text-sm text-blue-100",children:"Операции будут выполнены при восстановлении соединения"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx(d,{variant:"secondary",size:"sm",onClick:e,className:"bg-blue-500 hover:bg-blue-400",children:"Попробовать сейчас"}),r.jsx(d,{variant:"ghost",size:"sm",onClick:s,className:"text-blue-100 hover:text-white",children:"Очистить"})]})]})]})})};function j(){"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(t=>{console.log("SW registered: ",t)}).catch(t=>{console.log("SW registration failed: ",t)})})}function b(t,e,s={}){const{cacheTimeout:n=5*60*1e3,offlineFallback:i}=s;return async()=>{try{const o=await t(),c={data:o,timestamp:Date.now()};try{localStorage.setItem(`cache_${e}`,JSON.stringify(c))}catch(u){console.warn("Failed to cache API result:",u)}return o}catch(o){try{const c=localStorage.getItem(`cache_${e}`);if(c){const u=JSON.parse(c);if(Date.now()-u.timestamp<n)return u.data}}catch(c){console.warn("Failed to read from cache:",c)}if(i!==void 0)return i;throw o}}}const N=()=>{const{isOnline:t,wasOffline:e}=f();return t?null:r.jsx("div",{className:"fixed top-4 left-1/2 transform -translate-x-1/2 z-50",children:r.jsxs("div",{className:"bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2",children:[r.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),r.jsx("span",{className:"text-sm font-medium",children:e?"Соединение восстановлено":"Нет подключения к интернету"})]})})};export{S as OfflineIndicator,O as OfflineQueueIndicator,b as createOfflineApiCall,N as default,j as registerServiceWorker,p as useOfflineOperations,f as useOnlineStatus};
