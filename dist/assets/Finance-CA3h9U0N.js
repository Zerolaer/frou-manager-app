import{j as e,s as T}from"./index-WV7WVIQ_.js";import{r as a,R as ln}from"./vendor-CqGws4Uo.js";import{M as cn,U as ue,a as rn,b as on,u as dn}from"./ModalSystem-DvzCN6Em.js";import{P as je,a as un,T as mn,b as fn,c as xn,d as pn,E as hn}from"./icons-BC5Gm12n.js";import{f as Nn}from"./format-CfBjB5Ts.js";import{u as vn}from"./errorHandler-DWq8XPpb.js";import{u as jn}from"./useSupabaseAuth-BF7MpXOQ.js";import{C as ve,F as W,M as se,a as Re,b as gn,c as Ae,d as yn}from"./constants-FoW-FSWv.js";import"./supabase-BmeMSZYH.js";function F({className:d=""}){return e.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${d}`})}function Cn({rows:d=6}){return e.jsx("div",{className:"space-y-2",children:Array.from({length:d}).map((N,u)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx(F,{className:"h-6 col-span-3"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"})]},u))})}function bn({open:d,onClose:N,userId:u,categoryId:f,categoryName:j,monthIndex:v,year:x,onApply:i}){const[b,h]=a.useState(!0),[t,w]=a.useState([]),[g,P]=a.useState(""),[_,A]=a.useState(""),O=a.useRef(null),z=a.useRef({}),le=(c,C,y=350)=>{clearTimeout(z.current[c]),z.current[c]=setTimeout(C,y)},me=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][v];a.useMemo(()=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"EUR"}),[]);const K=a.useRef(null);a.useEffect(()=>{d&&(async()=>{h(!0);const{data:c,error:C}=await T.from("finance_entries").select("id, amount, note, included, position, created_at").eq("category_id",f).eq("year",x).eq("month",v+1).order("position",{ascending:!0}).order("created_at",{ascending:!0});if(C){console.error(C),h(!1);return}const y=(c||[]).map(E=>({id:E.id,amount:Number(E.amount)||0,note:E.note,included:!!E.included,position:E.position??0}));w(y),h(!1)})()},[d,f,v,x]),a.useEffect(()=>{d&&O.current&&setTimeout(()=>{O.current?.focus()},100)},[d]);function Q(c){return c.reduce((C,y)=>C+(y.included?y.amount:0),0)}async function L(){const c=Number(String(g).replace(",","."));if(!u||isNaN(c))return;const C={user_id:u,category_id:f,year:x,month:v+1,amount:c,note:_,included:!0,position:t.length},{data:y,error:E}=await T.from("finance_entries").insert(C).select("id, amount, note, included, position").single();if(E){console.error(E);return}const S=[...t,{id:y.id,amount:Number(y.amount)||0,note:y.note,included:!!y.included,position:y.position??t.length}];w(S),P(""),A(""),i(Q(S)),setTimeout(()=>{O.current?.focus()},50)}function Z(c){c.key==="Enter"&&(c.preventDefault(),L())}function Y(c,C){w(y=>{const E=y.map(S=>S.id===c?{...S,...C}:S);return i(Q(E)),E})}function ee(c,C){const y=Number(String(C).replace(",","."));Y(c,{amount:isNaN(y)?0:y}),le("amt:"+c,async()=>{const{error:E}=await T.from("finance_entries").update({amount:isNaN(y)?0:y}).eq("id",c);E&&console.error(E)})}function ce(c,C){Y(c,{note:C}),le("note:"+c,async()=>{const{error:y}=await T.from("finance_entries").update({note:C}).eq("id",c);y&&console.error(y)})}async function $(c,C){Y(c,{included:C});const{error:y}=await T.from("finance_entries").update({included:C}).eq("id",c);y&&console.error(y)}async function U(c){const{error:C}=await T.from("finance_entries").delete().eq("id",c);if(C){console.error(C);return}const y=t.filter(E=>E.id!==c);y.forEach((E,S)=>{E.position=S}),w(y),i(Q(y)),await Promise.all(y.map((E,S)=>T.from("finance_entries").update({position:S}).eq("id",E.id)))}function re(c){K.current=c}function ne(c){c.preventDefault()}async function V(c){const C=K.current;if(K.current=null,!C||C===c)return;const y=t.findIndex(B=>B.id===C),E=t.findIndex(B=>B.id===c);if(y<0||E<0)return;const S=t.slice(),[fe]=S.splice(y,1);S.splice(E,0,fe),S.forEach((B,D)=>{B.position=D}),w(S),i(Q(S)),await Promise.all(S.map((B,D)=>T.from("finance_entries").update({position:D}).eq("id",B.id)))}return e.jsx(cn,{open:d,onClose:N,title:e.jsxs("span",{bodyClassName:"p-0",children:[e.jsx("b",{children:j})," · ",me," ",x]}),footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn btn-outline",onClick:N,children:"Закрыть"})}),size:"md",children:e.jsxs("div",{className:"editor-body",children:[b&&e.jsx("div",{className:"loading-overlay",children:"Загрузка…"}),e.jsxs("div",{className:"editor-add",children:[e.jsx("input",{ref:O,type:"number",placeholder:"Сумма (€)",value:g,onChange:c=>P(c.target.value),onKeyPress:Z,className:"editor-input number"}),e.jsx("input",{placeholder:"Описание (необязательно)",value:_,onChange:c=>A(c.target.value),onKeyPress:Z,className:"editor-input text"}),e.jsxs("button",{className:"btn btn-outline flex items-center gap-2",onClick:L,children:[e.jsx(je,{className:"w-4 h-4"}),"Добавить"]})]}),e.jsxs("div",{children:[t.map(c=>e.jsxs("div",{className:"entry-row "+(c.included?"":"entry-disabled"),draggable:!0,onDragStart:()=>re(c.id),onDragOver:ne,onDrop:()=>V(c.id),children:[e.jsx("div",{className:"entry-drag",children:e.jsx(un,{className:"w-4 h-4"})}),e.jsxs("label",{className:"chk",children:[e.jsx("input",{type:"checkbox",checked:c.included,onChange:C=>$(c.id,C.target.checked)}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",children:e.jsx("path",{fill:"currentColor",d:"M8.143 13.314 4.829 10l-1.18 1.18 4.494 4.494 8-8-1.18-1.18z"})})})]}),e.jsx("input",{type:"number",className:"editor-input entry-amount",value:String(c.amount),onChange:C=>ee(c.id,C.target.value)}),e.jsx("input",{className:"editor-input entry-note",value:c.note||"",onChange:C=>ce(c.id,C.target.value)}),e.jsxs("button",{className:"btn btn-danger btn-sm flex items-center gap-1",onClick:()=>U(c.id),children:[e.jsx(mn,{className:"w-4 h-4"}),"Удалить"]})]},c.id)),!b&&t.length===0&&e.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"Ещё нет записей."})]})]})})}function wn({value:d,onChange:N,fullWidth:u}){const[f,j]=a.useState(!1),v=a.useRef(null);a.useEffect(()=>{const i=b=>{v.current&&(v.current.contains(b.target)||j(!1))};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[]);const x=d==="income"?"Доходы":"Расходы";return e.jsxs("div",{ref:v,className:`dd-wrap ${u?"block":""}`,children:[e.jsxs("button",{type:"button",className:`btn btn-outline dd-btn ${u?"full":""}`,style:{justifyContent:"flex-start"},onClick:()=>j(i=>!i),children:[e.jsx("span",{style:{pointerEvents:"none"},children:x}),e.jsx("span",{style:{marginLeft:"auto",opacity:.7},children:"▾"})]}),f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dd-backdrop",onClick:()=>j(!1)}),e.jsxs("div",{className:`dd-menu ${u?"full":""}`,children:[e.jsx("div",{className:`dd-item ${d==="income"?"dd-active":""}`,onClick:()=>{N("income"),j(!1)},children:"Доходы"}),e.jsx("div",{className:`dd-item ${d==="expense"?"dd-active":""}`,onClick:()=>{N("expense"),j(!1)},children:"Расходы"})]})]})]})}const Oe=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function En({open:d,onClose:N,year:u,incomeByMonth:f,expenseByMonth:j}){const v=f.reduce((h,t)=>h+t,0),x=j.reduce((h,t)=>h+t,0),i=v-x,b=Math.max(...f,...j,1);return e.jsxs(ue,{open:d,onClose:N,title:`Годовая статистика — ${u}`,size:"lg",footer:e.jsx(rn,{right:e.jsx(on,{variant:"secondary",onClick:N,children:"Закрыть"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-lg font-semibold",children:v})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-lg font-semibold",children:x})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-lg font-semibold",children:i})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Доходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:f.map((h,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Oe[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${h/b*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:h})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Расходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:j.map((h,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Oe[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-red-500",style:{width:`${h/b*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:h})]},t))})]})]})]})}function Sn({value:d,years:N,onChange:u}){const[f,j]=a.useState(!1),v=a.useRef(null);return a.useEffect(()=>{function x(i){f&&i.key==="Escape"&&j(!1)}return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[f]),e.jsxs("div",{className:"dd-wrap",children:[e.jsx("button",{ref:v,className:"btn btn-outline dd-btn",onClick:()=>j(x=>!x),children:d}),f&&e.jsx("div",{className:"dd-backdrop",onClick:()=>j(!1)}),f&&e.jsx("div",{className:"dd-menu",children:N.map(x=>e.jsx("div",{className:"dd-item "+(x===d?"dd-active":""),onClick:()=>{u(x),j(!1)},children:x},x))})]})}function kn({year:d,years:N,onYearChange:u,onAddCategory:f,onShowStats:j}){return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(Sn,{value:d,years:N,onChange:u})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{className:"btn flex items-center gap-2",onClick:f,children:[e.jsx(je,{className:"w-4 h-4"}),"Добавить категорию"]}),e.jsxs("button",{className:"btn btn-outline text-gray-900 flex items-center gap-2",onClick:j,children:[e.jsx(fn,{className:"w-4 h-4"}),"Годовая статистика"]})]})]})}function Te({title:d,onAdd:N}){return e.jsxs("div",{className:"finance-section",children:[e.jsx("span",{children:d}),e.jsxs("button",{className:"btn btn-outline btn-xs text-gray-900 flex items-center gap-1",onClick:N,children:[e.jsx(je,{className:"w-3 h-3"}),"Категория"]})]})}function Pe({type:d,row:N,values:u,isCurrentYear:f,currentMonth:j,hasChildren:v,collapsed:x,onToggleCollapse:i,onNameContext:b,onCellContext:h,onCellEdit:t,fmt:w,ctxCatHighlight:g,ctxCellHighlight:P}){const _={id:N.id,name:N.name,type:d};return e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell "+(g===N.id?"ctx-active":""),children:e.jsxs("div",{className:"cell-head cell-name flex items-center gap-2",children:[e.jsx("button",{className:"shrink-0 rounded-md hover:bg-gray-100 w-6 h-6 flex items-center justify-center",onClick:()=>i(N.id),title:v?x?"Развернуть":"Свернуть":"Категория",children:v?x?e.jsx(xn,{className:"w-4 h-4"}):e.jsx(pn,{className:"w-4 h-4"}):""}),e.jsx("span",{className:"flex-1 truncate",children:N.name}),e.jsx("button",{className:"icon-btn menu-btn",onClick:A=>b(A,_),onContextMenu:A=>b(A,_),"aria-label":"Действия с категорией",children:e.jsx(hn,{size:16})})]})}),u.map((A,O)=>e.jsx("div",{className:"finance-cell "+(f&&O===j?"col-current ":"")+(P&&P.type===d&&P.catId===N.id&&P.month===O?"ctx-active":""),onContextMenu:z=>h(z,d,N.id,O,A),children:e.jsx("button",{className:"cell-btn",onClick:()=>t(d,N.id,O),children:w(A)})},O))]})}function _n({pos:d,onClose:N,onRename:u,onAddSub:f,onDelete:j,canAddSub:v=!0}){const x=a.useRef([]),[i,b]=a.useState(0);return a.useEffect(()=>{const h=t=>{t.key==="Escape"&&(t.preventDefault(),N()),t.key==="ArrowDown"&&(t.preventDefault(),b(w=>Math.min(w+1,x.current.length-1))),t.key==="ArrowUp"&&(t.preventDefault(),b(w=>Math.max(w-1,0))),(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),x.current[i]?.click())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[i,N]),a.useEffect(()=>{x.current[0]?.focus()},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:h=>h.preventDefault(),"aria-hidden":!0}),e.jsxs("div",{className:"ctx-menu",style:{left:d.x,top:d.y},role:"menu","aria-label":"Действия с категорией",onContextMenu:h=>h.preventDefault(),children:[e.jsx("div",{ref:h=>x.current[0]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:u,"aria-label":"Переименовать категорию","data-active":i===0,children:"Переименовать"}),v&&e.jsx("div",{ref:h=>x.current[1]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:f,"aria-label":"Добавить подкатегорию","data-active":i===1,children:"+ Подкатегория"}),e.jsx("div",{ref:h=>x.current[2]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:j,"aria-label":"Удалить категорию","data-active":i===2,style:{color:"#b91c1c"},children:"Удалить"})]})]})}function Mn({pos:d,onClose:N,canCopy:u,hasClipboard:f,onCopy:j,onPaste:v}){const x=a.useMemo(()=>{const t=[];return u&&t.push({label:"Копировать записи",onClick:j,aria:"Копировать записи"}),f&&t.push({label:"Вставить записи (заменить)",onClick:v,aria:"Вставить записи (заменить)"}),t},[u,f,j,v]),i=a.useRef([]),[b,h]=a.useState(0);return a.useEffect(()=>{const t=w=>{w.key==="Escape"&&(w.preventDefault(),N()),w.key==="ArrowDown"&&(w.preventDefault(),h(g=>Math.min(g+1,x.length-1))),w.key==="ArrowUp"&&(w.preventDefault(),h(g=>Math.max(g-1,0))),(w.key==="Enter"||w.key===" ")&&(w.preventDefault(),i.current[b]?.click())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[b,N,x.length]),a.useEffect(()=>{i.current[0]?.focus()},[x.length]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:t=>t.preventDefault(),"aria-hidden":!0}),e.jsx("div",{className:"ctx-menu",style:{left:d.x,top:d.y},role:"menu","aria-label":"Действия с ячейкой",onContextMenu:t=>t.preventDefault(),children:x.map((t,w)=>e.jsx("div",{ref:g=>i.current[w]=g,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:t.onClick,"aria-label":t.aria,"data-active":b===w,children:t.label},w))})]})}function Fe(d,N,u,f){const v=window.innerWidth,x=window.innerHeight;let i=d,b=N;return i+u+8>v&&(i=Math.max(8,v-u-8)),b+f+8>x&&(b=Math.max(8,x-f-8)),i<8&&(i=8),b<8&&(b=8),{x:i,y:b}}function Le(d){const u={},f={};for(const i of d)u[i.id]=i,i.parent_id&&(f[i.parent_id]||=[]).push(i.id);const j={};function v(i){if(!f[i])return Array(12).fill(0);if(j[i])return j[i].slice();const b=Array(12).fill(0);for(const h of f[i]){const t=u[h];if(t)for(let g=0;g<12;g++)b[g]+=t.values?.[g]??0;const w=v(h);for(let g=0;g<12;g++)b[g]+=w[g]||0}return j[i]=b.slice(),b}const x={};for(const i of Object.keys(f))x[i]=v(i);return x}const Ye=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function In(){const d=a.useCallback((f,j,v)=>{try{localStorage.setItem(ve.FINANCE(f,j),JSON.stringify(v))}catch(x){console.warn("Failed to write finance cache:",x)}},[]),N=a.useCallback((f,j)=>{try{const v=localStorage.getItem(ve.FINANCE(f,j));return v?JSON.parse(v):null}catch(v){return console.warn("Failed to read finance cache:",v),null}},[]),u=a.useCallback((f,j)=>{try{localStorage.removeItem(ve.FINANCE(f,j))}catch(v){console.warn("Failed to clear finance cache:",v)}},[]);return{writeCache:d,readCache:N,clearCache:u}}function qe(d,N){return N.find(u=>u.id===d)}const ae=d=>Nn(d);function qn(){const{handleError:d,handleSuccess:N}=vn(),{userId:u}=jn(),{writeCache:f,readCache:j}=In(),{createSimpleFooter:v,createDangerFooter:x}=dn(),i=new Date,b=i.getFullYear(),h=i.getMonth(),[t,w]=a.useState(b),[g,P]=a.useState([]),[_,A]=a.useState([]),[O,z]=a.useState({}),le=a.useMemo(()=>Me(g,O),[g,O]),ge=a.useMemo(()=>Me(_,O),[_,O]),[me,K]=a.useState(!0),[Q,L]=a.useState(!1),[Z,Y]=a.useState(W.INCOME),[ee,ce]=a.useState(""),[$,U]=a.useState(null),[re,ne]=a.useState(!1),[V,c]=a.useState(null),[C,y]=a.useState(0),[E,S]=a.useState(!1),[fe,B]=a.useState({x:0,y:0}),[D,ye]=a.useState(null),[xe,q]=a.useState(!1),[He,$e]=a.useState({x:0,y:0}),[pe,Ue]=a.useState(null),[G,Be]=a.useState(null),[Ke,Ce]=a.useState(!1),[Xe,We]=a.useState(null),[ze,be]=a.useState(!1),[Ve,te]=a.useState(!1),[he,we]=a.useState(""),[Ge,ie]=a.useState(!1),[Ee,X]=a.useState(null),[Se,H]=a.useState(null);a.useEffect(()=>{if(!u)return;const n=j(u,t);n?(P(n.income??[]),A(n.expense??[]),K(!1)):K(!0),(async()=>{const[s,o]=await Promise.all([T.from("finance_categories").select("id,name,type,parent_id").order("created_at",{ascending:!0}),T.from("finance_entries").select("category_id,month,amount,included").eq("year",t)]);if(s.error||o.error){d(s.error||o.error,"Загрузка финансовых данных"),K(!1);return}const l=s.data||[],m=o.data||[],r={};for(const p of l)r[p.id]=Array(se).fill(0);for(const p of m){if(!p.included)continue;const R=Math.min(11,Math.max(0,p.month-1)),I=p.category_id;r[I]||(r[I]=Array(se).fill(0)),r[I][R]+=Number(p.amount)||0}const k=l.filter(p=>p.type===W.INCOME).map(p=>({id:p.id,name:p.name,parent_id:p.parent_id,values:r[p.id]||Array(se).fill(0)})),M=l.filter(p=>p.type===W.EXPENSE).map(p=>({id:p.id,name:p.name,parent_id:p.parent_id,values:r[p.id]||Array(se).fill(0)}));P(k),A(M),K(!1),f(u,t,{income:k.map(({id:p,name:R,values:I,parent_id:Ne})=>({id:p,name:R,values:I,parent_id:Ne})),expense:M.map(({id:p,name:R,values:I,parent_id:Ne})=>({id:p,name:R,values:I,parent_id:Ne}))})})()},[u,t]);const oe=a.useMemo(()=>Ye.map((n,s)=>g.reduce((o,l)=>o+(l.values?.[s]??0),0)),[g]),de=a.useMemo(()=>Ye.map((n,s)=>_.reduce((o,l)=>o+(l.values?.[s]??0),0)),[_]),Je=a.useMemo(()=>oe.map((n,s)=>n-de[s]),[oe,de]);a.useMemo(()=>{const n={};return g.forEach(s=>{s.parent_id&&(n[s.parent_id]=(n[s.parent_id]||0)+1)}),n},[g]),a.useMemo(()=>{const n={};return _.forEach(s=>{s.parent_id&&(n[s.parent_id]=(n[s.parent_id]||0)+1)}),n},[_]);const ke=a.useMemo(()=>Le(g),[g]),_e=a.useMemo(()=>Le(_),[_]);function Me(n,s){const o=n.filter(r=>!r.parent_id),l={};n.forEach(r=>{r.parent_id&&(l[r.parent_id]||=[]).push(r)});const m=[];return o.forEach(r=>{m.push(r),s[r.id]||(l[r.id]||[]).forEach(k=>m.push(k))}),n.filter(r=>r.parent_id&&!o.find(k=>k.id===r.parent_id)).forEach(r=>m.push(r)),m}async function Qe(){const n=ee.trim();if(!n||!u)return;const s=Z,o={user_id:u,type:s,name:n};$&&(o.parent_id=$.id);const{data:l,error:m}=await T.from("finance_categories").insert(o).select("id,name,type,parent_id").single();if(m){d(m,"Создание категории");return}const r={id:l.id,name:l.name,type:l.type,parent_id:l.parent_id,values:Array(se).fill(0)};if(s===W.INCOME){const k=[g,r];P(k),f(u,t,{income:k.map(({id:M,name:p,values:R,parent_id:I})=>({id:M,name:p,values:R,parent_id:I})),expense:_.map(({id:M,name:p,values:R,parent_id:I})=>({id:M,name:p,values:R,parent_id:I}))})}else{const k=[_,r];A(k),f(u,t,{income:g.map(({id:M,name:p,values:R,parent_id:I})=>({id:M,name:p,values:R,parent_id:I})),expense:k.map(({id:M,name:p,values:R,parent_id:I})=>({id:M,name:p,values:R,parent_id:I}))})}N(`Категория "${n}" создана`),L(!1),ce(""),Y(W.INCOME),U(null)}function Ie(n,s){n.preventDefault(),n.stopPropagation(),xe&&q(!1),H(null),X(s.id);const o=Fe(n.clientX,n.clientY,Ae,gn);B({x:o.x,y:o.y}),ye(s),S(!0)}function Ze(){S(!1),ye(null),X(null)}async function en(){const n=he.trim();if(!n||!D){te(!1);return}const{error:s}=await T.from("finance_categories").update({name:n}).eq("id",D.id);if(s){d(s,"Создание категории");return}if(D.type==="income"){const o=g.map(l=>l.id===D.id?{...l,name:n}:l);P(o),f(u,t,{income:o.map(({id:l,name:m,values:r,parent_id:k})=>({id:l,name:m,values:r,parent_id:k})),expense:_.map(({id:l,name:m,values:r,parent_id:k})=>({id:l,name:m,values:r,parent_id:k}))})}else{const o=_.map(l=>l.id===D.id?{...l,name:n}:l);A(o),f(u,t,{income:g.map(({id:l,name:m,values:r,parent_id:k})=>({id:l,name:m,values:r,parent_id:k})),expense:o.map(({id:l,name:m,values:r,parent_id:k})=>({id:l,name:m,values:r,parent_id:k}))})}te(!1)}async function nn(){if(!D)return;const{error:n}=await T.from("finance_categories").delete().eq("id",D.id);if(n){d(n,"Создание категории");return}if(D.type==="income"){const s=g.filter(o=>o.id!==D.id);P(s),f(u,t,{income:s.map(({id:o,name:l,values:m,parent_id:r})=>({id:o,name:l,values:m,parent_id:r})),expense:_.map(({id:o,name:l,values:m,parent_id:r})=>({id:o,name:l,values:m,parent_id:r}))})}else{const s=_.filter(o=>o.id!==D.id);A(s),f(u,t,{income:g.map(({id:o,name:l,values:m,parent_id:r})=>({id:o,name:l,values:m,parent_id:r})),expense:s.map(({id:o,name:l,values:m,parent_id:r})=>({id:o,name:l,values:m,parent_id:r}))})}ie(!1)}async function De(n,s,o,l,m){n.preventDefault(),n.stopPropagation(),E&&S(!1),xe&&q(!1),X(null),H({type:s,catId:o,month:l});const r={category_id:o,year:t,month:l+1},k=!!G&&G.length>0;if(!k&&(!m||m===0)){H(null);return}const M=Fe(n.clientX,n.clientY,Ae,yn);Ue({catId:o,type:s,month:l}),$e({x:M.x,y:M.y}),Ce(!1),q(!0);const{data:p}=await T.from("finance_entries").select("amount, note, included, position").match(r).order("position",{ascending:!0}).order("created_at",{ascending:!0}),R=(p||[]).map(I=>({amount:Number(I.amount)||0,note:I.note,included:!!I.included,position:I.position??0}));if(We(R),!R.length&&!k){q(!1),H(null);return}Ce(R.length>0)}async function tn(){const n=Xe||[];if(!n.length){q(!1),H(null);return}Be(n.slice());try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{}q(!1),H(null)}async function sn(){if(!pe||!G||!G.length||!u)return;const{catId:n,type:s,month:o}=pe,l={category_id:n,year:t,month:o+1};await T.from("finance_entries").delete().match(l);const m=G.map((M,p)=>({where:l,user_id:u,amount:M.amount,note:M.note,included:M.included,position:p}));await T.from("finance_entries").insert(m);const r=m.filter(M=>M.included).reduce((M,p)=>M+(p.amount||0),0),k=M=>M.map(p=>p.id===n?{...p,values:p.values.map((R,I)=>I===o?r:R)}:p);s==="income"?P(k(g)):A(k(_)),q(!1),H(null)}if(a.useEffect(()=>{const n=o=>{o.key==="Escape"&&(S(!1),q(!1),X(null),H(null))},s=()=>{S(!1),q(!1),X(null),H(null)};return window.addEventListener("keydown",n),window.addEventListener("wheel",s,{passive:!0}),()=>{window.removeEventListener("keydown",n),window.removeEventListener("wheel",s)}},[]),me)return e.jsx("div",{className:"p-4",children:e.jsx(Cn,{rows:10})});const J=t===b,an=Array.from({length:7}).map((n,s)=>b-3+s);return e.jsxs(ln.Fragment,{children:[e.jsxs("div",{className:"space-y-6 finance-page",onContextMenu:n=>{n.preventDefault()},children:[e.jsx(kn,{year:t,years:an,onYearChange:w,onAddCategory:()=>{Y(W.INCOME),U(null),L(!0)},onShowStats:()=>be(!0)}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Категория"})}),Re.map((n,s)=>e.jsx("div",{className:"finance-cell "+(J&&s===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsx(Te,{title:"Доходы",onAdd:()=>{Y(W.INCOME),U(null),L(!0)}}),le.map(n=>{const s=!!ke[n.id],o=s?ke[n.id]:n.values;return e.jsx(Pe,{type:"income",row:n,values:o,isCurrentYear:J,currentMonth:h,hasChildren:s,collapsed:!!O[n.id],onToggleCollapse:l=>z(m=>({...m,[l]:!m[l]})),onNameContext:(l,m)=>Ie(l,m),onCellContext:De,onCellEdit:(l,m,r)=>{c({id:m,name:n.name,type:l}),y(r),ne(!0)},fmt:ae,ctxCatHighlight:Ee,ctxCellHighlight:Se})}),e.jsx(Te,{title:"Расходы",onAdd:()=>{Y(W.EXPENSE),U(null),L(!0)}}),ge.map(n=>{const s=!!_e[n.id],o=s?_e[n.id]:n.values;return e.jsx(Pe,{type:"expense",row:n,values:o,isCurrentYear:J,currentMonth:h,hasChildren:s,collapsed:!!O[n.id],onToggleCollapse:l=>z(m=>({...m,[l]:!m[l]})),onNameContext:(l,m)=>Ie(l,m),onCellContext:De,onCellEdit:(l,m,r)=>{c({id:m,name:n.name,type:l}),y(r),ne(!0)},fmt:ae,ctxCatHighlight:Ee,ctxCellHighlight:Se})})]}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Показатель"})}),Re.map((n,s)=>e.jsx("div",{className:"finance-cell "+(J&&s===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Доходы"})}),oe.map((n,s)=>e.jsx("div",{className:"finance-cell "+(J&&s===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:ae(n)})},s))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Расходы"})}),de.map((n,s)=>e.jsx("div",{className:"finance-cell "+(J&&s===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:ae(n)})},s))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:700},children:"Баланс"})}),Je.map((n,s)=>e.jsx("div",{className:"finance-cell "+(J&&s===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",style:{fontWeight:700},children:ae(n)})},s))]})]})]}),E&&D&&e.jsx(_n,{pos:fe,canAddSub:!(qe(D.id,g)||qe(D.id,_))?.parent_id,onClose:Ze,onRename:()=>{we(D.name),te(!0),S(!1),X(null)},onAddSub:()=>{Y(D.type),U({id:D.id,name:D.name}),L(!0),S(!1),X(null)},onDelete:()=>{ie(!0),S(!1),X(null)}}),xe&&pe&&e.jsx(Mn,{pos:He,onClose:()=>{q(!1),H(null)},canCopy:Ke,hasClipboard:!!(G&&G.length>0),onCopy:tn,onPaste:sn}),e.jsxs(ue,{open:Q,onClose:()=>{L(!1),U(null)},title:$?"Новая подкатегория":"Новая категория",subtitle:$?`Родитель: ${$.name}`:void 0,footer:v({label:$?"Добавить подкатегорию":"Добавить категорию",onClick:Qe,disabled:!ee.trim()},{label:"Отмена",onClick:()=>{L(!1),U(null)}}),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Тип"}),e.jsx("div",{className:"flex-1",children:e.jsx(wn,{value:Z,onChange:Y,fullWidth:!0})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Название"}),e.jsx("input",{value:ee,onChange:n=>ce(n.target.value),placeholder:$?"Напр. Коммунальные":"Напр. Жильё",className:"border rounded-lg px-3 py-2 text-sm flex-1"})]})]}),e.jsx(ue,{open:Ve,onClose:()=>te(!1),title:"Переименовать категорию",footer:v({label:"Сохранить",onClick:en,disabled:!he.trim()},{label:"Отмена",onClick:()=>te(!1)}),children:e.jsx("input",{value:he,onChange:n=>we(n.target.value),className:"border rounded-lg px-3 py-2 text-sm w-full",autoFocus:!0})}),e.jsx(ue,{open:Ge,onClose:()=>ie(!1),title:"Удалить категорию?",footer:x({label:"Удалить",onClick:nn},{label:"Отмена",onClick:()=>ie(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Все записи в этой категории будут удалены без возможности восстановления."})}),re&&V&&e.jsx(bn,{open:re,onClose:()=>ne(!1),userId:u,categoryId:V.id,categoryName:V.name,monthIndex:C,year:t,onApply:n=>{const s=o=>o.map(l=>l.id===V.id?{...l,values:l.values.map((m,r)=>r===C?n:m)}:l);V.type==="income"?P(s(g)):A(s(_))}}),e.jsx(En,{open:ze,onClose:()=>be(!1),year:t,incomeByMonth:oe,expenseByMonth:de})]})}export{qn as default};
