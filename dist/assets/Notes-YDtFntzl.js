import{j as r,s as T,A as z,b as P,c as Y}from"./index-C9CAK8j2.js";import{r as s}from"./vendor-5APVzNZg.js";import{S as V,P as B}from"./PageContainer-BjQpAS9l.js";import F from"./NoteEditorModal-CXmWiyos.js";import{u as L}from"./errorHandler-ndPEhMzI.js";import{a as U,L as q}from"./LoadingStates-CkdnrzZx.js";import{P as G}from"./ErrorBoundaries-DJzfo9mo.js";import"./supabase-7cNBIxai.js";import"./ModalSystem-DpluxzZI.js";import"./ModalForm-D2xgqyvm.js";const I=s.memo(({note:e,onEdit:t,onDelete:a,onTogglePin:n})=>{const l=s.useMemo(()=>e.content?.slice(0,160)??"",[e.content]),i=s.useCallback(()=>{t(e)},[e,t]),u=s.useCallback(c=>{c.stopPropagation(),n(e)},[e,n]),m=s.useCallback(c=>{c.stopPropagation(),a(e)},[e,a]);return r.jsxs("div",{className:"rounded-2xl shadow-sm border border-gray-200 bg-white hover:shadow-md transition p-4 flex flex-col gap-3",role:"button",onClick:i,children:[r.jsxs("div",{className:"flex items-start justify-between gap-2",children:[r.jsx("h3",{className:"text-sm font-semibold line-clamp-2",children:e.title||"Без заголовка"}),r.jsx("button",{className:"text-xs px-2 py-1 rounded-full border hover:bg-gray-50",onClick:u,title:e.pinned?"Открепить":"Закрепить",children:e.pinned?"📌":"📍"})]}),r.jsx("p",{className:"text-xs text-gray-600 line-clamp-4 whitespace-pre-wrap",children:l}),r.jsxs("div",{className:"flex justify-between items-center pt-2 border-t text-[11px] text-gray-500",children:[r.jsx("span",{children:new Date(e.updated_at).toLocaleString()}),r.jsx("button",{className:"text-red-600 hover:underline",onClick:m,children:"Удалить"})]})]})});I.displayName="NoteCard";async function K(e,t="updated_at"){let a=T.from("notes").select("*").order("pinned",{ascending:!1}).order(t,{ascending:t==="title"});e?.trim()&&(a=a.ilike("title",`%${e.trim()}%`));const{data:n,error:l}=await a;if(l)throw l;return n}async function J(e){const{data:t,error:a}=await T.from("notes").insert({title:e.title??"",content:e.content??"",pinned:e.pinned??!1}).select().single();if(a)throw a;return t}async function O(e,t){const{data:a,error:n}=await T.from("notes").update(t).eq("id",e).select().single();if(n)throw n;return a}async function Q(e){const{error:t}=await T.from("notes").delete().eq("id",e);if(t)throw t}async function X(e,t){return O(e,{pinned:t})}function Z(e,t=250){const[a,n]=s.useState(e);return s.useEffect(()=>{const l=setTimeout(()=>n(e),t);return()=>clearTimeout(l)},[e,t]),a}const H=s.memo(({items:e,itemHeight:t,containerHeight:a,renderItem:n,keyExtractor:l,overscan:i=5,className:u=""})=>{const m=s.useRef(null),[c,p]=s.useState(0),h=s.useCallback(x=>{p(x.currentTarget.scrollTop)},[]),d=s.useMemo(()=>{const x=Math.max(0,Math.floor(c/t)-i),b=Math.min(e.length-1,Math.ceil((c+a)/t)+i);return{startIndex:x,endIndex:b}},[c,t,a,e.length,i]),y=s.useMemo(()=>{const{startIndex:x,endIndex:b}=d;return e.slice(x,b+1).map((k,g)=>({item:k,index:x+g}))},[e,d]),j=e.length*t,C=d.startIndex*t;return r.jsx("div",{ref:m,className:`overflow-auto ${u}`,style:{height:a},onScroll:h,children:r.jsx("div",{style:{height:j,position:"relative"},children:r.jsx("div",{style:{transform:`translateY(${C}px)`},children:y.map(({item:x,index:b})=>r.jsx("div",{style:{height:t},children:n(x,b)},l(x,b)))})})})});H.displayName="VirtualizedList";const ee=s.memo(({items:e,hasMore:t,isLoading:a,onLoadMore:n,renderItem:l,keyExtractor:i,itemHeight:u,className:m=""})=>{const c=s.useRef(),p=s.useCallback(h=>{a||(c.current&&c.current.disconnect(),c.current=new IntersectionObserver(d=>{d[0].isIntersecting&&t&&n()}),h&&c.current.observe(h))},[a,t,n]);return s.useEffect(()=>()=>{c.current&&c.current.disconnect()},[]),r.jsxs("div",{className:m,children:[e.map((h,d)=>{const y=d===e.length-1;return r.jsx("div",{ref:y?p:null,style:u?{height:u}:void 0,children:l(h,d)},i(h,d))}),a&&r.jsx("div",{className:"flex justify-center p-4",children:r.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent"})})]})});ee.displayName="InfiniteScrollList";const _=s.memo(({items:e,columns:t,itemHeight:a,containerHeight:n,renderItem:l,keyExtractor:i,gap:u=16,className:m=""})=>{const c=s.useRef(null),[p,h]=s.useState(0),d=s.useCallback(g=>{h(g.currentTarget.scrollTop)},[]),y=Math.ceil(e.length/t),j=a+u,C=s.useMemo(()=>{const g=Math.max(0,Math.floor(p/j)-2),w=Math.min(y-1,Math.ceil((p+n)/j)+2);return{startRow:g,endRow:w}},[p,j,n,y]),x=s.useMemo(()=>{const{startRow:g,endRow:w}=C,v=[];for(let N=g;N<=w;N++)for(let S=0;S<t;S++){const M=N*t+S;M<v.length&&v.push({item:v[M],index:M,row:N,col:S})}return v},[e,C,t]),b=y*j,k=C.startRow*j;return r.jsx("div",{ref:c,className:`overflow-auto ${m}`,style:{height:n},onScroll:d,children:r.jsx("div",{style:{height:b,position:"relative"},children:r.jsx("div",{style:{transform:`translateY(${k}px)`,display:"grid",gridTemplateColumns:`repeat(${t}, 1fr)`,gap:`${u}px`},children:x.map(({item:g,index:w,row:v,col:N})=>r.jsx("div",{style:{height:a},children:l(g,w)},i(g,w)))})})})});_.displayName="VirtualizedGrid";const te={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2,retryCondition:e=>e?.code==="NETWORK_ERROR"||e?.code==="TIMEOUT"||e?.status>=500&&e?.status<600||e?.status===429,onRetry:(e,t)=>{console.warn(`Retry attempt ${e} after error:`,t)}};function se(e,t){const a=t.baseDelay*Math.pow(t.backoffMultiplier,e-1),n=Math.random()*.1*a,l=Math.min(a+n,t.maxDelay);return Math.floor(l)}function re(e){return new Promise(t=>setTimeout(t,e))}async function ae(e,t={}){const a={...te,...t};let n=null;for(let l=1;l<=a.maxRetries+1;l++)try{return{data:await e(),error:null,attempts:l,success:!0}}catch(i){if(n=i instanceof Error?i:new Error(String(i)),l===a.maxRetries+1||!a.retryCondition(n))break;a.onRetry(l,n);const u=se(l,a);await re(u)}return{data:null,error:n,attempts:a.maxRetries+1,success:!1}}function ne(){const{handleError:e}=L(),[t,a]=s.useState(!1),[n,l]=s.useState(0);return{executeWithRetry:s.useCallback(async(u,m={})=>{a(!0),l(0);const c=await ae(u,{...m,onRetry:(p,h)=>{l(p),m.onRetry?.(p,h)}});return a(!1),c.success?c.data:(e(c.error,"Операция завершилась с ошибкой"),null)},[e]),isRetrying:t,retryCount:n}}function le(){const{executeWithRetry:e,isRetrying:t,retryCount:a}=ne(),[n,l]=s.useState(!1),[i,u]=s.useState(null);return{executeApiCall:s.useCallback(async(c,p={})=>{l(!0),u(null);const h=await e(c,{maxRetries:3,baseDelay:1e3,retryCondition:d=>d?.code==="NETWORK_ERROR"||d?.code==="TIMEOUT"||d?.status>=500&&d?.status<600||d?.status===429,onRetry:(d,y)=>{console.log(`Retry attempt ${d} for API call:`,y)},...p});return l(!1),h===null&&u(new Error("API call failed after retries")),h},[e]),isLoading:n||t,retryCount:a,error:i,clearError:()=>u(null)}}function oe(){const{handleError:e,handleSuccess:t}=L(),{executeApiCall:a}=le(),[n,l]=s.useState([]),[i,u]=s.useState(""),[m,c]=s.useState("updated_at"),[p,h]=s.useState(!0),[d,y]=s.useState(!1),[j,C]=s.useState(null),x=Z(i,250);async function b(o){h(!0);try{const f=await a(()=>K(x,m));if(o?.aborted)return;f&&l(f)}catch(f){o?.aborted||e(f,"Загрузка заметок")}finally{o?.aborted||h(!1)}}s.useEffect(()=>{const o=new AbortController;return b(o.signal),()=>o.abort()},[m,x]);const k=s.useCallback(async(o,f)=>{try{if(f){const R=await O(f,o);l(E=>E.map(A=>A.id===f?R:A)),t("Заметка обновлена")}else{const R=await J(o);l(E=>[R,...E]),t("Заметка создана")}}catch(R){e(R,f?"Обновление заметки":"Создание заметки")}},[e,t]),g=s.useCallback(async o=>{try{await Q(o),l(f=>f.filter(R=>R.id!==o)),t("Заметка удалена")}catch(f){e(f,"Удаление заметки")}},[e,t]),w=s.useCallback(async o=>{try{const f=await X(o.id,!o.pinned);l(R=>R.map(E=>E.id===o.id?f:E)),t(o.pinned?"Закрепление снято":"Заметка закреплена")}catch(f){e(f,"Изменение закрепления")}},[e,t]),v=!p&&n.length===0&&!i,N=s.useCallback(()=>{C(null),y(!0)},[]),S=s.useCallback(o=>{u(o.target.value)},[]),M=s.useCallback(o=>{c(o.target.value)},[]),D=s.useCallback(o=>{C(o),y(!0)},[]),$=s.useCallback(()=>{y(!1)},[]),W=s.useMemo(()=>4,[]);return r.jsxs(r.Fragment,{children:[r.jsx(V,{title:"Заметки",children:r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(z,{variant:"primary",size:"sm",onClick:N,ariaLabel:P.ADD+" заметку",announceOnClick:"Открыто окно создания заметки",children:"+ Создать заметку"})})}),r.jsxs(B,{children:[r.jsx("div",{className:"flex flex-col gap-4",children:r.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[r.jsx(Y,{label:"Поиск заметок",placeholder:"Поиск по заголовку…",value:i,onChange:S,className:"w-64",ariaLabel:P.SEARCH+" заметок"}),r.jsxs("div",{className:"flex flex-col",children:[r.jsx("label",{htmlFor:"sort-select",className:"text-sm font-medium text-gray-700 mb-1",children:"Сортировка"}),r.jsxs("select",{id:"sort-select",className:"border rounded-lg px-3 py-2 text-sm",value:m,onChange:M,"aria-label":"Выберите способ сортировки заметок",children:[r.jsx("option",{value:"updated_at",children:"По обновлению"}),r.jsx("option",{value:"created_at",children:"По созданию"}),r.jsx("option",{value:"title",children:"По алфавиту"})]})]})]})}),r.jsx(U,{loading:p,empty:v,emptyMessage:"Пока нет заметок",loadingComponent:r.jsx(q,{count:6}),children:n.length>50?r.jsx(_,{items:n,columns:W,itemHeight:200,containerHeight:600,renderItem:(o,f)=>r.jsx(I,{note:o,onEdit:D,onDelete:g,onTogglePin:w},o.id),keyExtractor:o=>o.id,gap:16,className:"p-4"}):r.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4",children:n.map(o=>r.jsx(I,{note:o,onEdit:D,onDelete:g,onTogglePin:w},o.id))})}),r.jsx(F,{open:d,note:j,onClose:$,onSave:k,onDelete:g})]})]})}function ye(){return r.jsx(G,{pageName:"Заметки",onError:(e,t)=>{console.error("Notes page error:",e,t)},children:r.jsx(oe,{})})}export{ye as default};
