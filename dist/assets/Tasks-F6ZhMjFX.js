import{j as e,s as k}from"./index-C94S2Pq2.js";import{r as c,R as Pe}from"./vendor-CqGws4Uo.js";import{b as fe,i as xe,a as ee,c as te,d as Ge,s as ke,e as De,f as F,g as ye,h as Te,j as We}from"./utils-DyBHi9Eu.js";import{U as oe,u as ge}from"./ModalSystem-CDKUOn7n.js";import{M as Ne,a as V,b as re,c as be,d as _e,e as Ee}from"./ModalForm-BdvjI4Gw.js";import{C as Le,c as Oe,P as Ae,X as Ie}from"./icons-HVSKy6uN.js";import{C as Re,T as Fe}from"./TaskViewModal-YiXJ1XXE.js";import{u as qe}from"./errorHandler-DqUfoQxQ.js";import{u as He}from"./useSupabaseAuth-BE5_Bh0U.js";import{T as ne,b as ae,c as se}from"./constants-Dv7MHcu-.js";import"./supabase-BmeMSZYH.js";function ie(i,s){if(i.one!==void 0&&s===1)return i.one;const d=s%10,u=s%100;return d===1&&u!==11?i.singularNominative.replace("{{count}}",String(s)):d>=2&&d<=4&&(u<10||u>20)?i.singularGenitive.replace("{{count}}",String(s)):i.pluralGenitive.replace("{{count}}",String(s))}function S(i){return(s,d)=>d?.addSuffix?d.comparison&&d.comparison>0?i.future?ie(i.future,s):"через "+ie(i.regular,s):i.past?ie(i.past,s):ie(i.regular,s)+" назад":ie(i.regular,s)}const $e={lessThanXSeconds:S({regular:{one:"меньше секунды",singularNominative:"меньше {{count}} секунды",singularGenitive:"меньше {{count}} секунд",pluralGenitive:"меньше {{count}} секунд"},future:{one:"меньше, чем через секунду",singularNominative:"меньше, чем через {{count}} секунду",singularGenitive:"меньше, чем через {{count}} секунды",pluralGenitive:"меньше, чем через {{count}} секунд"}}),xSeconds:S({regular:{singularNominative:"{{count}} секунда",singularGenitive:"{{count}} секунды",pluralGenitive:"{{count}} секунд"},past:{singularNominative:"{{count}} секунду назад",singularGenitive:"{{count}} секунды назад",pluralGenitive:"{{count}} секунд назад"},future:{singularNominative:"через {{count}} секунду",singularGenitive:"через {{count}} секунды",pluralGenitive:"через {{count}} секунд"}}),halfAMinute:(i,s)=>s?.addSuffix?s.comparison&&s.comparison>0?"через полминуты":"полминуты назад":"полминуты",lessThanXMinutes:S({regular:{one:"меньше минуты",singularNominative:"меньше {{count}} минуты",singularGenitive:"меньше {{count}} минут",pluralGenitive:"меньше {{count}} минут"},future:{one:"меньше, чем через минуту",singularNominative:"меньше, чем через {{count}} минуту",singularGenitive:"меньше, чем через {{count}} минуты",pluralGenitive:"меньше, чем через {{count}} минут"}}),xMinutes:S({regular:{singularNominative:"{{count}} минута",singularGenitive:"{{count}} минуты",pluralGenitive:"{{count}} минут"},past:{singularNominative:"{{count}} минуту назад",singularGenitive:"{{count}} минуты назад",pluralGenitive:"{{count}} минут назад"},future:{singularNominative:"через {{count}} минуту",singularGenitive:"через {{count}} минуты",pluralGenitive:"через {{count}} минут"}}),aboutXHours:S({regular:{singularNominative:"около {{count}} часа",singularGenitive:"около {{count}} часов",pluralGenitive:"около {{count}} часов"},future:{singularNominative:"приблизительно через {{count}} час",singularGenitive:"приблизительно через {{count}} часа",pluralGenitive:"приблизительно через {{count}} часов"}}),xHours:S({regular:{singularNominative:"{{count}} час",singularGenitive:"{{count}} часа",pluralGenitive:"{{count}} часов"}}),xDays:S({regular:{singularNominative:"{{count}} день",singularGenitive:"{{count}} дня",pluralGenitive:"{{count}} дней"}}),aboutXWeeks:S({regular:{singularNominative:"около {{count}} недели",singularGenitive:"около {{count}} недель",pluralGenitive:"около {{count}} недель"},future:{singularNominative:"приблизительно через {{count}} неделю",singularGenitive:"приблизительно через {{count}} недели",pluralGenitive:"приблизительно через {{count}} недель"}}),xWeeks:S({regular:{singularNominative:"{{count}} неделя",singularGenitive:"{{count}} недели",pluralGenitive:"{{count}} недель"}}),aboutXMonths:S({regular:{singularNominative:"около {{count}} месяца",singularGenitive:"около {{count}} месяцев",pluralGenitive:"около {{count}} месяцев"},future:{singularNominative:"приблизительно через {{count}} месяц",singularGenitive:"приблизительно через {{count}} месяца",pluralGenitive:"приблизительно через {{count}} месяцев"}}),xMonths:S({regular:{singularNominative:"{{count}} месяц",singularGenitive:"{{count}} месяца",pluralGenitive:"{{count}} месяцев"}}),aboutXYears:S({regular:{singularNominative:"около {{count}} года",singularGenitive:"около {{count}} лет",pluralGenitive:"около {{count}} лет"},future:{singularNominative:"приблизительно через {{count}} год",singularGenitive:"приблизительно через {{count}} года",pluralGenitive:"приблизительно через {{count}} лет"}}),xYears:S({regular:{singularNominative:"{{count}} год",singularGenitive:"{{count}} года",pluralGenitive:"{{count}} лет"}}),overXYears:S({regular:{singularNominative:"больше {{count}} года",singularGenitive:"больше {{count}} лет",pluralGenitive:"больше {{count}} лет"},future:{singularNominative:"больше, чем через {{count}} год",singularGenitive:"больше, чем через {{count}} года",pluralGenitive:"больше, чем через {{count}} лет"}}),almostXYears:S({regular:{singularNominative:"почти {{count}} год",singularGenitive:"почти {{count}} года",pluralGenitive:"почти {{count}} лет"},future:{singularNominative:"почти через {{count}} год",singularGenitive:"почти через {{count}} года",pluralGenitive:"почти через {{count}} лет"}})},Ve=(i,s,d)=>$e[i](s,d),ze={full:"EEEE, d MMMM y 'г.'",long:"d MMMM y 'г.'",medium:"d MMM y 'г.'",short:"dd.MM.y"},Xe={full:"H:mm:ss zzzz",long:"H:mm:ss z",medium:"H:mm:ss",short:"H:mm"},Ke={any:"{{date}}, {{time}}"},Ye={date:fe({formats:ze,defaultWidth:"full"}),time:fe({formats:Xe,defaultWidth:"full"}),dateTime:fe({formats:Ke,defaultWidth:"any"})},he=["воскресенье","понедельник","вторник","среду","четверг","пятницу","субботу"];function Ue(i){const s=he[i];switch(i){case 0:return"'в прошлое "+s+" в' p";case 1:case 2:case 4:return"'в прошлый "+s+" в' p";case 3:case 5:case 6:return"'в прошлую "+s+" в' p"}}function je(i){const s=he[i];return i===2?"'во "+s+" в' p":"'в "+s+" в' p"}function Be(i){const s=he[i];switch(i){case 0:return"'в следующее "+s+" в' p";case 1:case 2:case 4:return"'в следующий "+s+" в' p";case 3:case 5:case 6:return"'в следующую "+s+" в' p"}}const Qe={lastWeek:(i,s,d)=>{const u=i.getDay();return xe(i,s,d)?je(u):Ue(u)},yesterday:"'вчера в' p",today:"'сегодня в' p",tomorrow:"'завтра в' p",nextWeek:(i,s,d)=>{const u=i.getDay();return xe(i,s,d)?je(u):Be(u)},other:"P"},Je=(i,s,d,u)=>{const p=Qe[i];return typeof p=="function"?p(s,d,u):p},Ze={narrow:["до н.э.","н.э."],abbreviated:["до н. э.","н. э."],wide:["до нашей эры","нашей эры"]},et={narrow:["1","2","3","4"],abbreviated:["1-й кв.","2-й кв.","3-й кв.","4-й кв."],wide:["1-й квартал","2-й квартал","3-й квартал","4-й квартал"]},tt={narrow:["Я","Ф","М","А","М","И","И","А","С","О","Н","Д"],abbreviated:["янв.","фев.","март","апр.","май","июнь","июль","авг.","сент.","окт.","нояб.","дек."],wide:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"]},nt={narrow:["Я","Ф","М","А","М","И","И","А","С","О","Н","Д"],abbreviated:["янв.","фев.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],wide:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"]},it={narrow:["В","П","В","С","Ч","П","С"],short:["вс","пн","вт","ср","чт","пт","сб"],abbreviated:["вск","пнд","втр","срд","чтв","птн","суб"],wide:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"]},at={narrow:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утро",afternoon:"день",evening:"веч.",night:"ночь"},abbreviated:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утро",afternoon:"день",evening:"веч.",night:"ночь"},wide:{am:"ДП",pm:"ПП",midnight:"полночь",noon:"полдень",morning:"утро",afternoon:"день",evening:"вечер",night:"ночь"}},st={narrow:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утра",afternoon:"дня",evening:"веч.",night:"ночи"},abbreviated:{am:"ДП",pm:"ПП",midnight:"полн.",noon:"полд.",morning:"утра",afternoon:"дня",evening:"веч.",night:"ночи"},wide:{am:"ДП",pm:"ПП",midnight:"полночь",noon:"полдень",morning:"утра",afternoon:"дня",evening:"вечера",night:"ночи"}},rt=(i,s)=>{const d=Number(i),u=s?.unit;let p;return u==="date"?p="-е":u==="week"||u==="minute"||u==="second"?p="-я":p="-й",d+p},ot={ordinalNumber:rt,era:ee({values:Ze,defaultWidth:"wide"}),quarter:ee({values:et,defaultWidth:"wide",argumentCallback:i=>i-1}),month:ee({values:tt,defaultWidth:"wide",formattingValues:nt,defaultFormattingWidth:"wide"}),day:ee({values:it,defaultWidth:"wide"}),dayPeriod:ee({values:at,defaultWidth:"any",formattingValues:st,defaultFormattingWidth:"wide"})},lt=/^(\d+)(-?(е|я|й|ое|ье|ая|ья|ый|ой|ий|ый))?/i,ct=/\d+/i,dt={narrow:/^((до )?н\.?\s?э\.?)/i,abbreviated:/^((до )?н\.?\s?э\.?)/i,wide:/^(до нашей эры|нашей эры|наша эра)/i},ut={any:[/^д/i,/^н/i]},mt={narrow:/^[1234]/i,abbreviated:/^[1234](-?[ыои]?й?)? кв.?/i,wide:/^[1234](-?[ыои]?й?)? квартал/i},ft={any:[/1/i,/2/i,/3/i,/4/i]},pt={narrow:/^[яфмаисонд]/i,abbreviated:/^(янв|фев|март?|апр|ма[йя]|июн[ья]?|июл[ья]?|авг|сент?|окт|нояб?|дек)\.?/i,wide:/^(январ[ья]|феврал[ья]|марта?|апрел[ья]|ма[йя]|июн[ья]|июл[ья]|августа?|сентябр[ья]|октябр[ья]|октябр[ья]|ноябр[ья]|декабр[ья])/i},gt={narrow:[/^я/i,/^ф/i,/^м/i,/^а/i,/^м/i,/^и/i,/^и/i,/^а/i,/^с/i,/^о/i,/^н/i,/^я/i],any:[/^я/i,/^ф/i,/^мар/i,/^ап/i,/^ма[йя]/i,/^июн/i,/^июл/i,/^ав/i,/^с/i,/^о/i,/^н/i,/^д/i]},ht={narrow:/^[впсч]/i,short:/^(вс|во|пн|по|вт|ср|чт|че|пт|пя|сб|су)\.?/i,abbreviated:/^(вск|вос|пнд|пон|втр|вто|срд|сре|чтв|чет|птн|пят|суб).?/i,wide:/^(воскресень[ея]|понедельника?|вторника?|сред[аы]|четверга?|пятниц[аы]|суббот[аы])/i},vt={narrow:[/^в/i,/^п/i,/^в/i,/^с/i,/^ч/i,/^п/i,/^с/i],any:[/^в[ос]/i,/^п[он]/i,/^в/i,/^ср/i,/^ч/i,/^п[ят]/i,/^с[уб]/i]},xt={narrow:/^([дп]п|полн\.?|полд\.?|утр[оа]|день|дня|веч\.?|ноч[ьи])/i,abbreviated:/^([дп]п|полн\.?|полд\.?|утр[оа]|день|дня|веч\.?|ноч[ьи])/i,wide:/^([дп]п|полночь|полдень|утр[оа]|день|дня|вечера?|ноч[ьи])/i},yt={any:{am:/^дп/i,pm:/^пп/i,midnight:/^полн/i,noon:/^полд/i,morning:/^у/i,afternoon:/^д[ен]/i,evening:/^в/i,night:/^н/i}},bt={ordinalNumber:Ge({matchPattern:lt,parsePattern:ct,valueCallback:i=>parseInt(i,10)}),era:te({matchPatterns:dt,defaultMatchWidth:"wide",parsePatterns:ut,defaultParseWidth:"any"}),quarter:te({matchPatterns:mt,defaultMatchWidth:"wide",parsePatterns:ft,defaultParseWidth:"any",valueCallback:i=>i+1}),month:te({matchPatterns:pt,defaultMatchWidth:"wide",parsePatterns:gt,defaultParseWidth:"any"}),day:te({matchPatterns:ht,defaultMatchWidth:"wide",parsePatterns:vt,defaultParseWidth:"any"}),dayPeriod:te({matchPatterns:xt,defaultMatchWidth:"wide",parsePatterns:yt,defaultParseWidth:"any"})},le={code:"ru",formatDistance:Ve,formatLong:Ye,formatRelative:Je,localize:ot,match:bt,options:{weekStartsOn:1,firstWeekContainsDate:1}},we=["#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1","#a855f7","#ec4899","#f43f5e","#64748b"];function jt({open:i,onClose:s,userId:d,onCreated:u}){const[p,x]=c.useState(""),[D,q]=c.useState(we[8]),[C,E]=c.useState(!1),{createStandardFooter:R}=ge();async function H(){const y=p.trim();if(y){E(!0);try{let M="",T=y,h=await k.from("tasks_projects").insert({user_id:d,name:y,color:D}).select("id,name").single();if(h.error){const N=await k.from("tasks_projects").insert({user_id:d,name:y}).select("id,name").single();if(N.error)return;M=N.data.id,T=N.data.name}else M=h.data.id,T=h.data.name;u({id:M,name:T,color:D}),x(""),s()}finally{E(!1)}}}return e.jsx(oe,{open:i,onClose:s,title:"Новый проект",footer:R({label:"Создать",onClick:H,loading:C,disabled:!p.trim()},{label:"Отмена",onClick:s}),children:e.jsxs(Ne,{children:[e.jsx(V,{label:"Название",required:!0,children:e.jsx(re,{value:p,onChange:y=>x(y.target.value),placeholder:"Например, Website Redesign",autoFocus:!0})}),e.jsx(V,{label:"Цвет",children:e.jsx("div",{className:"grid grid-cols-7 gap-2",children:we.map(y=>e.jsx("button",{onClick:()=>q(y),title:y,className:`w-8 h-8 rounded-full border-2 transition-all ${D===y?"border-gray-900":"border-gray-200"}`,style:{backgroundColor:y}},y))})})]})})}const wt=["#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1","#a855f7","#ec4899","#f43f5e","#64748b"];function kt({userId:i,activeId:s,onChange:d}){const[u,p]=c.useState([]),[x,D]=c.useState(!1),[q,C]=c.useState(!1),[E,R]=c.useState(!1),{createSimpleFooter:H,createDangerFooter:y}=ge();c.useEffect(()=>{i&&(async()=>{const o=await k.from("tasks_projects").select("id,name,color,position").order("position",{ascending:!0}).order("created_at",{ascending:!0});if(!o.error){C(!0),R(!0),p([{id:"ALL",name:"Все проекты",color:null},...o.data||[]]);return}const g=await k.from("tasks_projects").select("id,name").order("created_at",{ascending:!0});g.error||p([{id:"ALL",name:"Все проекты",color:null},...g.data||[]])})()},[i]);const M=c.useRef(null);function T(o){M.current=o}async function h(o){const g=M.current;if(M.current=null,!g||g===o)return;if(!E){const a=[...u],r=a.findIndex(w=>w.id===g),v=a.findIndex(w=>w.id===o);if(r<0||v<0)return;const[b]=a.splice(r,1);a.splice(v,0,b),p(a);return}const A=[...u],X=A.findIndex(a=>a.id===g),t=A.findIndex(a=>a.id===o);if(X<0||t<0)return;const[l]=A.splice(X,1);A.splice(t,0,l);const n=A.map((a,r)=>({...a,position:r}));p(n),await Promise.all(n.map(a=>k.from("tasks_projects").update({position:a.position}).eq("id",a.id)))}const[N,j]=c.useState(!1),[P,G]=c.useState({x:0,y:0}),[f,L]=c.useState(null),O=c.useRef(null);c.useEffect(()=>{const o=g=>{N&&O.current&&!O.current.contains(g.target)&&j(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[N]);function U(o,g){if(g.id==="ALL")return;o.preventDefault();const A=150,X=100,t=8,l=window.innerWidth,n=window.innerHeight;let a=o.clientX,r=o.clientY;a+A>l-t&&(a=l-A-t),r+X>n-t&&(r=n-X-t),a<t&&(a=t),r<t&&(r=t),L(g),G({x:a,y:r}),j(!0)}const[J,z]=c.useState(!1),[B,Z]=c.useState(""),[m,W]=c.useState(!1);async function _(){if(!f)return;const o=B.trim();o&&(await k.from("tasks_projects").update({name:o}).eq("id",f.id),p(u.map(g=>g.id===f.id?{...g,name:o}:g)),z(!1))}async function Q(){f&&(await k.from("tasks_projects").delete().eq("id",f.id),p(u.filter(o=>o.id!==f.id)),s===f.id&&d(null),W(!1))}async function ce(o){f&&(q&&await k.from("tasks_projects").update({color:o}).eq("id",f.id),p(u.map(g=>g.id===f.id?{...g,color:o}:g)),j(!1))}function de(o){p(g=>[...g,{id:o.id,name:o.name,color:o.color}]),d(o.id)}return e.jsxs("aside",{className:"tasks-projects rounded-xl border border-gray-200 bg-white",style:{width:280},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700",children:"Проекты"}),e.jsx("button",{className:"btn btn-outline w-[34px] h-[34px] p-0 flex items-center justify-center",onClick:()=>D(!0),children:"+"})]}),e.jsx("div",{className:"space-y-1",children:u.map(o=>e.jsx("div",{children:e.jsxs("button",{draggable:o.id!=="ALL",onDragStart:()=>T(o.id),onDragOver:g=>{g.preventDefault()},onDrop:()=>h(o.id),onClick:()=>d(o.id),onContextMenu:g=>U(g,o),className:`w-full rounded-lg border px-3 py-2 text-left flex items-center gap-2 ${s===o.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:bg-gray-50"}`,title:o.name,children:[e.jsx("span",{className:"mr-2 inline-flex items-center",style:{color:o.color||"#94a3b8"},children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",stroke:"currentColor","stroke-width":"1.5",children:e.jsx("path",{d:"M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"})})}),e.jsx("span",{className:"truncate",children:o.name})]})},o.id))}),N&&f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:()=>j(!1)}),e.jsxs("div",{className:"ctx-menu",ref:O,style:{left:P.x,top:P.y,minWidth:200,padding:6},children:[e.jsx("div",{className:"dd-item",onClick:()=>{Z(f.name),z(!0),j(!1)},children:"Переименовать"}),e.jsxs("div",{className:"dd-item",children:[e.jsx("div",{className:"mb-1 text-xs text-gray-500",children:"Цвет"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(7, 18px)",gap:6},children:wt.map(o=>e.jsx("button",{onClick:()=>ce(o),style:{width:18,height:18,borderRadius:9999,background:o,border:"1px solid rgba(0,0,0,.08)"}},o))})]}),e.jsx("div",{className:"dd-item",style:{color:"#b91c1c"},onClick:()=>{W(!0),j(!1)},children:"Удалить"})]})]}),e.jsx(jt,{open:x,onClose:()=>D(!1),userId:i,onCreated:de}),e.jsx(oe,{open:J,onClose:()=>z(!1),title:"Переименовать проект",footer:H({label:"Сохранить",onClick:_,disabled:!B.trim()},{label:"Отмена",onClick:()=>z(!1)}),children:e.jsx("input",{className:"border rounded-lg px-3 py-2 text-sm w-full",value:B,onChange:o=>Z(o.target.value)})}),e.jsx(oe,{open:m,onClose:()=>W(!1),title:"Удалить проект?",footer:y({label:"Удалить",onClick:Q},{label:"Отмена",onClick:()=>W(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Проект и связанные задачи будут удалены."})})]})}function Nt({anchor:i,onPrev:s,onNext:d}){const u=ke(i,{weekStartsOn:1}),p=De(u,6);return e.jsxs("div",{className:"timeline",children:[e.jsx("button",{className:"nav-left btn btn-outline w-[34px] h-[34px] p-0 flex items-center justify-center week-nav",onClick:s,"aria-label":"Предыдущая неделя",children:e.jsx(Le,{size:16})}),e.jsxs("div",{className:"range",children:[F(u,"d MMM",{locale:le})," — ",F(p,"d MMM, yyyy",{locale:le})]}),e.jsx("button",{className:"nav-right btn btn-outline w-[34px] h-[34px] p-0 flex items-center justify-center week-nav",onClick:d,"aria-label":"Следующая неделя",children:e.jsx(Oe,{size:16})})]})}function St({open:i,onClose:s,onSubmit:d,dateLabel:u,projects:p=[],activeProject:x}){const[D,q]=c.useState(""),[C,E]=c.useState(""),[R,H]=c.useState("normal"),[y,M]=c.useState(""),[T,h]=c.useState([]),[N,j]=c.useState(""),[P,G]=c.useState(!1),{createStandardFooter:f}=ge(),L=x&&x!=="ALL"?x:"",[O,U]=c.useState(L);c.useEffect(()=>{i&&U(x&&x!=="ALL"?x:"")},[i,x]);function J(){const m=N.trim();m&&(h(W=>[...W,{id:String(Date.now()),text:m,done:!1}]),j(""))}function z(m){h(W=>W.map(_=>_.id===m?{..._,done:!_.done}:_))}function B(m){h(W=>W.filter(_=>_.id!==m))}async function Z(){const m=D.trim();if(m&&O){G(!0);try{await d(m,C,String(R),y.trim(),T,O),q(""),E(""),H("normal"),M(""),h([]),j(""),s()}finally{G(!1)}}}return e.jsx(oe,{size:"lg",open:i,onClose:s,title:"Новая задача",subtitle:u,footer:f({label:"Добавить",onClick:Z,loading:P,disabled:!O||!D.trim()},{label:"Отмена",onClick:s}),children:e.jsxs(Ne,{children:[e.jsx(V,{label:"Проект",required:!0,children:e.jsxs(be,{value:O,onChange:m=>U(m.target.value),children:[e.jsx("option",{value:"",children:x==="ALL"?"Выберите проект":"Текущий проект выбран"}),(p||[]).map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})}),e.jsx(V,{label:"Название задачи",required:!0,children:e.jsx(re,{value:D,onChange:m=>q(m.target.value),placeholder:"Название задачи"})}),e.jsx(V,{label:"Описание",children:e.jsx(_e,{value:C,onChange:m=>E(m.target.value),placeholder:"Подробности задачи",rows:4})}),e.jsxs(Ee,{cols:2,children:[e.jsx(V,{label:"Приоритет",children:e.jsxs(be,{value:R,onChange:m=>H(m.target.value),children:[e.jsx("option",{value:"low",children:"Низкий"}),e.jsx("option",{value:"normal",children:"Обычный"}),e.jsx("option",{value:"high",children:"Высокий"})]})}),e.jsx(V,{label:"Тег",children:e.jsx(re,{value:y,onChange:m=>M(m.target.value),placeholder:"Напр. Work"})})]}),e.jsx(V,{label:"Чек-лист",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(re,{value:N,onChange:m=>j(m.target.value),placeholder:"Добавить пункт"}),e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2",onClick:J,disabled:!N.trim(),children:[e.jsx(Ae,{className:"w-4 h-4"}),"Добавить"]})]}),T.length>0&&e.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:T.map(m=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded",children:[e.jsx(Re,{checked:m.done,onToggle:()=>z(m.id)}),e.jsx("span",{className:`text-sm flex-1 ${m.done?"line-through text-gray-400":""}`,children:m.text}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600 p-1",onClick:()=>B(m.id),title:"Удалить",children:e.jsx(Ie,{className:"w-4 h-4"})})]},m.id))})]})})]})})}function pe(i,s){if(!i||typeof i!="string"||!/^#?[0-9a-fA-F]{6}$/.test(i))return"rgba(0,0,0,0)";const d=i.startsWith("#")?i.slice(1):i,u=parseInt(d.slice(0,2),16),p=parseInt(d.slice(2,4),16),x=parseInt(d.slice(4,6),16);return`rgba(${u}, ${p}, ${x}, ${s})`}function At(){const{handleError:i,handleSuccess:s}=qe(),{userId:d}=He(),[u,p]=c.useState(null),x=c.useRef(null);function D(t){x.current={id:t.id,from:t.date}}async function q(t){const l=x.current;if(x.current=null,!l||!d)return;const n={...P},a=n[l.from]||[],r=a.find($=>$.id===l.id),v=a.findIndex($=>$.id===l.id);v>=0&&a.splice(v,1);const b=n[t]||=[],w=b.length;r&&b.push({...r,date:t,position:w}),G(n),await k.from("tasks_items").update({date:t,position:w}).eq("id",l.id)}const[C,E]=c.useState(()=>ke(new Date,{weekStartsOn:1})),[R,H]=c.useState(()=>ye(new Date,{weekStartsOn:1})),y=F(new Date,"yyyy-MM-dd");c.useEffect(()=>{H(ye(C,{weekStartsOn:1}))},[C]);const[M,T]=c.useState([]),[h,N]=c.useState(ne),j=c.useMemo(()=>{const t={};for(const l of M)t[l.id]=l.color||void 0;return t},[M]);c.useEffect(()=>{d&&(async()=>{const t=await k.from("tasks_projects").select("id,name,color").order("created_at",{ascending:!0});if(!t.error){const n=t.data||[];T(n),h||N(ne);return}const l=await k.from("tasks_projects").select("id,name").order("created_at",{ascending:!0});if(!l.error){const n=l.data||[];T(n),h||N(ne)}})()},[d]);const[P,G]=c.useState({});c.useEffect(()=>{if(!d||!h){G({});return}const t=k.from("tasks_items").select("id,project_id,title,description,date,position,priority,tag,todos,status").gte("date",F(C,"yyyy-MM-dd")).lte("date",F(R,"yyyy-MM-dd")).order("date",{ascending:!0}).order("position",{ascending:!0});(h===ne?t:t.eq("project_id",h)).then(({data:n})=>{const a={};(n||[]).forEach(r=>{const v=r.date;(a[v]||=[]).push({id:r.id,project_id:r.project_id,title:r.title,description:r.description,date:r.date,position:r.position,priority:r.priority,tag:r.tag,todos:r.todos||[],status:r.status||ae.OPEN})}),G(a)})},[d,h,C,R]);const[f,L]=c.useState({open:!1,x:0,y:0,task:null,dayKey:void 0});c.useEffect(()=>{const t=l=>{l.key==="Escape"&&L(n=>({...n,open:!1}))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]);async function O(t,l){try{const a=(P[l]||[]).length,{data:r,error:v}=await k.from("tasks_items").insert({project_id:t.project_id||h,title:t.title,description:t.description||null,date:l,position:a,priority:t.priority||null,tag:t.tag||null,todos:Array.isArray(t.todos)?t.todos:[]}).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();if(!v&&r){const b={id:r.id,title:r.title,description:r.description||void 0,date:r.date,position:r.position,priority:r.priority||void 0,tag:r.tag||void 0,todos:r.todos||[]},w={...P};(w[l]||=[]).push(b),G(w)}}finally{L(n=>({...n,open:!1}))}}async function U(t,l){try{await k.from("tasks_items").delete().eq("id",t.id);const n={...P},a=n[l]||[],r=a.findIndex(v=>v.id===t.id);r>=0&&(a.splice(r,1),n[l]=a),G(n)}finally{L(n=>({...n,open:!1}))}}const J=c.useMemo(()=>{const t=[],l=new Date(C);for(let n=0;n<7;n++)t.push(new Date(l.getFullYear(),l.getMonth(),l.getDate()+n));return t},[C]),[z,B]=c.useState(!1),[Z,m]=c.useState(""),[W,_]=c.useState(!1),[Q,ce]=c.useState(null),[de,o]=c.useState(""),[g,A]=c.useState("");async function X(t,l,n,a,r,v){if(!d||!Q)return;const b=v||(h&&h!==ne?h:null);if(!b)return;const w=(t??de).trim(),$=l??g,K=n??se.NORMAL,Y=a??"",Se=Array.isArray(r)?r:[];if(!w)return;const ue=F(Q,"yyyy-MM-dd"),Ce=P[ue]?.length||0,{data:I,error:me}=await k.from("tasks_items").insert({project_id:b,title:w,description:$,date:ue,position:Ce,priority:K,tag:Y,todos:Se}).select("id,project_id,title,description,date,position,priority,tag,todos,status").single();if(!me&&I){const Me={id:I.id,project_id:I.project_id,title:I.title,description:I.description,date:I.date,position:I.position,priority:I.priority,tag:I.tag,todos:I.todos||[]},ve={...P};(ve[ue]||=[]).push(Me),G(ve),s(`Задача "${w}" создана`),o(""),A(""),_(!1)}else me&&i(me,"Создание задачи")}return e.jsxs("div",{className:"tasks-page",children:[e.jsx(kt,{userId:d,activeId:h,onChange:N}),e.jsx("section",{className:"tasks-board",children:e.jsxs("div",{className:"week-grid",children:[e.jsx("div",{className:"week-head",children:e.jsx(Nt,{anchor:C,onPrev:()=>E(t=>We(t)),onNext:()=>E(t=>Te(t,1))})}),J.map(t=>{const l=F(t,"yyyy-MM-dd");return e.jsxs("div",{onDragOver:n=>n.preventDefault(),onDrop:()=>q(l),className:`day-col ${[0,6].includes(new Date(t).getDay())?"is-weekend":""} ${l===y?"is-today":""}`,children:[e.jsxs("div",{className:"day-head",children:[e.jsx("span",{children:F(t,"EEE, d MMM",{locale:le})}),e.jsx("button",{className:"btn btn-outline btn-xs add-on-hover",onClick:()=>{ce(t),_(!0)},children:"+ Задача"})]}),e.jsx("div",{className:"day-body",children:(P[l]||[]).map(n=>e.jsx("div",{className:`task-card ${n.status===ae.CLOSED?"is-closed":""}`,style:{backgroundColor:j[n.project_id]?pe(j[n.project_id],.1):void 0,border:j[n.project_id]?`1px solid ${pe(j[n.project_id],.5)}`:"1px solid #e5e7eb"},onContextMenu:a=>{a.preventDefault(),a.stopPropagation();const r=150,v=120,b=8,w=window.innerWidth,$=window.innerHeight;let K=a.clientX,Y=a.clientY;K+r>w-b&&(K=w-r-b),Y+v>$-b&&(Y=$-v-b),K<b&&(K=b),Y<b&&(Y=b),L({open:!0,x:K,y:Y,task:n,dayKey:l})},onMouseDownCapture:a=>{a.button===2&&(a.preventDefault(),a.stopPropagation())},onDragStart:()=>D(n),onClick:a=>{f.open||p(n)},draggable:!0,children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[n.priority?e.jsx("span",{className:"inline-block rounded-full "+(n.priority===se.HIGH?"w-2.5 h-2.5 bg-red-500":n.priority===se.LOW?"w-2.5 h-2.5 bg-green-500":n.priority===se.MEDIUM?"w-2.5 h-2.5 bg-yellow-500":"w-2.5 h-2.5 bg-gray-300")}):null,n.tag?e.jsx("span",{className:"px-2 py-0.5 text-xs rounded-full leading-none uppercase",style:{backgroundColor:j[n.project_id]?pe(j[n.project_id],.2):"#e5e7eb",color:"#111827"},children:n.tag}):null]}),e.jsx("div",{className:"leading-tight clamp-2 break-words mb-2",children:e.jsx("span",{className:"font-medium",children:n.title})}),e.jsx("div",{className:"text-xs text-gray-500 mt-0",children:(()=>{const a=Array.isArray(n.todos)?n.todos.length:0;return`${Array.isArray(n.todos)?n.todos.filter(v=>v.done).length:0}/${a}`})()})]})},n.id))})]},l)})]})}),e.jsx(St,{open:W,projects:M,activeProject:h,onClose:()=>_(!1),dateLabel:Q?F(Q,"d MMMM, EEEE",{locale:le}):"",onSubmit:async(t,l,n,a,r,v)=>{await X(t,l,n,a,r,v)}}),e.jsx(Fe,{open:!!u,onClose:()=>p(null),task:u,onUpdated:t=>{if(!t)return;const l={...P},n=l[t.date||""]||[],a=n.findIndex(r=>r.id===t.id);a>=0&&(n[a]={...n[a],...t},G(l))}}),f.open&&e.jsxs(Pe.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:()=>L(t=>({...t,open:!1}))}),e.jsxs("div",{className:"ctx-menu",style:{left:f.x,top:f.y},children:[e.jsx("div",{className:"ctx-item",onClick:()=>f.task&&f.dayKey&&O(f.task,f.dayKey),children:"Дублировать"}),e.jsx("div",{className:"ctx-item",onClick:async()=>{f.task&&f.dayKey&&(await k.from("tasks_items").update({status:ae.CLOSED}).eq("id",f.task.id),G(t=>{const l={...t},n=[...l[f.dayKey]||[]],a=n.findIndex(r=>r.id===f.task.id);return a>=0&&(n[a]={...n[a],status:ae.CLOSED}),l[f.dayKey]=n,l}),L(t=>({...t,open:!1})))},children:"Выполнить"}),e.jsx("div",{className:"ctx-item text-red-600",onClick:()=>f.task&&f.dayKey&&U(f.task,f.dayKey),children:"Удалить"})]})]})]})}export{At as default};
