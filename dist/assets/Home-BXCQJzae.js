import{s as D,r as i,j as e}from"./index-ByxKddn8.js";import{f as I}from"./format-CfBjB5Ts.js";function M(d){const o=new Date,c=new Intl.DateTimeFormat("en-US",{timeZone:d,year:"numeric",month:"2-digit",day:"2-digit"}),[{value:h},,{value:g},,{value:f}]=c.formatToParts(o);return new Date(`${f}-${h}-${g}T00:00:00`)}function E(d){const o=M(d);return new Date(o.getTime()+24*60*60*1e3-1)}function F(d){const o=new Date,c=new Intl.DateTimeFormat("en-US",{timeZone:d,year:"numeric",month:"2-digit",day:"2-digit"}),[{value:h},,{value:g},,{value:f}]=c.formatToParts(o),n=new Date(`${f}-${h}-01T00:00:00`),r=new Date(new Date(n).setMonth(n.getMonth()+1)-1);return{start:n,end:r}}const S={TZ:"Asia/Tbilisi",debug:!1,tasks:{table:"tasks_items",id:"id",title:"title",due:"date",status:"status",statusDoneValue:"done",priority:"priority",project:null,userId:"user_id"},notes:{table:"notes",id:"id",title:"title",updatedAt:"updated_at",userId:"user_id"},finance:{table:"finance_entries",id:"id",amount:"amount",date:"date",userId:"user_id",mode:"auto",type:"type",boolField:null}};let q=null;async function k(){var c;if(q)return q;const{data:d,error:o}=await D.auth.getUser();return o?(console.error("[auth] getUser error:",o.message),null):(q=((c=d.user)==null?void 0:c.id)??null,q)}function R(){const[d,o]=i.useState([]),[c,h]=i.useState(!0),[g,f]=i.useState(null),n=i.useMemo(()=>M(S.TZ).toISOString(),[]),r=i.useMemo(()=>E(S.TZ).toISOString(),[]);return i.useEffect(()=>{let u=!1;return(async()=>{h(!0),f(null);try{const t=S.tasks,w=[t.id,t.title,t.due,t.status,t.priority].filter(Boolean).join(",");let m=D.from(t.table).select(w);const y=t.userId,p=await k();y&&p&&(m=m.eq(y,p)),m=m.gte(t.due,n).lte(t.due,r),t.status&&(m=m.neq(t.status,t.statusDoneValue));const{data:a,error:s}=await m.order(t.priority||t.due,{ascending:!0}).limit(50);if(s)throw s;const b=a.map(j=>({id:j[t.id],title:j[t.title],due:j[t.due],status:t.status?j[t.status]:null,priority:t.priority?j[t.priority]:null}));u||o(b)}catch(t){u||f((t==null?void 0:t.message)||"Ошибка загрузки задач")}finally{u||h(!1)}})(),()=>{u=!0}},[n,r]),e.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-baseline gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold tracking-[-0.01em]",children:"Задачи на сегодня"}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date().toLocaleDateString("ru-RU")})]}),e.jsx("a",{href:"/tasks",className:"text-sm text-blue-600 hover:underline",children:"Открыть все"})]}),c?e.jsx("div",{className:"text-sm text-gray-500",children:"Загрузка…"}):g?e.jsxs("div",{className:"text-sm text-red-600",children:["Ошибка: ",g]}):d.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"На сегодня нет задач."}):e.jsx("ul",{className:"space-y-2",children:d.map(u=>e.jsxs("li",{className:"flex items-center gap-3 rounded-xl border border-gray-100 p-3 hover:bg-gray-50",children:[e.jsx("div",{className:"w-5 h-5 shrink-0 rounded border border-gray-300 bg-white"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm",children:u.title}),e.jsx("div",{className:"text-xs text-gray-500",children:u.due?`Срок: ${new Date(u.due).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}`:""})]}),e.jsx("a",{className:"btn",href:"/tasks",children:"Открыть"})]},u.id))})]})}function $(){const[d,o]=i.useState([]),[c,h]=i.useState(!0),[g,f]=i.useState(null);return i.useEffect(()=>{let n=!1;return(async()=>{h(!0),f(null);try{const r=S.notes;let u=D.from(r.table).select(`${r.id},${r.title},${r.updatedAt}`);const t=r.userId,w=await k();t&&w&&(u=u.eq(t,w));const{data:m,error:y}=await u.order(r.updatedAt,{ascending:!1}).limit(6);if(y)throw y;const p=m.map(a=>({id:a[r.id],title:a[r.title],updatedAt:a[r.updatedAt]}));n||o(p)}catch(r){n||f((r==null?void 0:r.message)||"Ошибка загрузки заметок")}finally{n||h(!1)}})(),()=>{n=!0}},[]),e.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold tracking-[-0.01em]",children:"Последние заметки"}),e.jsx("a",{href:"/notes",className:"text-sm text-blue-600 hover:underline",children:"Все заметки"})]}),c?e.jsx("div",{className:"text-sm text-gray-500",children:"Загрузка…"}):g?e.jsxs("div",{className:"text-sm text-red-600",children:["Ошибка: ",g]}):d.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Заметок нет."}):e.jsx("ul",{className:"space-y-2",children:d.slice(0,3).map(n=>e.jsxs("li",{className:"flex items-center justify-between rounded-xl border border-gray-100 p-3 hover:bg-gray-50",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm",children:n.title||"Без названия"}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Обновлено ",new Date(n.updatedAt).toLocaleString("ru-RU")]})]}),e.jsx("a",{className:"btn",href:`/notes?id=${n.id}`,children:"Открыть"})]},n.id))})]})}function A(){const[{start:d,end:o}]=i.useState(()=>F(S.TZ)),[c,h]=i.useState([]),[g,f]=i.useState(!0),[n,r]=i.useState(null),[u,t]=i.useState(""),w=i.useMemo(()=>new Intl.DateTimeFormat("ru-RU",{month:"long",year:"numeric"}).format(new Date),[]);i.useEffect(()=>{let a=!1;return(async()=>{f(!0),r(null);const s=S.finance,b=await k();async function j(){const l=[s.amount,s.type].filter(Boolean).join(",");let x=D.from(s.table).select(l);b&&(x=x.eq(s.userId,b)),x=x.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:v,error:N}=await x.limit(2e3);if(N)throw N;return v.map(T=>({amount:Number(T[s.amount]??0),type:String(T[s.type])}))}async function L(){const l=[s.amount,s.boolField].filter(Boolean).join(",");let x=D.from(s.table).select(l);b&&(x=x.eq(s.userId,b)),x=x.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:v,error:N}=await x.limit(2e3);if(N)throw N;return v.map(T=>({amount:Number(T[s.amount]??0),flag:!!T[s.boolField]}))}async function U(){let l=D.from(s.table).select(s.amount);b&&(l=l.eq(s.userId,b)),l=l.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:x,error:v}=await l.limit(2e3);if(v)throw v;return x.map(N=>({amount:Number(N[s.amount]??0)}))}try{let l=[];if(s.mode!=="type"){if(s.mode!=="bool"){if(s.mode!=="sign")try{l=await j(),t("type")}catch{l=await U(),t("sign")}}}a||h(l)}catch(l){a||r((l==null?void 0:l.message)||"Ошибка загрузки финансов")}finally{a||f(!1)}})(),()=>{a=!0}},[d,o]);let m=0,y=0;u==="type"?(m=c.filter(a=>a.type==="income").reduce((a,s)=>a+(s.amount||0),0),y=c.filter(a=>a.type==="expense").reduce((a,s)=>a+(s.amount||0),0)):(m=c.filter(a=>(a.amount??0)>=0).reduce((a,s)=>a+(s.amount||0),0),y=c.filter(a=>(a.amount??0)<0).reduce((a,s)=>a+Math.abs(s.amount||0),0));const p=m-y;return e.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold tracking-[-0.01em]",children:["Финансы: ",w]}),e.jsx("a",{href:"/finance",className:"text-sm text-blue-600 hover:underline",children:"Открыть финансы"})]}),g?e.jsx("div",{className:"text-sm text-gray-500",children:"Загрузка…"}):n?e.jsxs("div",{className:"text-sm text-red-600",children:["Ошибка: ",n]}):e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-xl font-semibold",children:I(m)})]}),e.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-xl font-semibold",children:I(y)})]}),e.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-xl font-semibold "+(p>=0?"text-emerald-600":"text-red-600"),children:I(p)})]})]})]})}function Z(){const[d,o]=i.useState(null);return i.useEffect(()=>{},[]),null}function B(){return e.jsxs("div",{className:"p-0 md:p-8",children:[e.jsx(Z,{}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-0",children:[e.jsxs("div",{className:"xl:col-span-2 space-y-6",children:[e.jsx(R,{}),e.jsx(A,{})]}),e.jsx("div",{className:"xl:col-span-1 space-y-6",children:e.jsx($,{})})]})]})}function C(){return e.jsx(B,{})}export{C as default};
