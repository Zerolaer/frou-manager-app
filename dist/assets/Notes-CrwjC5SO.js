import{j as a,s as T,P as z,A as Y,b as L,c as V}from"./index-B1jK0nAM.js";import{r as s}from"./vendor-CqGws4Uo.js";import B from"./NoteEditorModal-RW45EyTl.js";import{u as P}from"./errorHandler-BgkP6tds.js";import{a as U,L as q}from"./LoadingStates-B7z4q8u6.js";import"./supabase-BmeMSZYH.js";import"./ModalSystem-C0FHoGU5.js";import"./ModalForm-CBxhg8WT.js";const I=s.memo(({note:e,onEdit:t,onDelete:r,onTogglePin:n})=>{const l=s.useMemo(()=>e.content?.slice(0,160)??"",[e.content]),i=s.useCallback(()=>{t(e)},[e,t]),u=s.useCallback(c=>{c.stopPropagation(),n(e)},[e,n]),m=s.useCallback(c=>{c.stopPropagation(),r(e)},[e,r]);return a.jsxs("div",{className:"rounded-2xl shadow-sm border border-gray-200 bg-white hover:shadow-md transition p-4 flex flex-col gap-3",role:"button",onClick:i,children:[a.jsxs("div",{className:"flex items-start justify-between gap-2",children:[a.jsx("h3",{className:"text-sm font-semibold line-clamp-2",children:e.title||"Без заголовка"}),a.jsx("button",{className:"text-xs px-2 py-1 rounded-full border hover:bg-gray-50",onClick:u,title:e.pinned?"Открепить":"Закрепить",children:e.pinned?"📌":"📍"})]}),a.jsx("p",{className:"text-xs text-gray-600 line-clamp-4 whitespace-pre-wrap",children:l}),a.jsxs("div",{className:"flex justify-between items-center pt-2 border-t text-[11px] text-gray-500",children:[a.jsx("span",{children:new Date(e.updated_at).toLocaleString()}),a.jsx("button",{className:"text-red-600 hover:underline",onClick:m,children:"Удалить"})]})]})});I.displayName="NoteCard";async function F(e,t="updated_at"){let r=T.from("notes").select("*").order("pinned",{ascending:!1}).order(t,{ascending:t==="title"});e?.trim()&&(r=r.ilike("title",`%${e.trim()}%`));const{data:n,error:l}=await r;if(l)throw l;return n}async function G(e){const{data:t,error:r}=await T.from("notes").insert({title:e.title??"",content:e.content??"",pinned:e.pinned??!1}).select().single();if(r)throw r;return t}async function O(e,t){const{data:r,error:n}=await T.from("notes").update(t).eq("id",e).select().single();if(n)throw n;return r}async function K(e){const{error:t}=await T.from("notes").delete().eq("id",e);if(t)throw t}async function J(e,t){return O(e,{pinned:t})}function Q(e,t=250){const[r,n]=s.useState(e);return s.useEffect(()=>{const l=setTimeout(()=>n(e),t);return()=>clearTimeout(l)},[e,t]),r}const X=s.memo(({items:e,itemHeight:t,containerHeight:r,renderItem:n,keyExtractor:l,overscan:i=5,className:u=""})=>{const m=s.useRef(null),[c,p]=s.useState(0),h=s.useCallback(x=>{p(x.currentTarget.scrollTop)},[]),d=s.useMemo(()=>{const x=Math.max(0,Math.floor(c/t)-i),b=Math.min(e.length-1,Math.ceil((c+r)/t)+i);return{startIndex:x,endIndex:b}},[c,t,r,e.length,i]),y=s.useMemo(()=>{const{startIndex:x,endIndex:b}=d;return e.slice(x,b+1).map((k,g)=>({item:k,index:x+g}))},[e,d]),w=e.length*t,C=d.startIndex*t;return a.jsx("div",{ref:m,className:`overflow-auto ${u}`,style:{height:r},onScroll:h,children:a.jsx("div",{style:{height:w,position:"relative"},children:a.jsx("div",{style:{transform:`translateY(${C}px)`},children:y.map(({item:x,index:b})=>a.jsx("div",{style:{height:t},children:n(x,b)},l(x,b)))})})})});X.displayName="VirtualizedList";const Z=s.memo(({items:e,hasMore:t,isLoading:r,onLoadMore:n,renderItem:l,keyExtractor:i,itemHeight:u,className:m=""})=>{const c=s.useRef(),p=s.useCallback(h=>{r||(c.current&&c.current.disconnect(),c.current=new IntersectionObserver(d=>{d[0].isIntersecting&&t&&n()}),h&&c.current.observe(h))},[r,t,n]);return s.useEffect(()=>()=>{c.current&&c.current.disconnect()},[]),a.jsxs("div",{className:m,children:[e.map((h,d)=>{const y=d===e.length-1;return a.jsx("div",{ref:y?p:null,style:u?{height:u}:void 0,children:l(h,d)},i(h,d))}),r&&a.jsx("div",{className:"flex justify-center p-4",children:a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent"})})]})});Z.displayName="InfiniteScrollList";const _=s.memo(({items:e,columns:t,itemHeight:r,containerHeight:n,renderItem:l,keyExtractor:i,gap:u=16,className:m=""})=>{const c=s.useRef(null),[p,h]=s.useState(0),d=s.useCallback(g=>{h(g.currentTarget.scrollTop)},[]),y=Math.ceil(e.length/t),w=r+u,C=s.useMemo(()=>{const g=Math.max(0,Math.floor(p/w)-2),R=Math.min(y-1,Math.ceil((p+n)/w)+2);return{startRow:g,endRow:R}},[p,w,n,y]),x=s.useMemo(()=>{const{startRow:g,endRow:R}=C,v=[];for(let N=g;N<=R;N++)for(let S=0;S<t;S++){const M=N*t+S;M<v.length&&v.push({item:v[M],index:M,row:N,col:S})}return v},[e,C,t]),b=y*w,k=C.startRow*w;return a.jsx("div",{ref:c,className:`overflow-auto ${m}`,style:{height:n},onScroll:d,children:a.jsx("div",{style:{height:b,position:"relative"},children:a.jsx("div",{style:{transform:`translateY(${k}px)`,display:"grid",gridTemplateColumns:`repeat(${t}, 1fr)`,gap:`${u}px`},children:x.map(({item:g,index:R,row:v,col:N})=>a.jsx("div",{style:{height:r},children:l(g,R)},i(g,R)))})})})});_.displayName="VirtualizedGrid";const H={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2,retryCondition:e=>e?.code==="NETWORK_ERROR"||e?.code==="TIMEOUT"||e?.status>=500&&e?.status<600||e?.status===429,onRetry:(e,t)=>{console.warn(`Retry attempt ${e} after error:`,t)}};function ee(e,t){const r=t.baseDelay*Math.pow(t.backoffMultiplier,e-1),n=Math.random()*.1*r,l=Math.min(r+n,t.maxDelay);return Math.floor(l)}function te(e){return new Promise(t=>setTimeout(t,e))}async function se(e,t={}){const r={...H,...t};let n=null;for(let l=1;l<=r.maxRetries+1;l++)try{return{data:await e(),error:null,attempts:l,success:!0}}catch(i){if(n=i instanceof Error?i:new Error(String(i)),l===r.maxRetries+1||!r.retryCondition(n))break;r.onRetry(l,n);const u=ee(l,r);await te(u)}return{data:null,error:n,attempts:r.maxRetries+1,success:!1}}function re(){const{handleError:e}=P(),[t,r]=s.useState(!1),[n,l]=s.useState(0);return{executeWithRetry:s.useCallback(async(u,m={})=>{r(!0),l(0);const c=await se(u,{...m,onRetry:(p,h)=>{l(p),m.onRetry?.(p,h)}});return r(!1),c.success?c.data:(e(c.error,"Операция завершилась с ошибкой"),null)},[e]),isRetrying:t,retryCount:n}}function ae(){const{executeWithRetry:e,isRetrying:t,retryCount:r}=re(),[n,l]=s.useState(!1),[i,u]=s.useState(null);return{executeApiCall:s.useCallback(async(c,p={})=>{l(!0),u(null);const h=await e(c,{maxRetries:3,baseDelay:1e3,retryCondition:d=>d?.code==="NETWORK_ERROR"||d?.code==="TIMEOUT"||d?.status>=500&&d?.status<600||d?.status===429,onRetry:(d,y)=>{console.log(`Retry attempt ${d} for API call:`,y)},...p});return l(!1),h===null&&u(new Error("API call failed after retries")),h},[e]),isLoading:n||t,retryCount:r,error:i,clearError:()=>u(null)}}function ne(){const{handleError:e,handleSuccess:t}=P(),{executeApiCall:r}=ae(),[n,l]=s.useState([]),[i,u]=s.useState(""),[m,c]=s.useState("updated_at"),[p,h]=s.useState(!0),[d,y]=s.useState(!1),[w,C]=s.useState(null),x=Q(i,250);async function b(o){h(!0);try{const f=await r(()=>F(x,m));if(o?.aborted)return;f&&l(f)}catch(f){o?.aborted||e(f,"Загрузка заметок")}finally{o?.aborted||h(!1)}}s.useEffect(()=>{const o=new AbortController;return b(o.signal),()=>o.abort()},[m,x]);const k=s.useCallback(async(o,f)=>{try{if(f){const j=await O(f,o);l(E=>E.map(A=>A.id===f?j:A)),t("Заметка обновлена")}else{const j=await G(o);l(E=>[j,...E]),t("Заметка создана")}}catch(j){e(j,f?"Обновление заметки":"Создание заметки")}},[e,t]),g=s.useCallback(async o=>{try{await K(o),l(f=>f.filter(j=>j.id!==o)),t("Заметка удалена")}catch(f){e(f,"Удаление заметки")}},[e,t]),R=s.useCallback(async o=>{try{const f=await J(o.id,!o.pinned);l(j=>j.map(E=>E.id===o.id?f:E)),t(o.pinned?"Закрепление снято":"Заметка закреплена")}catch(f){e(f,"Изменение закрепления")}},[e,t]),v=!p&&n.length===0&&!i,N=s.useCallback(()=>{C(null),y(!0)},[]),S=s.useCallback(o=>{u(o.target.value)},[]),M=s.useCallback(o=>{c(o.target.value)},[]),D=s.useCallback(o=>{C(o),y(!0)},[]),$=s.useCallback(()=>{y(!1)},[]),W=s.useMemo(()=>4,[]);return a.jsxs("div",{className:"flex flex-col gap-4",children:[a.jsx("div",{className:"flex flex-wrap items-center justify-between gap-3",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Y,{variant:"primary",size:"sm",onClick:N,ariaLabel:L.ADD+" заметку",announceOnClick:"Открыто окно создания заметки",children:"+ Добавить заметку"}),a.jsx(V,{label:"Поиск заметок",placeholder:"Поиск по заголовку…",value:i,onChange:S,className:"w-64",ariaLabel:L.SEARCH+" заметок"}),a.jsxs("div",{className:"flex flex-col",children:[a.jsx("label",{htmlFor:"sort-select",className:"text-sm font-medium text-gray-700 mb-1",children:"Сортировка"}),a.jsxs("select",{id:"sort-select",className:"border rounded-lg px-3 py-2 text-sm",value:m,onChange:M,"aria-label":"Выберите способ сортировки заметок",children:[a.jsx("option",{value:"updated_at",children:"По обновлению"}),a.jsx("option",{value:"created_at",children:"По созданию"}),a.jsx("option",{value:"title",children:"По алфавиту"})]})]})]})}),a.jsx(U,{loading:p,empty:v,emptyMessage:"Пока нет заметок",loadingComponent:a.jsx(q,{count:6}),children:n.length>50?a.jsx(_,{items:n,columns:W,itemHeight:200,containerHeight:600,renderItem:(o,f)=>a.jsx(I,{note:o,onEdit:D,onDelete:g,onTogglePin:R},o.id),keyExtractor:o=>o.id,gap:16,className:"p-4"}):a.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4",children:n.map(o=>a.jsx(I,{note:o,onEdit:D,onDelete:g,onTogglePin:R},o.id))})}),a.jsx(B,{open:d,note:w,onClose:$,onSave:k,onDelete:g})]})}function me(){return a.jsx(z,{pageName:"Заметки",onError:(e,t)=>{console.error("Notes page error:",e,t)},children:a.jsx(ne,{})})}export{me as default};
