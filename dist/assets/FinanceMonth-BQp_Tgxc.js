import{j as a,s as f}from"./index-opaSS7ow.js";import{r as o}from"./vendor-CqGws4Uo.js";import{m as R}from"./dateUtils-BepG4-_g.js";import{f as x}from"./format-CfBjB5Ts.js";import{g as B,D as w}from"./auth-CvP6sRS5.js";import"./supabase-BmeMSZYH.js";function Z(){const[{start:j,end:N}]=o.useState(()=>R(w.TZ)),[m,q]=o.useState([]),[v,h]=o.useState(!0),[g,b]=o.useState(null),[D,y]=o.useState(""),M=o.useMemo(()=>new Intl.DateTimeFormat("ru-RU",{month:"long",year:"numeric"}).format(new Date),[]);o.useEffect(()=>{let t=!1;return(async()=>{h(!0),b(null);const e=w.finance,i=await B();async function S(){const r=[e.amount,e.type].filter(Boolean).join(",");let s=f.from(e.table).select(r);i&&(s=s.eq(e.userId,i)),s=s.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:l,error:n}=await s.limit(2e3);if(n)throw n;return l.map(d=>({amount:Number(d[e.amount]??0),type:String(d[e.type])}))}async function E(){const r=[e.amount,e.boolField].filter(Boolean).join(",");let s=f.from(e.table).select(r);i&&(s=s.eq(e.userId,i)),s=s.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:l,error:n}=await s.limit(2e3);if(n)throw n;return l.map(d=>({amount:Number(d[e.amount]??0),flag:!!d[e.boolField]}))}async function F(){let r=f.from(e.table).select(e.amount);i&&(r=r.eq(e.userId,i)),r=r.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:s,error:l}=await r.limit(2e3);if(l)throw l;return s.map(n=>({amount:Number(n[e.amount]??0)}))}try{let r=[];if(e.mode!=="type"){if(e.mode!=="bool"){if(e.mode!=="sign")try{r=await S(),y("type")}catch{r=await F(),y("sign")}}}t||q(r)}catch(r){t||b(r?.message||"Ошибка загрузки финансов")}finally{t||h(!1)}})(),()=>{t=!0}},[j,N]);let c=0,u=0;D==="type"?(c=m.filter(t=>t.type==="income").reduce((t,e)=>t+(e.amount||0),0),u=m.filter(t=>t.type==="expense").reduce((t,e)=>t+(e.amount||0),0)):(c=m.filter(t=>(t.amount??0)>=0).reduce((t,e)=>t+(e.amount||0),0),u=m.filter(t=>(t.amount??0)<0).reduce((t,e)=>t+Math.abs(e.amount||0),0));const p=c-u;return a.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h2",{className:"text-lg font-semibold tracking-[-0.01em]",children:["Финансы: ",M]}),a.jsx("a",{href:"/finance",className:"text-sm text-blue-600 hover:underline",children:"Открыть финансы"})]}),v?a.jsx("div",{className:"text-sm text-gray-500",children:"Загрузка…"}):g?a.jsxs("div",{className:"text-sm text-red-600",children:["Ошибка: ",g]}):a.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[a.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[a.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),a.jsx("div",{className:"text-xl font-semibold",children:x(c)})]}),a.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[a.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),a.jsx("div",{className:"text-xl font-semibold",children:x(u)})]}),a.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[a.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),a.jsx("div",{className:"text-xl font-semibold "+(p>=0?"text-emerald-600":"text-red-600"),children:x(p)})]})]})]})}export{Z as FinanceMonth};
