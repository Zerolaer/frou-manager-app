import{e as b,j as e,s as x,r as i}from"./index-CXPc7nnv.js";/* empty css           */import{E as L}from"./ellipsis-vertical-C7Vfn1iB.js";import O from"./GoalModal-CW9CknNV.js";import{M as P}from"./Modal-CCkwcyuC.js";import{u as D}from"./errorHandler-Dlfvmkcl.js";import{P as R,u as T}from"./useRetry-Bw3hRNem.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=b("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=b("CircleCheck",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=b("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);function H({onCreate:t,onOpenStats:s}){return e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Цели"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:t,children:"+ Добавить цель"}),e.jsx("button",{className:"btn-secondary",onClick:s,children:"Статистика"})]})]})}function I({goal:t,onEdit:s,onDelete:r,onComplete:c}){const n=Math.max(0,Math.min(100,t.progress??0)),u=n>=100?"bg-green-600":n>=66?"bg-blue-600":n>=33?"bg-amber-500":"bg-gray-300";return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"font-semibold text-gray-900 truncate",children:t.title}),t.description&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:t.description})]}),e.jsx("button",{className:"p-2 text-gray-500 hover:text-gray-900",onClick:()=>s(t),"aria-label":"Edit goal menu",children:e.jsx(L,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"w-full h-2 rounded bg-gray-100 overflow-hidden",children:e.jsx("div",{className:`h-full ${u}`,style:{width:`${n}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.deadline&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(V,{className:"w-4 h-4"}),e.jsx("span",{children:new Date(t.deadline).toLocaleDateString()})]}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-gray-100 text-gray-700",children:t.category??"Прочее"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.status!=="completed"&&e.jsxs("button",{className:"btn btn-sm",onClick:()=>c(t),children:[e.jsx($,{className:"w-4 h-4 mr-1"})," Завершить"]}),e.jsxs("button",{className:"btn-danger btn-sm",onClick:()=>r(t),children:[e.jsx(A,{className:"w-4 h-4 mr-1"})," Удалить"]})]})]})]})}function z({open:t,onClose:s,goals:r}){const c=r.length,n=r.filter(h=>h.status==="completed").length,u=c-n,f=Math.round(r.reduce((h,d)=>h+(d.progress??0),0)/Math.max(1,c));return e.jsxs(P,{open:t,onClose:s,title:"Статистика по целям",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Всего целей"}),e.jsx("div",{className:"text-2xl font-semibold",children:c})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Выполнено"}),e.jsx("div",{className:"text-2xl font-semibold",children:n})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"В процессе"}),e.jsx("div",{className:"text-2xl font-semibold",children:u})]})]}),e.jsxs("div",{className:"mt-6 bg-white border rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-2",children:"Средний прогресс"}),e.jsx("div",{className:"w-full h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded",style:{width:`${f}%`}})})]})]})}const p="goals";function B(t){const s=Number(t.target_amount??0),r=Number(t.current_amount??0);return s>0?Math.max(0,Math.min(100,r/s*100)):0}function y(t){const s=B(t);return{id:t.id,user_id:t.user_id,title:t.title,description:t.notes??null,progress:s,status:s>=100?"completed":"active",target_amount:t.target_amount??null,current_amount:t.current_amount??null,deadline:t.deadline??null,created_at:t.created_at,type:t.type??null}}async function Q(){const{data:t,error:s}=await x.from(p).select("*").order("created_at",{ascending:!1});if(s)throw s;return(t??[]).map(y)}async function W(t){const s=Math.max(0,Math.min(100,Math.round(t.progress??0))),r={title:t.title,notes:t.description??null,type:"checklist",target_amount:100,current_amount:s,deadline:t.deadline??null},{data:c,error:n}=await x.from(p).insert(r).select().single();if(n)throw n;return y(c)}async function F(t,s){const r={title:s.title,notes:s.description??null,deadline:s.deadline??null};typeof s.progress=="number"&&(r.current_amount=Math.max(0,Math.min(100,Math.round(s.progress))),r.target_amount=100);const{data:c,error:n}=await x.from(p).update(r).eq("id",t).select().single();if(n)throw n;return y(c)}async function J(t){const{error:s}=await x.from(p).delete().eq("id",t);if(s)throw s}async function K(t){const{data:s,error:r}=await x.from(p).update({current_amount:100,target_amount:100}).eq("id",t).select().single();if(r)throw r;return y(s)}function U(){const{handleError:t,handleSuccess:s}=D(),{executeApiCall:r}=T(),[c,n]=i.useState([]),[u,f]=i.useState(!0),[h,d]=i.useState(!1),[C,g]=i.useState(!1),[k,N]=i.useState(null),[j,M]=i.useState("");i.useEffect(()=>{(async()=>{try{f(!0);const a=await r(()=>Q());a&&n(a)}catch(a){t(a,"Загрузка целей")}finally{f(!1)}})()},[t,r]);const v=i.useMemo(()=>{const a=j.trim().toLowerCase();return a?c.filter(l=>(l.title+" "+(l.description??"")).toLowerCase().includes(a)):c},[c,j]),_=i.useCallback(()=>{N(null),d(!0)},[]),E=i.useCallback(a=>{N(a),d(!0)},[]);i.useCallback(()=>{g(!0)},[]),i.useCallback(()=>{g(!1)},[]),i.useCallback(()=>{d(!1)},[]);const G=async a=>{if(confirm("Удалить цель?"))try{await J(a.id),n(l=>l.filter(o=>o.id!==a.id)),s("Цель удалена")}catch(l){t(l,"Удаление цели")}},S=async a=>{try{const l=await K(a.id);n(o=>o.map(m=>m.id===a.id?l:m)),s("Цель завершена")}catch(l){t(l,"Завершение цели")}},q=async(a,l)=>{try{if(l){const o=await F(l,a);n(m=>m.map(w=>w.id===l?o:w)),s("Цель обновлена")}else{const o=await W(a);n(m=>[o,...m]),s("Цель создана")}d(!1)}catch(o){t(o,l?"Обновление цели":"Создание цели")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(H,{onCreate:_,onOpenStats:()=>g(!0)}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{className:"input w-full max-w-md",placeholder:"Поиск по целям…",value:j,onChange:a=>M(a.target.value)})}),u?e.jsx("div",{className:"text-gray-500",children:"Загрузка…"}):e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:[v.map(a=>e.jsx(I,{goal:a,onEdit:E,onDelete:G,onComplete:S},a.id)),v.length===0&&e.jsx("div",{className:"text-gray-500",children:"Ничего не найдено"})]}),e.jsx(O,{open:h,initial:k,onClose:()=>d(!1),onSave:q}),e.jsx(z,{open:C,onClose:()=>g(!1),goals:c})]})}function re(){return e.jsx(R,{pageName:"Цели",onError:(t,s)=>{console.error("Goals page error:",t,s)},children:e.jsx(U,{})})}export{re as default};
