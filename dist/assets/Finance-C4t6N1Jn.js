import{j as e,r as l,s as R,C as pe,F as W,M as ne,a as Ie,b as sn,c as Ae,d as an}from"./index-De27cj0q.js";/* empty css           *//* empty css                    */import{M as se}from"./Modal-C1HSv8SS.js";import{E as ln}from"./ellipsis-vertical-BRV6NfAz.js";import{f as cn}from"./format-CfBjB5Ts.js";import{u as rn}from"./errorHandler-B8Obt8fF.js";import{u as on}from"./useSupabaseAuth-DHGgAXve.js";function L({className:f=""}){return e.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${f}`})}function dn({rows:f=6}){return e.jsx("div",{className:"space-y-2",children:Array.from({length:f}).map((N,u)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx(L,{className:"h-6 col-span-3"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"}),e.jsx(L,{className:"h-6 col-span-1"})]},u))})}function un({open:f,onClose:N,userId:u,categoryId:m,categoryName:g,monthIndex:j,year:x,onApply:h}){const[c,v]=l.useState(!0),[t,b]=l.useState([]),[C,A]=l.useState(""),[M,T]=l.useState(""),P=l.useRef({}),G=(r,w,y=350)=>{clearTimeout(P.current[r]),P.current[r]=setTimeout(w,y)},J=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][j];l.useMemo(()=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"EUR"}),[]);const Q=l.useRef(null);l.useEffect(()=>{f&&(async()=>{v(!0);const{data:r,error:w}=await R.from("finance_entries").select("id, amount, note, included, position, created_at").eq("category_id",m).eq("year",x).eq("month",j+1).order("position",{ascending:!0}).order("created_at",{ascending:!0});if(w){console.error(w),v(!1);return}const y=(r||[]).map(S=>({id:S.id,amount:Number(S.amount)||0,note:S.note,included:!!S.included,position:S.position??0}));b(y),v(!1)})()},[f,m,j,x]);function F(r){return r.reduce((w,y)=>w+(y.included?y.amount:0),0)}async function ae(){const r=Number(String(C).replace(",","."));if(!u||isNaN(r))return;const w={user_id:u,category_id:m,year:x,month:j+1,amount:r,note:M,included:!0,position:t.length},{data:y,error:S}=await R.from("finance_entries").insert(w).select("id, amount, note, included, position").single();if(S){console.error(S);return}const _=[...t,{id:y.id,amount:Number(y.amount)||0,note:y.note,included:!!y.included,position:y.position??t.length}];b(_),A(""),T(""),h(F(_))}function Y(r,w){b(y=>{const S=y.map(_=>_.id===r?{..._,...w}:_);return h(F(S)),S})}function le(r,w){const y=Number(String(w).replace(",","."));Y(r,{amount:isNaN(y)?0:y}),G("amt:"+r,async()=>{const{error:S}=await R.from("finance_entries").update({amount:isNaN(y)?0:y}).eq("id",r);S&&console.error(S)})}function ce(r,w){Y(r,{note:w}),G("note:"+r,async()=>{const{error:y}=await R.from("finance_entries").update({note:w}).eq("id",r);y&&console.error(y)})}async function $(r,w){Y(r,{included:w});const{error:y}=await R.from("finance_entries").update({included:w}).eq("id",r);y&&console.error(y)}async function U(r){const{error:w}=await R.from("finance_entries").delete().eq("id",r);if(w){console.error(w);return}const y=t.filter(S=>S.id!==r);y.forEach((S,_)=>{S.position=_}),b(y),h(F(y)),await Promise.all(y.map((S,_)=>R.from("finance_entries").update({position:_}).eq("id",S.id)))}function ie(r){Q.current=r}function Z(r){r.preventDefault()}async function z(r){const w=Q.current;if(Q.current=null,!w||w===r)return;const y=t.findIndex(B=>B.id===w),S=t.findIndex(B=>B.id===r);if(y<0||S<0)return;const _=t.slice(),[ue]=_.splice(y,1);_.splice(S,0,ue),_.forEach((B,D)=>{B.position=D}),b(_),h(F(_)),await Promise.all(_.map((B,D)=>R.from("finance_entries").update({position:D}).eq("id",B.id)))}return e.jsx(se,{open:f,onClose:N,title:e.jsxs("span",{bodyClassName:"p-0",children:[e.jsx("b",{children:g})," · ",J," ",x]}),footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn btn-outline",onClick:N,children:"Закрыть"})}),size:"md",children:e.jsxs("div",{className:"editor-body",children:[c&&e.jsx("div",{className:"loading-overlay",children:"Загрузка…"}),e.jsxs("div",{className:"editor-add",children:[e.jsx("input",{type:"number",placeholder:"Сумма (€)",value:C,onChange:r=>A(r.target.value),className:"editor-input number"}),e.jsx("input",{placeholder:"Описание (необязательно)",value:M,onChange:r=>T(r.target.value),className:"editor-input text"}),e.jsx("button",{className:"btn btn-outline",onClick:ae,children:"Добавить"})]}),e.jsxs("div",{children:[t.map(r=>e.jsxs("div",{className:"entry-row "+(r.included?"":"entry-disabled"),draggable:!0,onDragStart:()=>ie(r.id),onDragOver:Z,onDrop:()=>z(r.id),children:[e.jsx("div",{className:"entry-drag",children:"⋮⋮"}),e.jsxs("label",{className:"chk",children:[e.jsx("input",{type:"checkbox",checked:r.included,onChange:w=>$(r.id,w.target.checked)}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",children:e.jsx("path",{fill:"currentColor",d:"M8.143 13.314 4.829 10l-1.18 1.18 4.494 4.494 8-8-1.18-1.18z"})})})]}),e.jsx("input",{type:"number",className:"editor-input entry-amount",value:String(r.amount),onChange:w=>le(r.id,w.target.value)}),e.jsx("input",{className:"editor-input entry-note",value:r.note||"",onChange:w=>ce(r.id,w.target.value)}),e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>U(r.id),children:"Удалить"})]},r.id)),!c&&t.length===0&&e.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"Ещё нет записей."})]})]})})}function mn({value:f,onChange:N,fullWidth:u}){const[m,g]=l.useState(!1),j=l.useRef(null);l.useEffect(()=>{const h=c=>{j.current&&(j.current.contains(c.target)||g(!1))};return document.addEventListener("mousedown",h),()=>document.removeEventListener("mousedown",h)},[]);const x=f==="income"?"Доходы":"Расходы";return e.jsxs("div",{ref:j,className:`dd-wrap ${u?"block":""}`,children:[e.jsxs("button",{type:"button",className:`btn btn-outline dd-btn ${u?"full":""}`,style:{justifyContent:"flex-start"},onClick:()=>g(h=>!h),children:[e.jsx("span",{style:{pointerEvents:"none"},children:x}),e.jsx("span",{style:{marginLeft:"auto",opacity:.7},children:"▾"})]}),m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dd-backdrop",onClick:()=>g(!1)}),e.jsxs("div",{className:`dd-menu ${u?"full":""}`,children:[e.jsx("div",{className:`dd-item ${f==="income"?"dd-active":""}`,onClick:()=>{N("income"),g(!1)},children:"Доходы"}),e.jsx("div",{className:`dd-item ${f==="expense"?"dd-active":""}`,onClick:()=>{N("expense"),g(!1)},children:"Расходы"})]})]})]})}const De=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function fn({open:f,onClose:N,year:u,incomeByMonth:m,expenseByMonth:g}){const j=m.reduce((v,t)=>v+t,0),x=g.reduce((v,t)=>v+t,0),h=j-x,c=Math.max(...m,...g,1);return e.jsxs(se,{open:f,onClose:N,title:`Годовая статистика — ${u}`,size:"lg",footer:e.jsx("button",{className:"btn btn-outline",onClick:N,children:"Закрыть"}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-lg font-semibold",children:j})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-lg font-semibold",children:x})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-lg font-semibold",children:h})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Доходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:m.map((v,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:De[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${v/c*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:v})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Расходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:g.map((v,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:De[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-red-500",style:{width:`${v/c*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:v})]},t))})]})]})]})}function xn({value:f,years:N,onChange:u}){const[m,g]=l.useState(!1),j=l.useRef(null);return l.useEffect(()=>{function x(h){m&&h.key==="Escape"&&g(!1)}return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[m]),e.jsxs("div",{className:"dd-wrap",children:[e.jsx("button",{ref:j,className:"btn btn-outline dd-btn",onClick:()=>g(x=>!x),children:f}),m&&e.jsx("div",{className:"dd-backdrop",onClick:()=>g(!1)}),m&&e.jsx("div",{className:"dd-menu",children:N.map(x=>e.jsx("div",{className:"dd-item "+(x===f?"dd-active":""),onClick:()=>{u(x),g(!1)},children:x},x))})]})}function pn({year:f,years:N,onYearChange:u,onAddCategory:m,onShowStats:g}){return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(xn,{value:f,years:N,onChange:u})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{className:"btn",onClick:m,children:"Добавить категорию"}),e.jsx("button",{className:"btn btn-outline text-gray-900",onClick:g,children:"Годовая статистика"})]})]})}function Oe({title:f,onAdd:N}){return e.jsxs("div",{className:"finance-section",children:[e.jsx("span",{children:f}),e.jsx("button",{className:"btn btn-outline btn-xs text-gray-900",onClick:N,children:"+ Категория"})]})}function Re({type:f,row:N,values:u,isCurrentYear:m,currentMonth:g,hasChildren:j,collapsed:x,onToggleCollapse:h,onNameContext:c,onCellContext:v,onCellEdit:t,fmt:b,ctxCatHighlight:C,ctxCellHighlight:A}){const M={id:N.id,name:N.name,type:f};return e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell "+(C===N.id?"ctx-active":""),children:e.jsxs("div",{className:"cell-head cell-name flex items-center gap-2",children:[e.jsx("button",{className:"shrink-0 rounded-md hover:bg-gray-100 w-6 h-6 flex items-center justify-center",onClick:()=>h(N.id),title:j?x?"Развернуть":"Свернуть":"Категория",children:j?x?"▸":"▾":""}),e.jsx("span",{className:"flex-1 truncate",children:N.name}),e.jsx("button",{className:"icon-btn menu-btn",onClick:T=>c(T,M),onContextMenu:T=>c(T,M),"aria-label":"Действия с категорией",children:e.jsx(ln,{size:16})})]})}),u.map((T,P)=>e.jsx("div",{className:"finance-cell "+(m&&P===g?"col-current ":"")+(A&&A.type===f&&A.catId===N.id&&A.month===P?"ctx-active":""),onContextMenu:G=>v(G,f,N.id,P,T),children:e.jsx("button",{className:"cell-btn",onClick:()=>t(f,N.id,P),children:b(T)})},P))]})}function hn({pos:f,onClose:N,onRename:u,onAddSub:m,onDelete:g,canAddSub:j=!0}){const x=l.useRef([]),[h,c]=l.useState(0);return l.useEffect(()=>{const v=t=>{var b;t.key==="Escape"&&(t.preventDefault(),N()),t.key==="ArrowDown"&&(t.preventDefault(),c(C=>Math.min(C+1,x.current.length-1))),t.key==="ArrowUp"&&(t.preventDefault(),c(C=>Math.max(C-1,0))),(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),(b=x.current[h])==null||b.click())};return document.addEventListener("keydown",v),()=>document.removeEventListener("keydown",v)},[h,N]),l.useEffect(()=>{var v;(v=x.current[0])==null||v.focus()},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:v=>v.preventDefault(),"aria-hidden":!0}),e.jsxs("div",{className:"ctx-menu",style:{left:f.x,top:f.y},role:"menu","aria-label":"Действия с категорией",onContextMenu:v=>v.preventDefault(),children:[e.jsx("div",{ref:v=>x.current[0]=v,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:u,"aria-label":"Переименовать категорию","data-active":h===0,children:"Переименовать"}),j&&e.jsx("div",{ref:v=>x.current[1]=v,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:m,"aria-label":"Добавить подкатегорию","data-active":h===1,children:"+ Подкатегория"}),e.jsx("div",{ref:v=>x.current[2]=v,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:g,"aria-label":"Удалить категорию","data-active":h===2,style:{color:"#b91c1c"},children:"Удалить"})]})]})}function Nn({pos:f,onClose:N,canCopy:u,hasClipboard:m,onCopy:g,onPaste:j}){const x=l.useMemo(()=>{const t=[];return u&&t.push({label:"Копировать записи",onClick:g,aria:"Копировать записи"}),m&&t.push({label:"Вставить записи (заменить)",onClick:j,aria:"Вставить записи (заменить)"}),t},[u,m,g,j]),h=l.useRef([]),[c,v]=l.useState(0);return l.useEffect(()=>{const t=b=>{var C;b.key==="Escape"&&(b.preventDefault(),N()),b.key==="ArrowDown"&&(b.preventDefault(),v(A=>Math.min(A+1,x.length-1))),b.key==="ArrowUp"&&(b.preventDefault(),v(A=>Math.max(A-1,0))),(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),(C=h.current[c])==null||C.click())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[c,N,x.length]),l.useEffect(()=>{var t;(t=h.current[0])==null||t.focus()},[x.length]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:t=>t.preventDefault(),"aria-hidden":!0}),e.jsx("div",{className:"ctx-menu",style:{left:f.x,top:f.y},role:"menu","aria-label":"Действия с ячейкой",onContextMenu:t=>t.preventDefault(),children:x.map((t,b)=>e.jsx("div",{ref:C=>h.current[b]=C,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:t.onClick,"aria-label":t.aria,"data-active":c===b,children:t.label},b))})]})}function Te(f,N,u,m){const j=window.innerWidth,x=window.innerHeight;let h=f,c=N;return h+u+8>j&&(h=Math.max(8,j-u-8)),c+m+8>x&&(c=Math.max(8,x-m-8)),h<8&&(h=8),c<8&&(c=8),{x:h,y:c}}function Fe(f){var h;const u={},m={};for(const c of f)u[c.id]=c,c.parent_id&&(m[h=c.parent_id]||(m[h]=[])).push(c.id);const g={};function j(c){var t;if(!m[c])return Array(12).fill(0);if(g[c])return g[c].slice();const v=Array(12).fill(0);for(const b of m[c]){const C=u[b];if(C)for(let M=0;M<12;M++)v[M]+=((t=C.values)==null?void 0:t[M])??0;const A=j(b);for(let M=0;M<12;M++)v[M]+=A[M]||0}return g[c]=v.slice(),v}const x={};for(const c of Object.keys(m))x[c]=j(c);return x}const Le=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function vn(){const f=l.useCallback((m,g,j)=>{try{localStorage.setItem(pe.FINANCE(m,g),JSON.stringify(j))}catch(x){console.warn("Failed to write finance cache:",x)}},[]),N=l.useCallback((m,g)=>{try{const j=localStorage.getItem(pe.FINANCE(m,g));return j?JSON.parse(j):null}catch(j){return console.warn("Failed to read finance cache:",j),null}},[]),u=l.useCallback((m,g)=>{try{localStorage.removeItem(pe.FINANCE(m,g))}catch(j){console.warn("Failed to clear finance cache:",j)}},[]);return{writeCache:f,readCache:N,clearCache:u}}function Pe(f,N){return N.find(u=>u.id===f)}const te=f=>cn(f);function _n(){var Me;const{handleError:f,handleSuccess:N}=rn(),{userId:u}=on(),{writeCache:m,readCache:g}=vn(),j=new Date,x=j.getFullYear(),h=j.getMonth(),[c,v]=l.useState(x),[t,b]=l.useState([]),[C,A]=l.useState([]),[M,T]=l.useState({}),P=l.useMemo(()=>Se(t,M),[t,M]),G=l.useMemo(()=>Se(C,M),[C,M]),[he,J]=l.useState(!0),[Q,F]=l.useState(!1),[ae,Y]=l.useState(W.INCOME),[le,ce]=l.useState(""),[$,U]=l.useState(null),[ie,Z]=l.useState(!1),[z,r]=l.useState(null),[w,y]=l.useState(0),[S,_]=l.useState(!1),[ue,B]=l.useState({x:0,y:0}),[D,Ne]=l.useState(null),[me,q]=l.useState(!1),[Ye,qe]=l.useState({x:0,y:0}),[fe,He]=l.useState(null),[K,$e]=l.useState(null),[Ue,ve]=l.useState(!1),[Be,Xe]=l.useState(null),[We,je]=l.useState(!1),[ze,ee]=l.useState(!1),[ge,ye]=l.useState(""),[Ke,re]=l.useState(!1),[be,X]=l.useState(null),[Ce,H]=l.useState(null);l.useEffect(()=>{if(!u)return;const n=g(u,c);n?(b(n.income??[]),A(n.expense??[]),J(!1)):J(!0),(async()=>{const[a,d]=await Promise.all([R.from("finance_categories").select("id,name,type,parent_id").order("created_at",{ascending:!0}),R.from("finance_entries").select("category_id,month,amount,included").eq("year",c)]);if(a.error||d.error){f(a.error||d.error,"Загрузка финансовых данных"),J(!1);return}const s=a.data||[],i=d.data||[],o={};for(const p of s)o[p.id]=Array(ne).fill(0);for(const p of i){if(!p.included)continue;const O=Math.min(11,Math.max(0,p.month-1)),I=p.category_id;o[I]||(o[I]=Array(ne).fill(0)),o[I][O]+=Number(p.amount)||0}const E=s.filter(p=>p.type===W.INCOME).map(p=>({id:p.id,name:p.name,parent_id:p.parent_id,values:o[p.id]||Array(ne).fill(0)})),k=s.filter(p=>p.type===W.EXPENSE).map(p=>({id:p.id,name:p.name,parent_id:p.parent_id,values:o[p.id]||Array(ne).fill(0)}));b(E),A(k),J(!1),m(u,c,{income:E.map(({id:p,name:O,values:I,parent_id:xe})=>({id:p,name:O,values:I,parent_id:xe})),expense:k.map(({id:p,name:O,values:I,parent_id:xe})=>({id:p,name:O,values:I,parent_id:xe}))})})()},[u,c]);const oe=l.useMemo(()=>Le.map((n,a)=>t.reduce((d,s)=>{var i;return d+(((i=s.values)==null?void 0:i[a])??0)},0)),[t]),de=l.useMemo(()=>Le.map((n,a)=>C.reduce((d,s)=>{var i;return d+(((i=s.values)==null?void 0:i[a])??0)},0)),[C]),Ve=l.useMemo(()=>oe.map((n,a)=>n-de[a]),[oe,de]);l.useMemo(()=>{const n={};return t.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[t]),l.useMemo(()=>{const n={};return C.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[C]);const we=l.useMemo(()=>Fe(t),[t]),Ee=l.useMemo(()=>Fe(C),[C]);function Se(n,a){const d=n.filter(o=>!o.parent_id),s={};n.forEach(o=>{var E;o.parent_id&&(s[E=o.parent_id]||(s[E]=[])).push(o)});const i=[];return d.forEach(o=>{i.push(o),a[o.id]||(s[o.id]||[]).forEach(E=>i.push(E))}),n.filter(o=>o.parent_id&&!d.find(E=>E.id===o.parent_id)).forEach(o=>i.push(o)),i}async function Ge(){const n=le.trim();if(!n||!u)return;const a=ae,d={user_id:u,type:a,name:n};$&&(d.parent_id=$.id);const{data:s,error:i}=await R.from("finance_categories").insert(d).select("id,name,type,parent_id").single();if(i){f(i,"Создание категории");return}const o={id:s.id,name:s.name,type:s.type,parent_id:s.parent_id,values:Array(ne).fill(0)};if(a===W.INCOME){const E=[t,o];b(E),m(u,c,{income:E.map(({id:k,name:p,values:O,parent_id:I})=>({id:k,name:p,values:O,parent_id:I})),expense:C.map(({id:k,name:p,values:O,parent_id:I})=>({id:k,name:p,values:O,parent_id:I}))})}else{const E=[C,o];A(E),m(u,c,{income:t.map(({id:k,name:p,values:O,parent_id:I})=>({id:k,name:p,values:O,parent_id:I})),expense:E.map(({id:k,name:p,values:O,parent_id:I})=>({id:k,name:p,values:O,parent_id:I}))})}N(`Категория "${n}" создана`),F(!1),ce(""),Y(W.INCOME),U(null)}function _e(n,a){n.preventDefault(),n.stopPropagation(),me&&q(!1),H(null),X(a.id);const d=Te(n.clientX,n.clientY,Ae,sn);B({x:d.x,y:d.y}),Ne(a),_(!0)}function Je(){_(!1),Ne(null),X(null)}async function Qe(){const n=ge.trim();if(!n||!D){ee(!1);return}const{error:a}=await R.from("finance_categories").update({name:n}).eq("id",D.id);if(a){f(a,"Создание категории");return}if(D.type==="income"){const d=t.map(s=>s.id===D.id?{...s,name:n}:s);b(d),m(u,c,{income:d.map(({id:s,name:i,values:o,parent_id:E})=>({id:s,name:i,values:o,parent_id:E})),expense:C.map(({id:s,name:i,values:o,parent_id:E})=>({id:s,name:i,values:o,parent_id:E}))})}else{const d=C.map(s=>s.id===D.id?{...s,name:n}:s);A(d),m(u,c,{income:t.map(({id:s,name:i,values:o,parent_id:E})=>({id:s,name:i,values:o,parent_id:E})),expense:d.map(({id:s,name:i,values:o,parent_id:E})=>({id:s,name:i,values:o,parent_id:E}))})}ee(!1)}async function Ze(){if(!D)return;const{error:n}=await R.from("finance_categories").delete().eq("id",D.id);if(n){f(n,"Создание категории");return}if(D.type==="income"){const a=t.filter(d=>d.id!==D.id);b(a),m(u,c,{income:a.map(({id:d,name:s,values:i,parent_id:o})=>({id:d,name:s,values:i,parent_id:o})),expense:C.map(({id:d,name:s,values:i,parent_id:o})=>({id:d,name:s,values:i,parent_id:o}))})}else{const a=C.filter(d=>d.id!==D.id);A(a),m(u,c,{income:t.map(({id:d,name:s,values:i,parent_id:o})=>({id:d,name:s,values:i,parent_id:o})),expense:a.map(({id:d,name:s,values:i,parent_id:o})=>({id:d,name:s,values:i,parent_id:o}))})}re(!1)}async function ke(n,a,d,s,i){n.preventDefault(),n.stopPropagation(),S&&_(!1),me&&q(!1),X(null),H({type:a,catId:d,month:s});const o={category_id:d,year:c,month:s+1},E=!!K&&K.length>0;if(!E&&(!i||i===0)){H(null);return}const k=Te(n.clientX,n.clientY,Ae,an);He({catId:d,type:a,month:s}),qe({x:k.x,y:k.y}),ve(!1),q(!0);const{data:p}=await R.from("finance_entries").select("amount, note, included, position").match(o).order("position",{ascending:!0}).order("created_at",{ascending:!0}),O=(p||[]).map(I=>({amount:Number(I.amount)||0,note:I.note,included:!!I.included,position:I.position??0}));if(Xe(O),!O.length&&!E){q(!1),H(null);return}ve(O.length>0)}async function en(){const n=Be||[];if(!n.length){q(!1),H(null);return}$e(n.slice());try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{}q(!1),H(null)}async function nn(){if(!fe||!K||!K.length||!u)return;const{catId:n,type:a,month:d}=fe,s={category_id:n,year:c,month:d+1};await R.from("finance_entries").delete().match(s);const i=K.map((k,p)=>({where:s,user_id:u,amount:k.amount,note:k.note,included:k.included,position:p}));await R.from("finance_entries").insert(i);const o=i.filter(k=>k.included).reduce((k,p)=>k+(p.amount||0),0),E=k=>k.map(p=>p.id===n?{...p,values:p.values.map((O,I)=>I===d?o:O)}:p);a==="income"?b(E(t)):A(E(C)),q(!1),H(null)}if(l.useEffect(()=>{const n=d=>{d.key==="Escape"&&(_(!1),q(!1),X(null),H(null))},a=()=>{_(!1),q(!1),X(null),H(null)};return window.addEventListener("keydown",n),window.addEventListener("wheel",a,{passive:!0}),()=>{window.removeEventListener("keydown",n),window.removeEventListener("wheel",a)}},[]),he)return e.jsx("div",{className:"p-4",children:e.jsx(dn,{rows:10})});const V=c===x,tn=Array.from({length:7}).map((n,a)=>x-3+a);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6 finance-page",onContextMenu:n=>{n.preventDefault()},children:[e.jsx(pn,{year:c,years:tn,onYearChange:v,onAddCategory:()=>{Y(W.INCOME),U(null),F(!0)},onShowStats:()=>je(!0)}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Категория"})}),Ie.map((n,a)=>e.jsx("div",{className:"finance-cell "+(V&&a===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",c]})},n)),e.jsx(Oe,{title:"Доходы",onAdd:()=>{Y(W.INCOME),U(null),F(!0)}}),P.map(n=>{const a=!!we[n.id],d=a?we[n.id]:n.values;return e.jsx(Re,{type:"income",row:n,values:d,isCurrentYear:V,currentMonth:h,hasChildren:a,collapsed:!!M[n.id],onToggleCollapse:s=>T(i=>({...i,[s]:!i[s]})),onNameContext:(s,i)=>_e(s,i),onCellContext:ke,onCellEdit:(s,i,o)=>{r({id:i,name:n.name,type:s}),y(o),Z(!0)},fmt:te,ctxCatHighlight:be,ctxCellHighlight:Ce})}),e.jsx(Oe,{title:"Расходы",onAdd:()=>{Y(W.EXPENSE),U(null),F(!0)}}),G.map(n=>{const a=!!Ee[n.id],d=a?Ee[n.id]:n.values;return e.jsx(Re,{type:"expense",row:n,values:d,isCurrentYear:V,currentMonth:h,hasChildren:a,collapsed:!!M[n.id],onToggleCollapse:s=>T(i=>({...i,[s]:!i[s]})),onNameContext:(s,i)=>_e(s,i),onCellContext:ke,onCellEdit:(s,i,o)=>{r({id:i,name:n.name,type:s}),y(o),Z(!0)},fmt:te,ctxCatHighlight:be,ctxCellHighlight:Ce})})]}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Показатель"})}),Ie.map((n,a)=>e.jsx("div",{className:"finance-cell "+(V&&a===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",c]})},n)),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Доходы"})}),oe.map((n,a)=>e.jsx("div",{className:"finance-cell "+(V&&a===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:te(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Расходы"})}),de.map((n,a)=>e.jsx("div",{className:"finance-cell "+(V&&a===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:te(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:700},children:"Баланс"})}),Ve.map((n,a)=>e.jsx("div",{className:"finance-cell "+(V&&a===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",style:{fontWeight:700},children:te(n)})},a))]})]})]}),S&&D&&e.jsx(hn,{pos:ue,canAddSub:!((Me=Pe(D.id,t)||Pe(D.id,C))!=null&&Me.parent_id),onClose:Je,onRename:()=>{ye(D.name),ee(!0),_(!1),X(null)},onAddSub:()=>{Y(D.type),U({id:D.id,name:D.name}),F(!0),_(!1),X(null)},onDelete:()=>{re(!0),_(!1),X(null)}}),me&&fe&&e.jsx(Nn,{pos:Ye,onClose:()=>{q(!1),H(null)},canCopy:Ue,hasClipboard:!!(K&&K.length>0),onCopy:en,onPaste:nn}),e.jsxs(se,{open:Q,onClose:()=>{F(!1),U(null)},title:$?"Новая подкатегория":"Новая категория",subTitle:$?`Родитель: ${$.name}`:void 0,footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline text-gray-900",onClick:()=>{F(!1),U(null)},children:"Отмена"}),e.jsx("button",{className:"btn",onClick:Ge,children:$?"Добавить подкатегорию":"Добавить категорию"})]}),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Тип"}),e.jsx("div",{className:"flex-1",children:e.jsx(mn,{value:ae,onChange:Y,fullWidth:!0})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Название"}),e.jsx("input",{value:le,onChange:n=>ce(n.target.value),placeholder:$?"Напр. Коммунальные":"Напр. Жильё",className:"border rounded-lg px-3 py-2 text-sm flex-1"})]})]}),e.jsx(se,{open:ze,onClose:()=>ee(!1),title:"Переименовать категорию",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline text-gray-900",onClick:()=>ee(!1),children:"Отмена"}),e.jsx("button",{className:"btn",onClick:Qe,children:"Сохранить"})]}),children:e.jsx("input",{value:ge,onChange:n=>ye(n.target.value),className:"border rounded-lg px-3 py-2 text-sm w-full",autoFocus:!0})}),e.jsx(se,{open:Ke,onClose:()=>re(!1),title:"Удалить категорию?",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline text-gray-900",onClick:()=>re(!1),children:"Отмена"}),e.jsx("button",{className:"btn btn-danger",onClick:Ze,children:"Удалить"})]}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Все записи в этой категории будут удалены без возможности восстановления."})}),ie&&z&&e.jsx(un,{open:ie,onClose:()=>Z(!1),userId:u,categoryId:z.id,categoryName:z.name,monthIndex:w,year:c,onApply:n=>{const a=d=>d.map(s=>s.id===z.id?{...s,values:s.values.map((i,o)=>o===w?n:i)}:s);z.type==="income"?b(a(t)):A(a(C))}}),e.jsx(fn,{open:We,onClose:()=>je(!1),year:c,incomeByMonth:oe,expenseByMonth:de})]})}export{_n as default};
