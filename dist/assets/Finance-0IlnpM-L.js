import{j as e,s as T}from"./index-Cxov-ftt.js";import{r as l,R as on}from"./vendor-CqGws4Uo.js";import{M as dn,U as pe,a as un,b as mn,u as fn}from"./ModalSystem-CstZ7D6m.js";import{P as be,a as xn,T as pn,b as hn,c as Nn,d as vn,E as gn}from"./icons-BC5Gm12n.js";import{f as jn}from"./format-CfBjB5Ts.js";import{u as yn}from"./errorHandler-B1EiTr4F.js";import{u as Cn}from"./useSupabaseAuth-tUhxvpUR.js";import{C as Ce,F as K,M as ie,a as Pe,b as bn,c as wn}from"./constants-9eM6lQSR.js";import"./supabase-BmeMSZYH.js";function F({className:u=""}){return e.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${u}`})}function En({rows:u=6}){return e.jsx("div",{className:"space-y-2",children:Array.from({length:u}).map((N,m)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx(F,{className:"h-6 col-span-3"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"})]},m))})}function Sn({open:u,onClose:N,userId:m,categoryId:x,categoryName:g,monthIndex:j,year:h,onApply:f}){const[S,p]=l.useState(!0),[t,w]=l.useState([]),[v,P]=l.useState(""),[I,A]=l.useState(""),O=l.useRef(null),X=l.useRef({}),re=(c,C,y=350)=>{clearTimeout(X.current[c]),X.current[c]=setTimeout(C,y)},he=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][j];l.useMemo(()=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"EUR"}),[]);const W=l.useRef(null);l.useEffect(()=>{u&&(async()=>{p(!0);const{data:c,error:C}=await T.from("finance_entries").select("id, amount, note, included, position, created_at").eq("category_id",x).eq("year",h).eq("month",j+1).order("position",{ascending:!0}).order("created_at",{ascending:!0});if(C){console.error(C),p(!1);return}const y=(c||[]).map(k=>({id:k.id,amount:Number(k.amount)||0,note:k.note,included:!!k.included,position:k.position??0}));w(y),p(!1)})()},[u,x,j,h]),l.useEffect(()=>{u&&O.current&&setTimeout(()=>{O.current?.focus()},100)},[u]);function Z(c){return c.reduce((C,y)=>C+(y.included?y.amount:0),0)}async function L(){const c=Number(String(v).replace(",","."));if(!m||isNaN(c))return;const C={user_id:m,category_id:x,year:h,month:j+1,amount:c,note:I,included:!0,position:t.length},{data:y,error:k}=await T.from("finance_entries").insert(C).select("id, amount, note, included, position").single();if(k){console.error(k);return}const _=[...t,{id:y.id,amount:Number(y.amount)||0,note:y.note,included:!!y.included,position:y.position??t.length}];w(_),P(""),A(""),f(Z(_)),setTimeout(()=>{O.current?.focus()},50)}function te(c){c.key==="Enter"&&(c.preventDefault(),L())}function Y(c,C){w(y=>{const k=y.map(_=>_.id===c?{..._,...C}:_);return f(Z(k)),k})}function se(c,C){const y=Number(String(C).replace(",","."));Y(c,{amount:isNaN(y)?0:y}),re("amt:"+c,async()=>{const{error:k}=await T.from("finance_entries").update({amount:isNaN(y)?0:y}).eq("id",c);k&&console.error(k)})}function oe(c,C){Y(c,{note:C}),re("note:"+c,async()=>{const{error:y}=await T.from("finance_entries").update({note:C}).eq("id",c);y&&console.error(y)})}async function $(c,C){Y(c,{included:C});const{error:y}=await T.from("finance_entries").update({included:C}).eq("id",c);y&&console.error(y)}async function U(c){const{error:C}=await T.from("finance_entries").delete().eq("id",c);if(C){console.error(C);return}const y=t.filter(k=>k.id!==c);y.forEach((k,_)=>{k.position=_}),w(y),f(Z(y)),await Promise.all(y.map((k,_)=>T.from("finance_entries").update({position:_}).eq("id",k.id)))}function de(c){W.current=c}function ae(c){c.preventDefault()}async function V(c){const C=W.current;if(W.current=null,!C||C===c)return;const y=t.findIndex(z=>z.id===C),k=t.findIndex(z=>z.id===c);if(y<0||k<0)return;const _=t.slice(),[Ne]=_.splice(y,1);_.splice(k,0,Ne),_.forEach((z,D)=>{z.position=D}),w(_),f(Z(_)),await Promise.all(_.map((z,D)=>T.from("finance_entries").update({position:D}).eq("id",z.id)))}return e.jsx(dn,{open:u,onClose:N,title:e.jsxs("span",{bodyClassName:"p-0",children:[e.jsx("b",{children:g})," · ",he," ",h]}),footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn btn-outline",onClick:N,children:"Закрыть"})}),size:"md",children:e.jsxs("div",{className:"editor-body",children:[S&&e.jsx("div",{className:"loading-overlay",children:"Загрузка…"}),e.jsxs("div",{className:"editor-add",children:[e.jsx("input",{ref:O,type:"number",placeholder:"Сумма (€)",value:v,onChange:c=>P(c.target.value),onKeyPress:te,className:"editor-input number"}),e.jsx("input",{placeholder:"Описание (необязательно)",value:I,onChange:c=>A(c.target.value),onKeyPress:te,className:"editor-input text"}),e.jsxs("button",{className:"btn btn-outline flex items-center gap-2",onClick:L,children:[e.jsx(be,{className:"w-4 h-4"}),"Добавить"]})]}),e.jsxs("div",{children:[t.map(c=>e.jsxs("div",{className:"entry-row "+(c.included?"":"entry-disabled"),draggable:!0,onDragStart:()=>de(c.id),onDragOver:ae,onDrop:()=>V(c.id),children:[e.jsx("div",{className:"entry-drag",children:e.jsx(xn,{className:"w-4 h-4"})}),e.jsxs("label",{className:"chk",children:[e.jsx("input",{type:"checkbox",checked:c.included,onChange:C=>$(c.id,C.target.checked)}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",children:e.jsx("path",{fill:"currentColor",d:"M8.143 13.314 4.829 10l-1.18 1.18 4.494 4.494 8-8-1.18-1.18z"})})})]}),e.jsx("input",{type:"number",className:"editor-input entry-amount",value:String(c.amount),onChange:C=>se(c.id,C.target.value)}),e.jsx("input",{className:"editor-input entry-note",value:c.note||"",onChange:C=>oe(c.id,C.target.value)}),e.jsxs("button",{className:"btn btn-danger btn-sm flex items-center gap-1",onClick:()=>U(c.id),children:[e.jsx(pn,{className:"w-4 h-4"}),"Удалить"]})]},c.id)),!S&&t.length===0&&e.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"Ещё нет записей."})]})]})})}function kn({value:u,onChange:N,fullWidth:m}){const[x,g]=l.useState(!1),j=l.useRef(null);l.useEffect(()=>{const f=S=>{j.current&&(j.current.contains(S.target)||g(!1))};return document.addEventListener("mousedown",f),()=>document.removeEventListener("mousedown",f)},[]);const h=u==="income"?"Доходы":"Расходы";return e.jsxs("div",{ref:j,className:`dd-wrap ${m?"block":""}`,children:[e.jsxs("button",{type:"button",className:`btn btn-outline dd-btn ${m?"full":""}`,style:{justifyContent:"flex-start"},onClick:()=>g(f=>!f),children:[e.jsx("span",{style:{pointerEvents:"none"},children:h}),e.jsx("span",{style:{marginLeft:"auto",opacity:.7},children:"▾"})]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dd-backdrop",onClick:()=>g(!1)}),e.jsxs("div",{className:`dd-menu ${m?"full":""}`,children:[e.jsx("div",{className:`dd-item ${u==="income"?"dd-active":""}`,onClick:()=>{N("income"),g(!1)},children:"Доходы"}),e.jsx("div",{className:`dd-item ${u==="expense"?"dd-active":""}`,onClick:()=>{N("expense"),g(!1)},children:"Расходы"})]})]})]})}const Fe=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function _n({open:u,onClose:N,year:m,incomeByMonth:x,expenseByMonth:g}){const j=x.reduce((p,t)=>p+t,0),h=g.reduce((p,t)=>p+t,0),f=j-h,S=Math.max(...x,...g,1);return e.jsxs(pe,{open:u,onClose:N,title:`Годовая статистика — ${m}`,size:"lg",footer:e.jsx(un,{right:e.jsx(mn,{variant:"secondary",onClick:N,children:"Закрыть"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-lg font-semibold",children:j})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-lg font-semibold",children:h})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-lg font-semibold",children:f})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Доходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:x.map((p,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Fe[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${p/S*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:p})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Расходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:g.map((p,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Fe[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-red-500",style:{width:`${p/S*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:p})]},t))})]})]})]})}function Mn({value:u,years:N,onChange:m}){const[x,g]=l.useState(!1),j=l.useRef(null);return l.useEffect(()=>{function h(f){x&&f.key==="Escape"&&g(!1)}return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[x]),e.jsxs("div",{className:"dd-wrap",children:[e.jsx("button",{ref:j,className:"btn btn-outline dd-btn",onClick:()=>g(h=>!h),children:u}),x&&e.jsx("div",{className:"dd-backdrop",onClick:()=>g(!1)}),x&&e.jsx("div",{className:"dd-menu",children:N.map(h=>e.jsx("div",{className:"dd-item "+(h===u?"dd-active":""),onClick:()=>{m(h),g(!1)},children:h},h))})]})}function In({year:u,years:N,onYearChange:m,onAddCategory:x,onShowStats:g}){return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(Mn,{value:u,years:N,onChange:m})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{className:"btn flex items-center gap-2",onClick:x,children:[e.jsx(be,{className:"w-4 h-4"}),"Добавить категорию"]}),e.jsxs("button",{className:"btn btn-outline text-gray-900 flex items-center gap-2",onClick:g,children:[e.jsx(hn,{className:"w-4 h-4"}),"Годовая статистика"]})]})]})}function Le({title:u,onAdd:N}){return e.jsxs("div",{className:"finance-section",children:[e.jsx("span",{children:u}),e.jsxs("button",{className:"btn btn-outline btn-xs text-gray-900 flex items-center gap-1",onClick:N,children:[e.jsx(be,{className:"w-3 h-3"}),"Категория"]})]})}function Ye({type:u,row:N,values:m,isCurrentYear:x,currentMonth:g,hasChildren:j,collapsed:h,onToggleCollapse:f,onNameContext:S,onCellContext:p,onCellEdit:t,fmt:w,ctxCatHighlight:v,ctxCellHighlight:P}){const I={id:N.id,name:N.name,type:u};return e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell "+(v===N.id?"ctx-active":""),children:e.jsxs("div",{className:"cell-head cell-name flex items-center gap-2",children:[e.jsx("button",{className:"shrink-0 rounded-md hover:bg-gray-100 w-6 h-6 flex items-center justify-center",onClick:()=>f(N.id),title:j?h?"Развернуть":"Свернуть":"Категория",children:j?h?e.jsx(Nn,{className:"w-4 h-4"}):e.jsx(vn,{className:"w-4 h-4"}):""}),e.jsx("span",{className:"flex-1 truncate",children:N.name}),e.jsx("button",{className:"icon-btn menu-btn",onClick:A=>S(A,I),onContextMenu:A=>S(A,I),"aria-label":"Действия с категорией",children:e.jsx(gn,{size:16})})]})}),m.map((A,O)=>e.jsx("div",{className:"finance-cell "+(x&&O===g?"col-current ":"")+(P&&P.type===u&&P.catId===N.id&&P.month===O?"ctx-active":""),onContextMenu:X=>p(X,u,N.id,O,A),children:e.jsx("button",{className:"cell-btn",onClick:()=>t(u,N.id,O),children:w(A)})},O))]})}function Dn({pos:u,onClose:N,onRename:m,onAddSub:x,onDelete:g,canAddSub:j=!0}){const h=l.useRef([]),[f,S]=l.useState(0);return l.useEffect(()=>{const p=t=>{t.key==="Escape"&&(t.preventDefault(),N()),t.key==="ArrowDown"&&(t.preventDefault(),S(w=>Math.min(w+1,h.current.length-1))),t.key==="ArrowUp"&&(t.preventDefault(),S(w=>Math.max(w-1,0))),(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),h.current[f]?.click())};return document.addEventListener("keydown",p),()=>document.removeEventListener("keydown",p)},[f,N]),l.useEffect(()=>{h.current[0]?.focus()},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:p=>p.preventDefault(),"aria-hidden":!0}),e.jsxs("div",{className:"ctx-menu",style:{left:u.x,top:u.y,position:"fixed",zIndex:1e3},role:"menu","aria-label":"Действия с категорией",onContextMenu:p=>p.preventDefault(),children:[e.jsx("div",{ref:p=>h.current[0]=p,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:m,"aria-label":"Переименовать категорию","data-active":f===0,children:"Переименовать"}),j&&e.jsx("div",{ref:p=>h.current[1]=p,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:x,"aria-label":"Добавить подкатегорию","data-active":f===1,children:"+ Подкатегория"}),e.jsx("div",{ref:p=>h.current[2]=p,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:g,"aria-label":"Удалить категорию","data-active":f===2,style:{color:"#b91c1c"},children:"Удалить"})]})]})}function Rn({pos:u,onClose:N,canCopy:m,hasClipboard:x,onCopy:g,onPaste:j}){const h=l.useMemo(()=>{const t=[];return m&&t.push({label:"Копировать записи",onClick:g,aria:"Копировать записи"}),x&&t.push({label:"Вставить записи (заменить)",onClick:j,aria:"Вставить записи (заменить)"}),t},[m,x,g,j]),f=l.useRef([]),[S,p]=l.useState(0);return l.useEffect(()=>{const t=w=>{w.key==="Escape"&&(w.preventDefault(),N()),w.key==="ArrowDown"&&(w.preventDefault(),p(v=>Math.min(v+1,h.length-1))),w.key==="ArrowUp"&&(w.preventDefault(),p(v=>Math.max(v-1,0))),(w.key==="Enter"||w.key===" ")&&(w.preventDefault(),f.current[S]?.click())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[S,N,h.length]),l.useEffect(()=>{f.current[0]?.focus()},[h.length]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:t=>t.preventDefault(),"aria-hidden":!0}),e.jsx("div",{className:"ctx-menu",style:{left:u.x,top:u.y,position:"fixed",zIndex:1e3},role:"menu","aria-label":"Действия с ячейкой",onContextMenu:t=>t.preventDefault(),children:h.map((t,w)=>e.jsx("div",{ref:v=>f.current[w]=v,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:t.onClick,"aria-label":t.aria,"data-active":S===w,children:t.label},w))})]})}function He(u){const m={},x={};for(const f of u)m[f.id]=f,f.parent_id&&(x[f.parent_id]||=[]).push(f.id);const g={};function j(f){if(!x[f])return Array(12).fill(0);if(g[f])return g[f].slice();const S=Array(12).fill(0);for(const p of x[f]){const t=m[p];if(t)for(let v=0;v<12;v++)S[v]+=t.values?.[v]??0;const w=j(p);for(let v=0;v<12;v++)S[v]+=w[v]||0}return g[f]=S.slice(),S}const h={};for(const f of Object.keys(x))h[f]=j(f);return h}const qe=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function An(){const u=l.useCallback((x,g,j)=>{try{localStorage.setItem(Ce.FINANCE(x,g),JSON.stringify(j))}catch(h){console.warn("Failed to write finance cache:",h)}},[]),N=l.useCallback((x,g)=>{try{const j=localStorage.getItem(Ce.FINANCE(x,g));return j?JSON.parse(j):null}catch(j){return console.warn("Failed to read finance cache:",j),null}},[]),m=l.useCallback((x,g)=>{try{localStorage.removeItem(Ce.FINANCE(x,g))}catch(j){console.warn("Failed to clear finance cache:",j)}},[]);return{writeCache:u,readCache:N,clearCache:m}}function $e(u,N){return N.find(m=>m.id===u)}const ce=u=>jn(u);function Un(){const{handleError:u,handleSuccess:N}=yn(),{userId:m}=Cn(),{writeCache:x,readCache:g}=An(),{createSimpleFooter:j,createDangerFooter:h}=fn(),f=new Date,S=f.getFullYear(),p=f.getMonth(),[t,w]=l.useState(S),[v,P]=l.useState([]),[I,A]=l.useState([]),[O,X]=l.useState({}),re=l.useMemo(()=>Ae(v,O),[v,O]),we=l.useMemo(()=>Ae(I,O),[I,O]),[he,W]=l.useState(!0),[Z,L]=l.useState(!1),[te,Y]=l.useState(K.INCOME),[se,oe]=l.useState(""),[$,U]=l.useState(null),[de,ae]=l.useState(!1),[V,c]=l.useState(null),[C,y]=l.useState(0),[k,_]=l.useState(!1),[Ne,z]=l.useState({x:0,y:0}),[D,Ee]=l.useState(null),[ve,H]=l.useState(!1),[Ue,ze]=l.useState({x:0,y:0}),[ge,We]=l.useState(null),[G,Be]=l.useState(null),[Ke,Se]=l.useState(!1),[Xe,Ve]=l.useState(null),[Ge,ke]=l.useState(!1),[Je,le]=l.useState(!1),[je,_e]=l.useState(""),[Qe,ue]=l.useState(!1),[Me,B]=l.useState(null),[Ie,q]=l.useState(null);l.useEffect(()=>{if(!m)return;const n=g(m,t);n?(P(n.income??[]),A(n.expense??[]),W(!1)):W(!0),(async()=>{const[a,d]=await Promise.all([T.from("finance_categories").select("id,name,type,parent_id").order("created_at",{ascending:!0}),T.from("finance_entries").select("category_id,month,amount,included").eq("year",t)]);if(a.error||d.error){u(a.error||d.error,"Загрузка финансовых данных"),W(!1);return}const s=a.data||[],i=d.data||[],r={};for(const o of s)r[o.id]=Array(ie).fill(0);for(const o of i){if(!o.included)continue;const M=Math.min(11,Math.max(0,o.month-1)),R=o.category_id;r[R]||(r[R]=Array(ie).fill(0)),r[R][M]+=Number(o.amount)||0}const E=s.filter(o=>o.type===K.INCOME).map(o=>({id:o.id,name:o.name,parent_id:o.parent_id,values:r[o.id]||Array(ie).fill(0)})),b=s.filter(o=>o.type===K.EXPENSE).map(o=>({id:o.id,name:o.name,parent_id:o.parent_id,values:r[o.id]||Array(ie).fill(0)}));P(E),A(b),W(!1),x(m,t,{income:E.map(({id:o,name:M,values:R,parent_id:Q})=>({id:o,name:M,values:R,parent_id:Q})),expense:b.map(({id:o,name:M,values:R,parent_id:Q})=>({id:o,name:M,values:R,parent_id:Q}))})})()},[m,t]);const me=l.useMemo(()=>qe.map((n,a)=>v.reduce((d,s)=>d+(s.values?.[a]??0),0)),[v]),fe=l.useMemo(()=>qe.map((n,a)=>I.reduce((d,s)=>d+(s.values?.[a]??0),0)),[I]),Ze=l.useMemo(()=>me.map((n,a)=>n-fe[a]),[me,fe]);l.useMemo(()=>{const n={};return v.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[v]),l.useMemo(()=>{const n={};return I.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[I]);const De=l.useMemo(()=>He(v),[v]),Re=l.useMemo(()=>He(I),[I]);function Ae(n,a){const d=n.filter(r=>!r.parent_id),s={};n.forEach(r=>{r.parent_id&&(s[r.parent_id]||=[]).push(r)});const i=[];return d.forEach(r=>{i.push(r),a[r.id]||(s[r.id]||[]).forEach(E=>i.push(E))}),n.filter(r=>r.parent_id&&!d.find(E=>E.id===r.parent_id)).forEach(r=>i.push(r)),i}async function en(){const n=se.trim();if(!n||!m)return;const a=te,d={user_id:m,type:a,name:n};$&&(d.parent_id=$.id);const{data:s,error:i}=await T.from("finance_categories").insert(d).select("id,name,type,parent_id").single();if(i){u(i,"Создание категории");return}const r={id:s.id,name:s.name,type:s.type,parent_id:s.parent_id,values:Array(ie).fill(0)};if(a===K.INCOME){const E=[v,r];P(E),x(m,t,{income:E.map(({id:b,name:o,values:M,parent_id:R})=>({id:b,name:o,values:M,parent_id:R})),expense:I.map(({id:b,name:o,values:M,parent_id:R})=>({id:b,name:o,values:M,parent_id:R}))})}else{const E=[I,r];A(E),x(m,t,{income:v.map(({id:b,name:o,values:M,parent_id:R})=>({id:b,name:o,values:M,parent_id:R})),expense:E.map(({id:b,name:o,values:M,parent_id:R})=>({id:b,name:o,values:M,parent_id:R}))})}N(`Категория "${n}" создана`),L(!1),oe(""),Y(K.INCOME),U(null)}function Oe(n,a){n.preventDefault(),n.stopPropagation(),ve&&H(!1),q(null),B(a.id);const d=bn,s=wn,i=8,r=window.innerWidth,E=window.innerHeight;let b=n.clientX,o=n.clientY;b+d>r-i&&(b=r-d-i),o+s>E-i&&(o=E-s-i),b<i&&(b=i),o<i&&(o=i),z({x:b,y:o}),Ee(a),_(!0)}function nn(){_(!1),Ee(null),B(null)}async function tn(){const n=je.trim();if(!n||!D){le(!1);return}const{error:a}=await T.from("finance_categories").update({name:n}).eq("id",D.id);if(a){u(a,"Создание категории");return}if(D.type==="income"){const d=v.map(s=>s.id===D.id?{...s,name:n}:s);P(d),x(m,t,{income:d.map(({id:s,name:i,values:r,parent_id:E})=>({id:s,name:i,values:r,parent_id:E})),expense:I.map(({id:s,name:i,values:r,parent_id:E})=>({id:s,name:i,values:r,parent_id:E}))})}else{const d=I.map(s=>s.id===D.id?{...s,name:n}:s);A(d),x(m,t,{income:v.map(({id:s,name:i,values:r,parent_id:E})=>({id:s,name:i,values:r,parent_id:E})),expense:d.map(({id:s,name:i,values:r,parent_id:E})=>({id:s,name:i,values:r,parent_id:E}))})}le(!1)}async function sn(){if(!D)return;const{error:n}=await T.from("finance_categories").delete().eq("id",D.id);if(n){u(n,"Создание категории");return}if(D.type==="income"){const a=v.filter(d=>d.id!==D.id);P(a),x(m,t,{income:a.map(({id:d,name:s,values:i,parent_id:r})=>({id:d,name:s,values:i,parent_id:r})),expense:I.map(({id:d,name:s,values:i,parent_id:r})=>({id:d,name:s,values:i,parent_id:r}))})}else{const a=I.filter(d=>d.id!==D.id);A(a),x(m,t,{income:v.map(({id:d,name:s,values:i,parent_id:r})=>({id:d,name:s,values:i,parent_id:r})),expense:a.map(({id:d,name:s,values:i,parent_id:r})=>({id:d,name:s,values:i,parent_id:r}))})}ue(!1)}async function Te(n,a,d,s,i){n.preventDefault(),n.stopPropagation(),k&&_(!1),ve&&H(!1),B(null),q({type:a,catId:d,month:s});const r={category_id:d,year:t,month:s+1},E=!!G&&G.length>0;if(!E&&(!i||i===0)){q(null);return}const b=200,o=80,M=8,R=window.innerWidth,Q=window.innerHeight;let ee=n.clientX,ne=n.clientY;console.log("Original click position:",{x:n.clientX,y:n.clientY}),console.log("Viewport size:",{vw:R,vh:Q}),console.log("Menu size:",{menuWidth:b,menuHeight:o}),ee+b>R-M&&(ee=R-b-M),ne+o>Q-M&&(ne=Q-o-M),ee<M&&(ee=M),ne<M&&(ne=M),console.log("Final menu position:",{x:ee,y:ne}),We({catId:d,type:a,month:s}),ze({x:ee,y:ne}),Se(!1),H(!0);const{data:rn}=await T.from("finance_entries").select("amount, note, included, position").match(r).order("position",{ascending:!0}).order("created_at",{ascending:!0}),ye=(rn||[]).map(xe=>({amount:Number(xe.amount)||0,note:xe.note,included:!!xe.included,position:xe.position??0}));if(Ve(ye),!ye.length&&!E){H(!1),q(null);return}Se(ye.length>0)}async function an(){const n=Xe||[];if(!n.length){H(!1),q(null);return}Be(n.slice());try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{}H(!1),q(null)}async function ln(){if(!ge||!G||!G.length||!m)return;const{catId:n,type:a,month:d}=ge,s={category_id:n,year:t,month:d+1};await T.from("finance_entries").delete().match(s);const i=G.map((b,o)=>({where:s,user_id:m,amount:b.amount,note:b.note,included:b.included,position:o}));await T.from("finance_entries").insert(i);const r=i.filter(b=>b.included).reduce((b,o)=>b+(o.amount||0),0),E=b=>b.map(o=>o.id===n?{...o,values:o.values.map((M,R)=>R===d?r:M)}:o);a==="income"?P(E(v)):A(E(I)),H(!1),q(null)}if(l.useEffect(()=>{const n=d=>{d.key==="Escape"&&(_(!1),H(!1),B(null),q(null))},a=()=>{_(!1),H(!1),B(null),q(null)};return window.addEventListener("keydown",n),window.addEventListener("wheel",a,{passive:!0}),()=>{window.removeEventListener("keydown",n),window.removeEventListener("wheel",a)}},[]),he)return e.jsx("div",{className:"p-4",children:e.jsx(En,{rows:10})});const J=t===S,cn=Array.from({length:7}).map((n,a)=>S-3+a);return e.jsxs(on.Fragment,{children:[e.jsxs("div",{className:"space-y-6 finance-page",onContextMenu:n=>{n.preventDefault()},children:[e.jsx(In,{year:t,years:cn,onYearChange:w,onAddCategory:()=>{Y(K.INCOME),U(null),L(!0)},onShowStats:()=>ke(!0)}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Категория"})}),Pe.map((n,a)=>e.jsx("div",{className:"finance-cell "+(J&&a===p?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsx(Le,{title:"Доходы",onAdd:()=>{Y(K.INCOME),U(null),L(!0)}}),re.map(n=>{const a=!!De[n.id],d=a?De[n.id]:n.values;return e.jsx(Ye,{type:"income",row:n,values:d,isCurrentYear:J,currentMonth:p,hasChildren:a,collapsed:!!O[n.id],onToggleCollapse:s=>X(i=>({...i,[s]:!i[s]})),onNameContext:(s,i)=>Oe(s,i),onCellContext:Te,onCellEdit:(s,i,r)=>{c({id:i,name:n.name,type:s}),y(r),ae(!0)},fmt:ce,ctxCatHighlight:Me,ctxCellHighlight:Ie})}),e.jsx(Le,{title:"Расходы",onAdd:()=>{Y(K.EXPENSE),U(null),L(!0)}}),we.map(n=>{const a=!!Re[n.id],d=a?Re[n.id]:n.values;return e.jsx(Ye,{type:"expense",row:n,values:d,isCurrentYear:J,currentMonth:p,hasChildren:a,collapsed:!!O[n.id],onToggleCollapse:s=>X(i=>({...i,[s]:!i[s]})),onNameContext:(s,i)=>Oe(s,i),onCellContext:Te,onCellEdit:(s,i,r)=>{c({id:i,name:n.name,type:s}),y(r),ae(!0)},fmt:ce,ctxCatHighlight:Me,ctxCellHighlight:Ie})})]}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Показатель"})}),Pe.map((n,a)=>e.jsx("div",{className:"finance-cell "+(J&&a===p?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Доходы"})}),me.map((n,a)=>e.jsx("div",{className:"finance-cell "+(J&&a===p?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:ce(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Расходы"})}),fe.map((n,a)=>e.jsx("div",{className:"finance-cell "+(J&&a===p?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:ce(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:700},children:"Баланс"})}),Ze.map((n,a)=>e.jsx("div",{className:"finance-cell "+(J&&a===p?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",style:{fontWeight:700},children:ce(n)})},a))]})]})]}),k&&D&&e.jsx(Dn,{pos:Ne,canAddSub:!($e(D.id,v)||$e(D.id,I))?.parent_id,onClose:nn,onRename:()=>{_e(D.name),le(!0),_(!1),B(null)},onAddSub:()=>{Y(D.type),U({id:D.id,name:D.name}),L(!0),_(!1),B(null)},onDelete:()=>{ue(!0),_(!1),B(null)}}),ve&&ge&&e.jsx(Rn,{pos:Ue,onClose:()=>{H(!1),q(null)},canCopy:Ke,hasClipboard:!!(G&&G.length>0),onCopy:an,onPaste:ln}),e.jsxs(pe,{open:Z,onClose:()=>{L(!1),U(null)},title:$?"Новая подкатегория":"Новая категория",subtitle:$?`Родитель: ${$.name}`:void 0,footer:j({label:$?"Добавить подкатегорию":"Добавить категорию",onClick:en,disabled:!se.trim()},{label:"Отмена",onClick:()=>{L(!1),U(null)}}),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Тип"}),e.jsx("div",{className:"flex-1",children:e.jsx(kn,{value:te,onChange:Y,fullWidth:!0})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Название"}),e.jsx("input",{value:se,onChange:n=>oe(n.target.value),placeholder:$?"Напр. Коммунальные":"Напр. Жильё",className:"border rounded-lg px-3 py-2 text-sm flex-1"})]})]}),e.jsx(pe,{open:Je,onClose:()=>le(!1),title:"Переименовать категорию",footer:j({label:"Сохранить",onClick:tn,disabled:!je.trim()},{label:"Отмена",onClick:()=>le(!1)}),children:e.jsx("input",{value:je,onChange:n=>_e(n.target.value),className:"border rounded-lg px-3 py-2 text-sm w-full",autoFocus:!0})}),e.jsx(pe,{open:Qe,onClose:()=>ue(!1),title:"Удалить категорию?",footer:h({label:"Удалить",onClick:sn},{label:"Отмена",onClick:()=>ue(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Все записи в этой категории будут удалены без возможности восстановления."})}),de&&V&&e.jsx(Sn,{open:de,onClose:()=>ae(!1),userId:m,categoryId:V.id,categoryName:V.name,monthIndex:C,year:t,onApply:n=>{const a=d=>d.map(s=>s.id===V.id?{...s,values:s.values.map((i,r)=>r===C?n:i)}:s);V.type==="income"?P(a(v)):A(a(I))}}),e.jsx(_n,{open:Ge,onClose:()=>ke(!1),year:t,incomeByMonth:me,expenseByMonth:fe})]})}export{Un as default};
