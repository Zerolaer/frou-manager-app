import{r,j as t,s as T,A as V,i as $,k as Y}from"./index-De27cj0q.js";import B from"./NoteEditorModal-CTsXJOtn.js";import{u as F}from"./errorHandler-B8Obt8fF.js";import{P as G,u as W}from"./useRetry-Cu76DQqc.js";const A=r.memo(({note:e,onEdit:s,onDelete:a,onTogglePin:l})=>{const c=r.useMemo(()=>{var o;return((o=e.content)==null?void 0:o.slice(0,160))??""},[e.content]),d=r.useCallback(()=>{s(e)},[e,s]),f=r.useCallback(o=>{o.stopPropagation(),l(e)},[e,l]),p=r.useCallback(o=>{o.stopPropagation(),a(e)},[e,a]);return t.jsxs("div",{className:"rounded-2xl shadow-sm border border-gray-200 bg-white hover:shadow-md transition p-4 flex flex-col gap-3",role:"button",onClick:d,children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsx("h3",{className:"text-sm font-semibold line-clamp-2",children:e.title||"Без заголовка"}),t.jsx("button",{className:"text-xs px-2 py-1 rounded-full border hover:bg-gray-50",onClick:f,title:e.pinned?"Открепить":"Закрепить",children:e.pinned?"📌":"📍"})]}),t.jsx("p",{className:"text-xs text-gray-600 line-clamp-4 whitespace-pre-wrap",children:c}),t.jsxs("div",{className:"flex justify-between items-center pt-2 border-t text-[11px] text-gray-500",children:[t.jsx("span",{children:new Date(e.updated_at).toLocaleString()}),t.jsx("button",{className:"text-red-600 hover:underline",onClick:p,children:"Удалить"})]})]})});A.displayName="NoteCard";async function J(e,s="updated_at"){let a=T.from("notes").select("*").order("pinned",{ascending:!1}).order(s,{ascending:s==="title"});e!=null&&e.trim()&&(a=a.ilike("title",`%${e.trim()}%`));const{data:l,error:c}=await a;if(c)throw c;return l}async function K(e){const{data:s,error:a}=await T.from("notes").insert({title:e.title??"",content:e.content??"",pinned:e.pinned??!1}).select().single();if(a)throw a;return s}async function D(e,s){const{data:a,error:l}=await T.from("notes").update(s).eq("id",e).select().single();if(l)throw l;return a}async function Q(e){const{error:s}=await T.from("notes").delete().eq("id",e);if(s)throw s}async function U(e,s){return D(e,{pinned:s})}function X(e,s=250){const[a,l]=r.useState(e);return r.useEffect(()=>{const c=setTimeout(()=>l(e),s);return()=>clearTimeout(c)},[e,s]),a}function Z({size:e="md",className:s=""}){const a={sm:"w-4 h-4",md:"w-6 h-6",lg:"w-8 h-8"};return t.jsx("div",{className:`animate-spin rounded-full border-2 border-gray-300 border-t-blue-600 ${a[e]} ${s}`})}function q({loading:e,error:s,empty:a=!1,emptyMessage:l="Нет данных",children:c,loadingComponent:d}){return e?d||t.jsxs("div",{className:"flex items-center justify-center p-8",children:[t.jsx(Z,{size:"lg"}),t.jsx("span",{className:"ml-3 text-gray-600",children:"Загрузка..."})]}):s?t.jsx("div",{className:"flex items-center justify-center p-8",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-red-600 mb-2",children:"⚠️ Ошибка загрузки"}),t.jsx("div",{className:"text-sm text-gray-600",children:s.message})]})}):a?t.jsx("div",{className:"flex items-center justify-center p-8",children:t.jsx("div",{className:"text-center text-gray-500",children:l})}):t.jsx(t.Fragment,{children:c})}function I({className:e=""}){return t.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${e}`})}function H(){return t.jsxs("div",{className:"rounded-xl border bg-white p-6 shadow-sm",children:[t.jsx(I,{className:"h-4 w-3/4 mb-2"}),t.jsx(I,{className:"h-3 w-1/2 mb-4"}),t.jsx(I,{className:"h-3 w-full mb-2"}),t.jsx(I,{className:"h-3 w-2/3"})]})}function ee({count:e=3}){return t.jsx("div",{className:"space-y-4",children:Array.from({length:e}).map((s,a)=>t.jsx(H,{},a))})}const te=r.memo(({items:e,itemHeight:s,containerHeight:a,renderItem:l,keyExtractor:c,overscan:d=5,className:f=""})=>{const p=r.useRef(null),[o,g]=r.useState(0),x=r.useCallback(u=>{g(u.currentTarget.scrollTop)},[]),h=r.useMemo(()=>{const u=Math.max(0,Math.floor(o/s)-d),j=Math.min(e.length-1,Math.ceil((o+a)/s)+d);return{startIndex:u,endIndex:j}},[o,s,a,e.length,d]),b=r.useMemo(()=>{const{startIndex:u,endIndex:j}=h;return e.slice(u,j+1).map((E,m)=>({item:E,index:u+m}))},[e,h]),N=e.length*s,y=h.startIndex*s;return t.jsx("div",{ref:p,className:`overflow-auto ${f}`,style:{height:a},onScroll:x,children:t.jsx("div",{style:{height:N,position:"relative"},children:t.jsx("div",{style:{transform:`translateY(${y}px)`},children:b.map(({item:u,index:j})=>t.jsx("div",{style:{height:s},children:l(u,j)},c(u,j)))})})})});te.displayName="VirtualizedList";const se=r.memo(({items:e,hasMore:s,isLoading:a,onLoadMore:l,renderItem:c,keyExtractor:d,itemHeight:f,className:p=""})=>{const o=r.useRef(),g=r.useCallback(x=>{a||(o.current&&o.current.disconnect(),o.current=new IntersectionObserver(h=>{h[0].isIntersecting&&s&&l()}),x&&o.current.observe(x))},[a,s,l]);return r.useEffect(()=>()=>{o.current&&o.current.disconnect()},[]),t.jsxs("div",{className:p,children:[e.map((x,h)=>{const b=h===e.length-1;return t.jsx("div",{ref:b?g:null,style:f?{height:f}:void 0,children:c(x,h)},d(x,h))}),a&&t.jsx("div",{className:"flex justify-center p-4",children:t.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent"})})]})});se.displayName="InfiniteScrollList";const z=r.memo(({items:e,columns:s,itemHeight:a,containerHeight:l,renderItem:c,keyExtractor:d,gap:f=16,className:p=""})=>{const o=r.useRef(null),[g,x]=r.useState(0),h=r.useCallback(m=>{x(m.currentTarget.scrollTop)},[]),b=Math.ceil(e.length/s),N=a+f,y=r.useMemo(()=>{const m=Math.max(0,Math.floor(g/N)-2),v=Math.min(b-1,Math.ceil((g+l)/N)+2);return{startRow:m,endRow:v}},[g,N,l,b]),u=r.useMemo(()=>{const{startRow:m,endRow:v}=y,C=[];for(let S=m;S<=v;S++)for(let k=0;k<s;k++){const M=S*s+k;M<C.length&&C.push({item:C[M],index:M,row:S,col:k})}return C},[e,y,s]),j=b*N,E=y.startRow*N;return t.jsx("div",{ref:o,className:`overflow-auto ${p}`,style:{height:l},onScroll:h,children:t.jsx("div",{style:{height:j,position:"relative"},children:t.jsx("div",{style:{transform:`translateY(${E}px)`,display:"grid",gridTemplateColumns:`repeat(${s}, 1fr)`,gap:`${f}px`},children:u.map(({item:m,index:v,row:C,col:S})=>t.jsx("div",{style:{height:a},children:c(m,v)},d(m,v)))})})})});z.displayName="VirtualizedGrid";function re(){const{handleError:e,handleSuccess:s}=F(),{executeApiCall:a}=W(),[l,c]=r.useState([]),[d,f]=r.useState(""),[p,o]=r.useState("updated_at"),[g,x]=r.useState(!0),[h,b]=r.useState(!1),[N,y]=r.useState(null),u=X(d,250);async function j(n){x(!0);try{const i=await a(()=>J(u,p));if(n!=null&&n.aborted)return;i&&c(i)}catch(i){n!=null&&n.aborted||e(i,"Загрузка заметок")}finally{n!=null&&n.aborted||x(!1)}}r.useEffect(()=>{const n=new AbortController;return j(n.signal),()=>n.abort()},[p,u]);const E=r.useCallback(async(n,i)=>{try{if(i){const w=await D(i,n);c(R=>R.map(P=>P.id===i?w:P)),s("Заметка обновлена")}else{const w=await K(n);c(R=>[w,...R]),s("Заметка создана")}}catch(w){e(w,i?"Обновление заметки":"Создание заметки")}},[e,s]),m=r.useCallback(async n=>{try{await Q(n),c(i=>i.filter(w=>w.id!==n)),s("Заметка удалена")}catch(i){e(i,"Удаление заметки")}},[e,s]),v=r.useCallback(async n=>{try{const i=await U(n.id,!n.pinned);c(w=>w.map(R=>R.id===n.id?i:R)),s(n.pinned?"Закрепление снято":"Заметка закреплена")}catch(i){e(i,"Изменение закрепления")}},[e,s]),C=!g&&l.length===0&&!d,S=r.useCallback(()=>{y(null),b(!0)},[]),k=r.useCallback(n=>{f(n.target.value)},[]),M=r.useCallback(n=>{o(n.target.value)},[]),L=r.useCallback(n=>{y(n),b(!0)},[]),_=r.useCallback(()=>{b(!1)},[]),O=r.useMemo(()=>4,[]);return t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsx("div",{className:"flex flex-wrap items-center justify-between gap-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(V,{variant:"primary",size:"sm",onClick:S,ariaLabel:$.ADD+" заметку",announceOnClick:"Открыто окно создания заметки",children:"+ Добавить заметку"}),t.jsx(Y,{label:"Поиск заметок",placeholder:"Поиск по заголовку…",value:d,onChange:k,className:"w-64",ariaLabel:$.SEARCH+" заметок"}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("label",{htmlFor:"sort-select",className:"text-sm font-medium text-gray-700 mb-1",children:"Сортировка"}),t.jsxs("select",{id:"sort-select",className:"border rounded-lg px-3 py-2 text-sm",value:p,onChange:M,"aria-label":"Выберите способ сортировки заметок",children:[t.jsx("option",{value:"updated_at",children:"По обновлению"}),t.jsx("option",{value:"created_at",children:"По созданию"}),t.jsx("option",{value:"title",children:"По алфавиту"})]})]})]})}),t.jsx(q,{loading:g,empty:C,emptyMessage:"Пока нет заметок",loadingComponent:t.jsx(ee,{count:6}),children:l.length>50?t.jsx(z,{items:l,columns:O,itemHeight:200,containerHeight:600,renderItem:(n,i)=>t.jsx(A,{note:n,onEdit:L,onDelete:m,onTogglePin:v},n.id),keyExtractor:n=>n.id,gap:16,className:"p-4"}):t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4",children:l.map(n=>t.jsx(A,{note:n,onEdit:L,onDelete:m,onTogglePin:v},n.id))})}),t.jsx(B,{open:h,note:N,onClose:_,onSave:E,onDelete:m})]})}function ce(){return t.jsx(G,{pageName:"Заметки",onError:(e,s)=>{console.error("Notes page error:",e,s)},children:t.jsx(re,{})})}export{ce as default};
