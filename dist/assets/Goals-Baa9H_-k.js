import{j as e,s as u}from"./index-C9CAK8j2.js";import{r as o}from"./vendor-5APVzNZg.js";import{S as G,P}from"./PageContainer-BjQpAS9l.js";import{P as q,C as L,E as O,f as U,g as D,T}from"./icons-BBrol7Dz.js";import $ from"./GoalModal-BuhUegPa.js";import{U as A,u as F}from"./ModalSystem-DpluxzZI.js";import{u as H}from"./errorHandler-ndPEhMzI.js";import{L as I}from"./LoadingStates-CkdnrzZx.js";import{P as R}from"./ErrorBoundaries-DJzfo9mo.js";import"./supabase-7cNBIxai.js";import"./ModalForm-D2xgqyvm.js";function z({onCreate:t,onOpenStats:s}){return e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Цели"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{className:"btn flex items-center gap-2",onClick:t,children:[e.jsx(q,{className:"w-4 h-4"}),"Добавить цель"]}),e.jsxs("button",{className:"btn-secondary flex items-center gap-2",onClick:s,children:[e.jsx(L,{className:"w-4 h-4"}),"Статистика"]})]})]})}function B({goal:t,onEdit:s,onDelete:a,onComplete:n}){const i=Math.max(0,Math.min(100,t.progress??0)),d=i>=100?"bg-green-600":i>=66?"bg-blue-600":i>=33?"bg-amber-500":"bg-gray-300";return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"font-semibold text-gray-900 truncate",children:t.title}),t.description&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:t.description})]}),e.jsx("button",{className:"p-2 text-gray-500 hover:text-gray-900",onClick:()=>s(t),"aria-label":"Edit goal menu",children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"w-full h-2 rounded bg-gray-100 overflow-hidden",children:e.jsx("div",{className:`h-full ${d}`,style:{width:`${i}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.deadline&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{children:new Date(t.deadline).toLocaleDateString()})]}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-gray-100 text-gray-700",children:"Цель"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.status!=="completed"&&e.jsxs("button",{className:"btn btn-sm",onClick:()=>n(t),children:[e.jsx(D,{className:"w-4 h-4 mr-1"})," Завершить"]}),e.jsxs("button",{className:"btn-danger btn-sm",onClick:()=>a(t),children:[e.jsx(T,{className:"w-4 h-4 mr-1"})," Удалить"]})]})]})]})}function Q({open:t,onClose:s,goals:a}){const n=a.length,i=a.filter(p=>p.status==="completed").length,d=n-i,h=Math.round(a.reduce((p,x)=>p+(x.progress??0),0)/Math.max(1,n)),{createSimpleFooter:m}=F();return e.jsxs(A,{open:t,onClose:s,title:"Статистика по целям",size:"lg",footer:m({label:"Закрыть",onClick:s}),children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Всего целей"}),e.jsx("div",{className:"text-2xl font-semibold",children:n})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Выполнено"}),e.jsx("div",{className:"text-2xl font-semibold",children:i})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"В процессе"}),e.jsx("div",{className:"text-2xl font-semibold",children:d})]})]}),e.jsxs("div",{className:"mt-6 bg-white border rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-2",children:"Средний прогресс"}),e.jsx("div",{className:"w-full h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded",style:{width:`${h}%`}})})]})]})}const g="goals";function V(t){const s=Number(t.target_amount??0),a=Number(t.current_amount??0);return s>0?Math.max(0,Math.min(100,a/s*100)):0}function b(t){const s=V(t);return{id:t.id,user_id:t.user_id,title:t.title,description:t.notes??null,progress:s,status:s>=100?"completed":"active",target_amount:t.target_amount??null,current_amount:t.current_amount??null,deadline:t.deadline??null,created_at:t.created_at}}async function J(){try{const{data:{user:t},error:s}=await u.auth.getUser();if(s)throw new Error("Не авторизован");if(!t)throw new Error("Пользователь не найден");const{data:a,error:n}=await u.from(g).select("*").eq("user_id",t.id).order("created_at",{ascending:!1});if(n)throw n;return(a??[]).map(b)}catch(t){throw console.error("API: listGoals error",t),t}}async function K(t){const s=Math.max(0,Math.min(100,Math.round(t.progress??0))),{data:{user:a},error:n}=await u.auth.getUser();if(n||!a)throw new Error("Не авторизован");const i={user_id:a.id,title:t.title,notes:t.description??null,target_amount:100,current_amount:s,deadline:t.deadline??null},{data:d,error:h}=await u.from(g).insert(i).select().single();if(h)throw h;return b(d)}async function W(t,s){const a={title:s.title,notes:s.description??null,deadline:s.deadline??null};typeof s.progress=="number"&&(a.current_amount=Math.max(0,Math.min(100,Math.round(s.progress))),a.target_amount=100);const{data:n,error:i}=await u.from(g).update(a).eq("id",t).select().single();if(i)throw i;return b(n)}async function X(t){const{error:s}=await u.from(g).delete().eq("id",t);if(s)throw s}async function Y(t){const{data:s,error:a}=await u.from(g).update({current_amount:100,target_amount:100}).eq("id",t).select().single();if(a)throw a;return b(s)}function Z(){const{handleError:t,handleSuccess:s}=H(),[a,n]=o.useState([]),[i,d]=o.useState(!0),[h,m]=o.useState(!1),[p,x]=o.useState(!1),[v,N]=o.useState(null),[j,C]=o.useState("");o.useEffect(()=>{let r=!1;return(async()=>{try{d(!0);const l=await J();r||n(l||[])}catch(l){r||(t(l,"Загрузка целей"),n([]))}finally{r||d(!1)}})(),()=>{r=!0}},[]);const y=o.useMemo(()=>{const r=j.trim().toLowerCase();return r?a.filter(l=>(l.title+" "+(l.description??"")).toLowerCase().includes(r)):a},[a,j]),_=o.useCallback(()=>{N(null),m(!0)},[]),E=o.useCallback(r=>{N(r),m(!0)},[]);o.useCallback(()=>{x(!0)},[]),o.useCallback(()=>{x(!1)},[]),o.useCallback(()=>{m(!1)},[]);const M=async r=>{if(confirm("Удалить цель?"))try{await X(r.id),n(l=>l.filter(c=>c.id!==r.id)),s("Цель удалена")}catch(l){t(l,"Удаление цели")}},S=async r=>{try{const l=await Y(r.id);n(c=>c.map(f=>f.id===r.id?l:f)),s("Цель завершена")}catch(l){t(l,"Завершение цели")}},k=async(r,l)=>{try{if(l){const c=await W(Number(l),r);n(f=>f.map(w=>w.id===Number(l)?c:w)),s("Цель обновлена")}else{const c=await K(r);n(f=>[c,...f]),s("Цель создана")}m(!1)}catch(c){t(c,l?"Обновление цели":"Создание цели")}};return e.jsxs(e.Fragment,{children:[e.jsx(G,{title:"Цели",children:e.jsx(z,{onCreate:_,onOpenStats:()=>x(!0)})}),e.jsx(P,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{className:"input w-full max-w-md",placeholder:"Поиск по целям…",value:j,onChange:r=>C(r.target.value)})}),i?e.jsx(I,{count:6}):e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:[y.map(r=>e.jsx(B,{goal:r,onEdit:E,onDelete:M,onComplete:S},r.id)),y.length===0&&!i?e.jsx("div",{className:"col-span-full text-center text-gray-500 py-8",children:j?"Ничего не найдено":"Цели не найдены. Создайте первую цель!"}):null]}),e.jsx($,{open:h,initial:v,onClose:()=>m(!1),onSave:k}),e.jsx(Q,{open:p,onClose:()=>x(!1),goals:a})]})})]})}function me(){return e.jsx(R,{pageName:"Цели",onError:(t,s)=>{console.error("Goals page error:",t,s)},children:e.jsx(Z,{})})}export{me as default};
