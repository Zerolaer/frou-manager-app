import{j as a,s as f}from"./index-BJakucwa.js";import{r as o}from"./vendor-5APVzNZg.js";import{m as R}from"./dateUtils-BepG4-_g.js";import{f as x}from"./format-CfBjB5Ts.js";import{g as B,D as j}from"./auth-BKPcReOB.js";import"./supabase-7cNBIxai.js";function Z(){const[{start:w,end:N}]=o.useState(()=>R(j.TZ)),[m,q]=o.useState([]),[v,h]=o.useState(!0),[p,g]=o.useState(null),[D,y]=o.useState(""),M=o.useMemo(()=>new Intl.DateTimeFormat("ru-RU",{month:"long",year:"numeric"}).format(new Date),[]);o.useEffect(()=>{let t=!1;return(async()=>{h(!0),g(null);const e=j.finance,i=await B();async function S(){const s=[e.amount,e.type].filter(Boolean).join(",");let n=f.from(e.table).select(s);i&&(n=n.eq(e.userId,i)),n=n.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:l,error:r}=await n.limit(2e3);if(r)throw r;return l.map(c=>({amount:Number(c[e.amount]??0),type:String(c[e.type])}))}async function E(){const s=[e.amount,e.boolField].filter(Boolean).join(",");let n=f.from(e.table).select(s);i&&(n=n.eq(e.userId,i)),n=n.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:l,error:r}=await n.limit(2e3);if(r)throw r;return l.map(c=>({amount:Number(c[e.amount]??0),flag:!!c[e.boolField]}))}async function F(){let s=f.from(e.table).select(e.amount);i&&(s=s.eq(e.userId,i)),s=s.eq("year",new Date().getFullYear()).eq("month",new Date().getMonth()+1).eq("included",!0);const{data:n,error:l}=await s.limit(2e3);if(l)throw l;return n.map(r=>({amount:Number(r[e.amount]??0)}))}try{let s=[];if(e.mode!=="type"){if(e.mode!=="bool"){if(e.mode!=="sign")try{s=await S(),y("type")}catch{s=await F(),y("sign")}}}t||q(s)}catch(s){t||g(s?.message||"Ошибка загрузки финансов")}finally{t||h(!1)}})(),()=>{t=!0}},[w,N]);let d=0,u=0;D==="type"?(d=m.filter(t=>t.type==="income").reduce((t,e)=>t+(e.amount||0),0),u=m.filter(t=>t.type==="expense").reduce((t,e)=>t+(e.amount||0),0)):(d=m.filter(t=>(t.amount??0)>=0).reduce((t,e)=>t+(e.amount||0),0),u=m.filter(t=>(t.amount??0)<0).reduce((t,e)=>t+Math.abs(e.amount||0),0));const b=d-u;return a.jsxs("div",{className:"card",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h2",{className:"text-lg font-semibold",children:["Финансы: ",M]}),a.jsx("a",{href:"/finance",className:"text-sm text-primary hover:underline",children:"Открыть финансы"})]}),v?a.jsx("div",{className:"text-sm text-neutral-500",children:"Загрузка…"}):p?a.jsxs("div",{className:"text-sm text-danger",children:["Ошибка: ",p]}):a.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[a.jsxs("div",{className:"card-compact",children:[a.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:"Доходы"}),a.jsx("div",{className:"text-xl font-semibold",children:x(d)})]}),a.jsxs("div",{className:"card-compact",children:[a.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:"Расходы"}),a.jsx("div",{className:"text-xl font-semibold",children:x(u)})]}),a.jsxs("div",{className:"card-compact",children:[a.jsx("div",{className:"text-xs text-neutral-500 mb-1",children:"Баланс"}),a.jsx("div",{className:`text-xl font-semibold ${b>=0?"text-success":"text-danger"}`,children:x(b)})]})]})]})}export{Z as FinanceMonth};
