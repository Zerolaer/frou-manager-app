import{j as e,s as P}from"./index-CNKhdkqj.js";import{r as l,R as an}from"./vendor-CqGws4Uo.js";import{M as ln,U as me,a as cn,b as rn,u as on}from"./ModalSystem-jtM-kp9f.js";import{P as fe,a as dn,T as Ye,b as un,c as mn,d as fn,E as xn,e as pn,f as hn,g as Nn}from"./icons-HVSKy6uN.js";import{f as gn}from"./format-CfBjB5Ts.js";import{u as jn}from"./errorHandler-BCvQLjty.js";import{u as vn}from"./useSupabaseAuth-D4pHmIRK.js";import{C as je,F as V,M as ae,a as Re}from"./constants-Dv7MHcu-.js";import"./supabase-BmeMSZYH.js";function F({className:o=""}){return e.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${o}`})}function yn({rows:o=6}){return e.jsx("div",{className:"space-y-2",children:Array.from({length:o}).map((N,u)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx(F,{className:"h-6 col-span-3"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"}),e.jsx(F,{className:"h-6 col-span-1"})]},u))})}function Cn({open:o,onClose:N,userId:u,categoryId:x,categoryName:j,monthIndex:v,year:h,onApply:f}){const[w,p]=l.useState(!0),[t,b]=l.useState([]),[g,T]=l.useState(""),[_,R]=l.useState(""),A=l.useRef(null),W=l.useRef({}),ce=(c,C,y=350)=>{clearTimeout(W.current[c]),W.current[c]=setTimeout(C,y)},xe=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][v];l.useMemo(()=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"EUR"}),[]);const K=l.useRef(null);l.useEffect(()=>{o&&(async()=>{p(!0);const{data:c,error:C}=await P.from("finance_entries").select("id, amount, note, included, position, created_at").eq("category_id",x).eq("year",h).eq("month",v+1).order("position",{ascending:!0}).order("created_at",{ascending:!0});if(C){console.error(C),p(!1);return}const y=(c||[]).map(E=>({id:E.id,amount:Number(E.amount)||0,note:E.note,included:!!E.included,position:E.position??0}));b(y),p(!1)})()},[o,x,v,h]),l.useEffect(()=>{o&&A.current&&setTimeout(()=>{A.current?.focus()},100)},[o]);function Z(c){return c.reduce((C,y)=>C+(y.included?y.amount:0),0)}async function L(){const c=Number(String(g).replace(",","."));if(!u||isNaN(c))return;const C={user_id:u,category_id:x,year:h,month:v+1,amount:c,note:_,included:!0,position:t.length},{data:y,error:E}=await P.from("finance_entries").insert(C).select("id, amount, note, included, position").single();if(E){console.error(E);return}const S=[...t,{id:y.id,amount:Number(y.amount)||0,note:y.note,included:!!y.included,position:y.position??t.length}];b(S),T(""),R(""),f(Z(S)),setTimeout(()=>{A.current?.focus()},50)}function ee(c){c.key==="Enter"&&(c.preventDefault(),L())}function Y(c,C){b(y=>{const E=y.map(S=>S.id===c?{...S,...C}:S);return f(Z(E)),E})}function ne(c,C){const y=Number(String(C).replace(",","."));Y(c,{amount:isNaN(y)?0:y}),ce("amt:"+c,async()=>{const{error:E}=await P.from("finance_entries").update({amount:isNaN(y)?0:y}).eq("id",c);E&&console.error(E)})}function ie(c,C){Y(c,{note:C}),ce("note:"+c,async()=>{const{error:y}=await P.from("finance_entries").update({note:C}).eq("id",c);y&&console.error(y)})}async function U(c,C){Y(c,{included:C});const{error:y}=await P.from("finance_entries").update({included:C}).eq("id",c);y&&console.error(y)}async function X(c){const{error:C}=await P.from("finance_entries").delete().eq("id",c);if(C){console.error(C);return}const y=t.filter(E=>E.id!==c);y.forEach((E,S)=>{E.position=S}),b(y),f(Z(y)),await Promise.all(y.map((E,S)=>P.from("finance_entries").update({position:S}).eq("id",E.id)))}function re(c){K.current=c}function te(c){c.preventDefault()}async function J(c){const C=K.current;if(K.current=null,!C||C===c)return;const y=t.findIndex(B=>B.id===C),E=t.findIndex(B=>B.id===c);if(y<0||E<0)return;const S=t.slice(),[pe]=S.splice(y,1);S.splice(E,0,pe),S.forEach((B,I)=>{B.position=I}),b(S),f(Z(S)),await Promise.all(S.map((B,I)=>P.from("finance_entries").update({position:I}).eq("id",B.id)))}return e.jsx(ln,{open:o,onClose:N,title:e.jsxs("span",{bodyClassName:"p-0",children:[e.jsx("b",{children:j})," · ",xe," ",h]}),footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn btn-outline",onClick:N,children:"Закрыть"})}),size:"md",children:e.jsxs("div",{className:"editor-body",children:[w&&e.jsx("div",{className:"loading-overlay",children:"Загрузка…"}),e.jsxs("div",{className:"editor-add",children:[e.jsx("input",{ref:A,type:"number",placeholder:"Сумма (€)",value:g,onChange:c=>T(c.target.value),onKeyPress:ee,className:"editor-input number"}),e.jsx("input",{placeholder:"Описание (необязательно)",value:_,onChange:c=>R(c.target.value),onKeyPress:ee,className:"editor-input text"}),e.jsxs("button",{className:"btn btn-outline flex items-center gap-2",onClick:L,children:[e.jsx(fe,{className:"w-4 h-4"}),"Добавить"]})]}),e.jsxs("div",{children:[t.map(c=>e.jsxs("div",{className:"entry-row "+(c.included?"":"entry-disabled"),draggable:!0,onDragStart:()=>re(c.id),onDragOver:te,onDrop:()=>J(c.id),children:[e.jsx("div",{className:"entry-drag",children:e.jsx(dn,{className:"w-4 h-4"})}),e.jsxs("label",{className:"chk",children:[e.jsx("input",{type:"checkbox",checked:c.included,onChange:C=>U(c.id,C.target.checked)}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",children:e.jsx("path",{fill:"currentColor",d:"M8.143 13.314 4.829 10l-1.18 1.18 4.494 4.494 8-8-1.18-1.18z"})})})]}),e.jsx("input",{type:"number",className:"editor-input entry-amount",value:String(c.amount),onChange:C=>ne(c.id,C.target.value)}),e.jsx("input",{className:"editor-input entry-note",value:c.note||"",onChange:C=>ie(c.id,C.target.value)}),e.jsxs("button",{className:"btn btn-danger btn-sm flex items-center gap-1",onClick:()=>X(c.id),children:[e.jsx(Ye,{className:"w-4 h-4"}),"Удалить"]})]},c.id)),!w&&t.length===0&&e.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"Ещё нет записей."})]})]})})}function bn({value:o,onChange:N,fullWidth:u}){const[x,j]=l.useState(!1),v=l.useRef(null);l.useEffect(()=>{const f=w=>{v.current&&(v.current.contains(w.target)||j(!1))};return document.addEventListener("mousedown",f),()=>document.removeEventListener("mousedown",f)},[]);const h=o==="income"?"Доходы":"Расходы";return e.jsxs("div",{ref:v,className:`dd-wrap ${u?"block":""}`,children:[e.jsxs("button",{type:"button",className:`btn btn-outline dd-btn ${u?"full":""}`,style:{justifyContent:"flex-start"},onClick:()=>j(f=>!f),children:[e.jsx("span",{style:{pointerEvents:"none"},children:h}),e.jsx("span",{style:{marginLeft:"auto",opacity:.7},children:"▾"})]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dd-backdrop",onClick:()=>j(!1)}),e.jsxs("div",{className:`dd-menu ${u?"full":""}`,children:[e.jsx("div",{className:`dd-item ${o==="income"?"dd-active":""}`,onClick:()=>{N("income"),j(!1)},children:"Доходы"}),e.jsx("div",{className:`dd-item ${o==="expense"?"dd-active":""}`,onClick:()=>{N("expense"),j(!1)},children:"Расходы"})]})]})]})}const Ae=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function wn({open:o,onClose:N,year:u,incomeByMonth:x,expenseByMonth:j}){const v=x.reduce((p,t)=>p+t,0),h=j.reduce((p,t)=>p+t,0),f=v-h,w=Math.max(...x,...j,1);return e.jsxs(me,{open:o,onClose:N,title:`Годовая статистика — ${u}`,size:"lg",footer:e.jsx(cn,{right:e.jsx(rn,{variant:"secondary",onClick:N,children:"Закрыть"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-lg font-semibold",children:v})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-lg font-semibold",children:h})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-lg font-semibold",children:f})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Доходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:x.map((p,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Ae[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${p/w*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:p})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Расходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:j.map((p,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:Ae[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-red-500",style:{width:`${p/w*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:p})]},t))})]})]})]})}function En({value:o,years:N,onChange:u}){const[x,j]=l.useState(!1),v=l.useRef(null);return l.useEffect(()=>{function h(f){x&&f.key==="Escape"&&j(!1)}return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[x]),e.jsxs("div",{className:"dd-wrap",children:[e.jsx("button",{ref:v,className:"btn btn-outline dd-btn",onClick:()=>j(h=>!h),children:o}),x&&e.jsx("div",{className:"dd-backdrop",onClick:()=>j(!1)}),x&&e.jsx("div",{className:"dd-menu",children:N.map(h=>e.jsx("div",{className:"dd-item "+(h===o?"dd-active":""),onClick:()=>{u(h),j(!1)},children:h},h))})]})}function Sn({year:o,years:N,onYearChange:u,onAddCategory:x,onShowStats:j}){return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(En,{value:o,years:N,onChange:u})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{className:"btn flex items-center gap-2",onClick:x,children:[e.jsx(fe,{className:"w-4 h-4"}),"Добавить категорию"]}),e.jsxs("button",{className:"btn btn-outline text-gray-900 flex items-center gap-2",onClick:j,children:[e.jsx(un,{className:"w-4 h-4"}),"Годовая статистика"]})]})]})}function Oe({title:o,onAdd:N}){return e.jsxs("div",{className:"finance-section",children:[e.jsx("span",{children:o}),e.jsxs("button",{className:"btn btn-outline btn-xs text-gray-900 flex items-center gap-1",onClick:N,children:[e.jsx(fe,{className:"w-3 h-3"}),"Категория"]})]})}function Pe({type:o,row:N,values:u,isCurrentYear:x,currentMonth:j,hasChildren:v,collapsed:h,onToggleCollapse:f,onNameContext:w,onCellContext:p,onCellEdit:t,fmt:b,ctxCatHighlight:g,ctxCellHighlight:T}){const _={id:N.id,name:N.name,type:o};return e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell "+(g===N.id?"ctx-active":""),children:e.jsxs("div",{className:"cell-head cell-name flex items-center gap-2",children:[e.jsx("button",{className:"shrink-0 rounded-md hover:bg-gray-100 w-6 h-6 flex items-center justify-center",onClick:()=>f(N.id),title:v?h?"Развернуть":"Свернуть":"Категория",children:v?h?e.jsx(mn,{className:"w-4 h-4"}):e.jsx(fn,{className:"w-4 h-4"}):""}),e.jsx("span",{className:"flex-1 truncate",children:N.name}),e.jsx("button",{className:"icon-btn menu-btn",onClick:R=>w(R,_),onContextMenu:R=>w(R,_),"aria-label":"Действия с категорией",children:e.jsx(xn,{size:16})})]})}),u.map((R,A)=>e.jsx("div",{className:"finance-cell "+(x&&A===j?"col-current ":"")+(T&&T.type===o&&T.catId===N.id&&T.month===A?"ctx-active":""),onContextMenu:W=>p(W,o,N.id,A,R),children:e.jsx("button",{className:"cell-btn",onClick:()=>t(o,N.id,A),children:b(R)})},A))]})}function kn({pos:o,onClose:N,onRename:u,onAddSub:x,onDelete:j,canAddSub:v=!0}){const h=l.useRef([]),[f,w]=l.useState(0);return l.useEffect(()=>{const p=t=>{t.key==="Escape"&&(t.preventDefault(),N()),t.key==="ArrowDown"&&(t.preventDefault(),w(b=>Math.min(b+1,h.current.length-1))),t.key==="ArrowUp"&&(t.preventDefault(),w(b=>Math.max(b-1,0))),(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),h.current[f]?.click())};return document.addEventListener("keydown",p),()=>document.removeEventListener("keydown",p)},[f,N]),l.useEffect(()=>{h.current[0]?.focus()},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:p=>p.preventDefault(),"aria-hidden":!0}),e.jsxs("div",{className:"ctx-menu",style:{left:o.x,top:o.y,position:"fixed",zIndex:1e3},role:"menu","aria-label":"Действия с категорией",onContextMenu:p=>p.preventDefault(),children:[e.jsxs("div",{ref:p=>h.current[0]=p,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:u,"aria-label":"Переименовать категорию","data-active":f===0,children:[e.jsx(pn,{className:"w-4 h-4"}),"Переименовать"]}),v&&e.jsxs("div",{ref:p=>h.current[1]=p,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:x,"aria-label":"Добавить подкатегорию","data-active":f===1,children:[e.jsx(fe,{className:"w-4 h-4"}),"Подкатегория"]}),e.jsxs("div",{ref:p=>h.current[2]=p,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:j,"aria-label":"Удалить категорию","data-active":f===2,style:{color:"#dc2626"},children:[e.jsx(Ye,{className:"w-4 h-4"}),"Удалить"]})]})]})}function _n({pos:o,onClose:N,canCopy:u,hasClipboard:x,onCopy:j,onPaste:v}){console.log("CellMenu rendered with pos:",o);const h=l.useMemo(()=>{const t=[];return u&&t.push({label:"Копировать записи",onClick:j,aria:"Копировать записи",icon:e.jsx(hn,{className:"w-4 h-4"})}),x&&t.push({label:"Вставить записи (заменить)",onClick:v,aria:"Вставить записи (заменить)",icon:e.jsx(Nn,{className:"w-4 h-4"})}),t},[u,x,j,v]),f=l.useRef([]),[w,p]=l.useState(0);return l.useEffect(()=>{const t=b=>{b.key==="Escape"&&(b.preventDefault(),N()),b.key==="ArrowDown"&&(b.preventDefault(),p(g=>Math.min(g+1,h.length-1))),b.key==="ArrowUp"&&(b.preventDefault(),p(g=>Math.max(g-1,0))),(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),f.current[w]?.click())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[w,N,h.length]),l.useEffect(()=>{f.current[0]?.focus()},[h.length]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:N,onContextMenu:t=>t.preventDefault(),"aria-hidden":!0}),e.jsx("div",{className:"ctx-menu",style:{left:o.x,top:o.y,position:"fixed",zIndex:1e3},role:"menu","aria-label":"Действия с ячейкой",onContextMenu:t=>t.preventDefault(),children:h.map((t,b)=>e.jsxs("div",{ref:g=>f.current[b]=g,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:t.onClick,"aria-label":t.aria,"data-active":w===b,children:[t.icon,t.label]},b))})]})}function Te(o){const u={},x={};for(const f of o)u[f.id]=f,f.parent_id&&(x[f.parent_id]||=[]).push(f.id);const j={};function v(f){if(!x[f])return Array(12).fill(0);if(j[f])return j[f].slice();const w=Array(12).fill(0);for(const p of x[f]){const t=u[p];if(t)for(let g=0;g<12;g++)w[g]+=t.values?.[g]??0;const b=v(p);for(let g=0;g<12;g++)w[g]+=b[g]||0}return j[f]=w.slice(),w}const h={};for(const f of Object.keys(x))h[f]=v(f);return h}const Fe=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function Mn(){const o=l.useCallback((x,j,v)=>{try{localStorage.setItem(je.FINANCE(x,j),JSON.stringify(v))}catch(h){console.warn("Failed to write finance cache:",h)}},[]),N=l.useCallback((x,j)=>{try{const v=localStorage.getItem(je.FINANCE(x,j));return v?JSON.parse(v):null}catch(v){return console.warn("Failed to read finance cache:",v),null}},[]),u=l.useCallback((x,j)=>{try{localStorage.removeItem(je.FINANCE(x,j))}catch(v){console.warn("Failed to clear finance cache:",v)}},[]);return{writeCache:o,readCache:N,clearCache:u}}function Le(o,N){return N.find(u=>u.id===o)}const le=o=>gn(o);function Yn(){const{handleError:o,handleSuccess:N}=jn(),{userId:u}=vn(),{writeCache:x,readCache:j}=Mn(),{createSimpleFooter:v,createDangerFooter:h}=on(),f=new Date,w=f.getFullYear(),p=f.getMonth(),[t,b]=l.useState(w),[g,T]=l.useState([]),[_,R]=l.useState([]),[A,W]=l.useState({}),ce=l.useMemo(()=>Me(g,A),[g,A]),ve=l.useMemo(()=>Me(_,A),[_,A]),[xe,K]=l.useState(!0),[Z,L]=l.useState(!1),[ee,Y]=l.useState(V.INCOME),[ne,ie]=l.useState(""),[U,X]=l.useState(null),[re,te]=l.useState(!1),[J,c]=l.useState(null),[C,y]=l.useState(0),[E,S]=l.useState(!1),[pe,B]=l.useState({x:0,y:0}),[I,ye]=l.useState(null),[he,q]=l.useState(!1),[qe,$e]=l.useState({x:0,y:0}),[Ne,Ue]=l.useState(null),[G,Xe]=l.useState(null),[Be,Ce]=l.useState(!1),[Ke,ze]=l.useState(null),[He,be]=l.useState(!1),[Ve,se]=l.useState(!1),[ge,we]=l.useState(""),[We,oe]=l.useState(!1),[Ee,z]=l.useState(null),[Se,$]=l.useState(null);l.useEffect(()=>{if(!u)return;const n=j(u,t);n?(T(n.income??[]),R(n.expense??[]),K(!1)):K(!0),(async()=>{const[a,i]=await Promise.all([P.from("finance_categories").select("id,name,type,parent_id").order("created_at",{ascending:!0}),P.from("finance_entries").select("category_id,month,amount,included").eq("year",t)]);if(a.error||i.error){o(a.error||i.error,"Загрузка финансовых данных"),K(!1);return}const s=a.data||[],d=i.data||[],r={};for(const m of s)r[m.id]=Array(ae).fill(0);for(const m of d){if(!m.included)continue;const O=Math.min(11,Math.max(0,m.month-1)),D=m.category_id;r[D]||(r[D]=Array(ae).fill(0)),r[D][O]+=Number(m.amount)||0}const k=s.filter(m=>m.type===V.INCOME).map(m=>({id:m.id,name:m.name,parent_id:m.parent_id,values:r[m.id]||Array(ae).fill(0)})),M=s.filter(m=>m.type===V.EXPENSE).map(m=>({id:m.id,name:m.name,parent_id:m.parent_id,values:r[m.id]||Array(ae).fill(0)}));T(k),R(M),K(!1),x(u,t,{income:k.map(({id:m,name:O,values:D,parent_id:H})=>({id:m,name:O,values:D,parent_id:H})),expense:M.map(({id:m,name:O,values:D,parent_id:H})=>({id:m,name:O,values:D,parent_id:H}))})})()},[u,t]);const de=l.useMemo(()=>Fe.map((n,a)=>g.reduce((i,s)=>i+(s.values?.[a]??0),0)),[g]),ue=l.useMemo(()=>Fe.map((n,a)=>_.reduce((i,s)=>i+(s.values?.[a]??0),0)),[_]),Je=l.useMemo(()=>de.map((n,a)=>n-ue[a]),[de,ue]);l.useMemo(()=>{const n={};return g.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[g]),l.useMemo(()=>{const n={};return _.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[_]);const ke=l.useMemo(()=>Te(g),[g]),_e=l.useMemo(()=>Te(_),[_]);function Me(n,a){const i=n.filter(r=>!r.parent_id),s={};n.forEach(r=>{r.parent_id&&(s[r.parent_id]||=[]).push(r)});const d=[];return i.forEach(r=>{d.push(r),a[r.id]||(s[r.id]||[]).forEach(k=>d.push(k))}),n.filter(r=>r.parent_id&&!i.find(k=>k.id===r.parent_id)).forEach(r=>d.push(r)),d}async function Ge(){const n=ne.trim();if(!n||!u)return;const a=ee,i={user_id:u,type:a,name:n};U&&(i.parent_id=U.id);const{data:s,error:d}=await P.from("finance_categories").insert(i).select("id,name,type,parent_id").single();if(d){o(d,"Создание категории");return}const r={id:s.id,name:s.name,type:s.type,parent_id:s.parent_id,values:Array(ae).fill(0)};if(a===V.INCOME){const k=[g,r];T(k),x(u,t,{income:k.map(({id:M,name:m,values:O,parent_id:D})=>({id:M,name:m,values:O,parent_id:D})),expense:_.map(({id:M,name:m,values:O,parent_id:D})=>({id:M,name:m,values:O,parent_id:D}))})}else{const k=[_,r];R(k),x(u,t,{income:g.map(({id:M,name:m,values:O,parent_id:D})=>({id:M,name:m,values:O,parent_id:D})),expense:k.map(({id:M,name:m,values:O,parent_id:D})=>({id:M,name:m,values:O,parent_id:D}))})}N(`Категория "${n}" создана`),L(!1),ie(""),Y(V.INCOME),X(null)}function Ie(n,a){n.preventDefault(),n.stopPropagation(),he&&q(!1),$(null),z(a.id),console.log("CATEGORY CONTEXT MENU OPENED!",{cat:a});const i=n.clientX+10,s=n.clientY+10;console.log("Category menu position:",{x:i,y:s,clientX:n.clientX,clientY:n.clientY}),B({x:i,y:s}),ye(a),S(!0)}function Qe(){S(!1),ye(null),z(null)}async function Ze(){const n=ge.trim();if(!n||!I){se(!1);return}const{error:a}=await P.from("finance_categories").update({name:n}).eq("id",I.id);if(a){o(a,"Создание категории");return}if(I.type==="income"){const i=g.map(s=>s.id===I.id?{...s,name:n}:s);T(i),x(u,t,{income:i.map(({id:s,name:d,values:r,parent_id:k})=>({id:s,name:d,values:r,parent_id:k})),expense:_.map(({id:s,name:d,values:r,parent_id:k})=>({id:s,name:d,values:r,parent_id:k}))})}else{const i=_.map(s=>s.id===I.id?{...s,name:n}:s);R(i),x(u,t,{income:g.map(({id:s,name:d,values:r,parent_id:k})=>({id:s,name:d,values:r,parent_id:k})),expense:i.map(({id:s,name:d,values:r,parent_id:k})=>({id:s,name:d,values:r,parent_id:k}))})}se(!1)}async function en(){if(!I)return;const{error:n}=await P.from("finance_categories").delete().eq("id",I.id);if(n){o(n,"Создание категории");return}if(I.type==="income"){const a=g.filter(i=>i.id!==I.id);T(a),x(u,t,{income:a.map(({id:i,name:s,values:d,parent_id:r})=>({id:i,name:s,values:d,parent_id:r})),expense:_.map(({id:i,name:s,values:d,parent_id:r})=>({id:i,name:s,values:d,parent_id:r}))})}else{const a=_.filter(i=>i.id!==I.id);R(a),x(u,t,{income:g.map(({id:i,name:s,values:d,parent_id:r})=>({id:i,name:s,values:d,parent_id:r})),expense:a.map(({id:i,name:s,values:d,parent_id:r})=>({id:i,name:s,values:d,parent_id:r}))})}oe(!1)}async function De(n,a,i,s,d){n.preventDefault(),n.stopPropagation(),E&&S(!1),he&&q(!1),z(null),$({type:a,catId:i,month:s});const r={category_id:i,year:t,month:s+1},k=!!G&&G.length>0;if(!k&&(!d||d===0)){$(null);return}console.log("CELL CONTEXT MENU OPENED!",{catId:i,type:a,month:s});const M=n.clientX+10,m=n.clientY+10;console.log("Menu position:",{x:M,y:m,clientX:n.clientX,clientY:n.clientY}),Ue({catId:i,type:a,month:s}),$e({x:M,y:m}),Ce(!1),q(!0);const{data:O}=await P.from("finance_entries").select("amount, note, included, position").match(r).order("position",{ascending:!0}).order("created_at",{ascending:!0}),D=(O||[]).map(H=>({amount:Number(H.amount)||0,note:H.note,included:!!H.included,position:H.position??0}));if(ze(D),!D.length&&!k){q(!1),$(null);return}Ce(D.length>0)}async function nn(){const n=Ke||[];if(!n.length){q(!1),$(null);return}Xe(n.slice());try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{}q(!1),$(null)}async function tn(){if(!Ne||!G||!G.length||!u)return;const{catId:n,type:a,month:i}=Ne,s={category_id:n,year:t,month:i+1};await P.from("finance_entries").delete().match(s);const d=G.map((M,m)=>({where:s,user_id:u,amount:M.amount,note:M.note,included:M.included,position:m}));await P.from("finance_entries").insert(d);const r=d.filter(M=>M.included).reduce((M,m)=>M+(m.amount||0),0),k=M=>M.map(m=>m.id===n?{...m,values:m.values.map((O,D)=>D===i?r:O)}:m);a==="income"?T(k(g)):R(k(_)),q(!1),$(null)}if(l.useEffect(()=>{const n=i=>{i.key==="Escape"&&(S(!1),q(!1),z(null),$(null))},a=()=>{S(!1),q(!1),z(null),$(null)};return window.addEventListener("keydown",n),window.addEventListener("wheel",a,{passive:!0}),()=>{window.removeEventListener("keydown",n),window.removeEventListener("wheel",a)}},[]),xe)return e.jsx("div",{className:"p-4",children:e.jsx(yn,{rows:10})});const Q=t===w,sn=Array.from({length:7}).map((n,a)=>w-3+a);return e.jsxs(an.Fragment,{children:[e.jsxs("div",{className:"space-y-6 finance-page",onContextMenu:n=>{n.preventDefault()},children:[e.jsx(Sn,{year:t,years:sn,onYearChange:b,onAddCategory:()=>{Y(V.INCOME),X(null),L(!0)},onShowStats:()=>be(!0)}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Категория"})}),Re.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===p?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsx(Oe,{title:"Доходы",onAdd:()=>{Y(V.INCOME),X(null),L(!0)}}),ce.map(n=>{const a=!!ke[n.id],i=a?ke[n.id]:n.values;return e.jsx(Pe,{type:"income",row:n,values:i,isCurrentYear:Q,currentMonth:p,hasChildren:a,collapsed:!!A[n.id],onToggleCollapse:s=>W(d=>({...d,[s]:!d[s]})),onNameContext:(s,d)=>Ie(s,d),onCellContext:De,onCellEdit:(s,d,r)=>{c({id:d,name:n.name,type:s}),y(r),te(!0)},fmt:le,ctxCatHighlight:Ee,ctxCellHighlight:Se})}),e.jsx(Oe,{title:"Расходы",onAdd:()=>{Y(V.EXPENSE),X(null),L(!0)}}),ve.map(n=>{const a=!!_e[n.id],i=a?_e[n.id]:n.values;return e.jsx(Pe,{type:"expense",row:n,values:i,isCurrentYear:Q,currentMonth:p,hasChildren:a,collapsed:!!A[n.id],onToggleCollapse:s=>W(d=>({...d,[s]:!d[s]})),onNameContext:(s,d)=>Ie(s,d),onCellContext:De,onCellEdit:(s,d,r)=>{c({id:d,name:n.name,type:s}),y(r),te(!0)},fmt:le,ctxCatHighlight:Ee,ctxCellHighlight:Se})})]}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Показатель"})}),Re.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===p?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Доходы"})}),de.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===p?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:le(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Расходы"})}),ue.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===p?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:le(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:700},children:"Баланс"})}),Je.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===p?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",style:{fontWeight:700},children:le(n)})},a))]})]})]}),E&&I&&e.jsx(kn,{pos:pe,canAddSub:!(Le(I.id,g)||Le(I.id,_))?.parent_id,onClose:Qe,onRename:()=>{we(I.name),se(!0),S(!1),z(null)},onAddSub:()=>{Y(I.type),X({id:I.id,name:I.name}),L(!0),S(!1),z(null)},onDelete:()=>{oe(!0),S(!1),z(null)}}),he&&Ne&&e.jsx(_n,{pos:qe,onClose:()=>{q(!1),$(null)},canCopy:Be,hasClipboard:!!(G&&G.length>0),onCopy:nn,onPaste:tn}),e.jsxs(me,{open:Z,onClose:()=>{L(!1),X(null)},title:U?"Новая подкатегория":"Новая категория",subtitle:U?`Родитель: ${U.name}`:void 0,footer:v({label:U?"Добавить подкатегорию":"Добавить категорию",onClick:Ge,disabled:!ne.trim()},{label:"Отмена",onClick:()=>{L(!1),X(null)}}),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Тип"}),e.jsx("div",{className:"flex-1",children:e.jsx(bn,{value:ee,onChange:Y,fullWidth:!0})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Название"}),e.jsx("input",{value:ne,onChange:n=>ie(n.target.value),placeholder:U?"Напр. Коммунальные":"Напр. Жильё",className:"border rounded-lg px-3 py-2 text-sm flex-1"})]})]}),e.jsx(me,{open:Ve,onClose:()=>se(!1),title:"Переименовать категорию",footer:v({label:"Сохранить",onClick:Ze,disabled:!ge.trim()},{label:"Отмена",onClick:()=>se(!1)}),children:e.jsx("input",{value:ge,onChange:n=>we(n.target.value),className:"border rounded-lg px-3 py-2 text-sm w-full",autoFocus:!0})}),e.jsx(me,{open:We,onClose:()=>oe(!1),title:"Удалить категорию?",footer:h({label:"Удалить",onClick:en},{label:"Отмена",onClick:()=>oe(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Все записи в этой категории будут удалены без возможности восстановления."})}),re&&J&&e.jsx(Cn,{open:re,onClose:()=>te(!1),userId:u,categoryId:J.id,categoryName:J.name,monthIndex:C,year:t,onApply:n=>{const a=i=>i.map(s=>s.id===J.id?{...s,values:s.values.map((d,r)=>r===C?n:d)}:s);J.type==="income"?T(a(g)):R(a(_))}}),e.jsx(wn,{open:He,onClose:()=>be(!1),year:t,incomeByMonth:de,expenseByMonth:ue})]})}export{Yn as default};
