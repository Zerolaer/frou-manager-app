import{j as e,s as P}from"./index-C94S2Pq2.js";import{r as l,R as xn}from"./vendor-CqGws4Uo.js";import{M as hn,U as ge,a as pn,b as gn,u as Nn}from"./ModalSystem-CDKUOn7n.js";import{P as Ne,a as vn,T as ze,b as jn,c as yn,d as Cn,E as bn,e as wn,f as En,g as Sn}from"./icons-HVSKy6uN.js";import{f as kn}from"./format-CfBjB5Ts.js";import{u as _n}from"./errorHandler-DqUfoQxQ.js";import{u as Mn}from"./useSupabaseAuth-BE5_Bh0U.js";import{C as Ee,F as V,M as ie,a as Ye}from"./constants-Dv7MHcu-.js";import"./supabase-BmeMSZYH.js";function T({className:u=""}){return e.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${u}`})}function In({rows:u=6}){return e.jsx("div",{className:"space-y-2",children:Array.from({length:u}).map((g,m)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx(T,{className:"h-6 col-span-3"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"}),e.jsx(T,{className:"h-6 col-span-1"})]},m))})}function Rn({open:u,onClose:g,userId:m,categoryId:x,categoryName:v,monthIndex:j,year:p,onApply:f}){const[S,h]=l.useState(!0),[t,b]=l.useState([]),[N,F]=l.useState(""),[I,A]=l.useState(""),O=l.useRef(null),X=l.useRef({}),oe=(i,C,y=350)=>{clearTimeout(X.current[i]),X.current[i]=setTimeout(C,y)},ve=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][j];l.useMemo(()=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"EUR"}),[]);const W=l.useRef(null);l.useEffect(()=>{u&&(async()=>{h(!0);const{data:i,error:C}=await P.from("finance_entries").select("id, amount, note, included, position, created_at").eq("category_id",x).eq("year",p).eq("month",j+1).order("position",{ascending:!0}).order("created_at",{ascending:!0});if(C){console.error(C),h(!1);return}const y=(i||[]).map(k=>({id:k.id,amount:Number(k.amount)||0,note:k.note,included:!!k.included,position:k.position??0}));b(y),h(!1)})()},[u,x,j,p]),l.useEffect(()=>{u&&O.current&&setTimeout(()=>{O.current?.focus()},100)},[u]);function ee(i){return i.reduce((C,y)=>C+(y.included?y.amount:0),0)}async function q(){const i=Number(String(N).replace(",","."));if(!m||isNaN(i))return;const C={user_id:m,category_id:x,year:p,month:j+1,amount:i,note:I,included:!0,position:t.length},{data:y,error:k}=await P.from("finance_entries").insert(C).select("id, amount, note, included, position").single();if(k){console.error(k);return}const _=[...t,{id:y.id,amount:Number(y.amount)||0,note:y.note,included:!!y.included,position:y.position??t.length}];b(_),F(""),A(""),f(ee(_)),setTimeout(()=>{O.current?.focus()},50)}function ne(i){i.key==="Enter"&&(i.preventDefault(),q())}function Y(i,C){b(y=>{const k=y.map(_=>_.id===i?{..._,...C}:_);return f(ee(k)),k})}function te(i,C){const y=Number(String(C).replace(",","."));Y(i,{amount:isNaN(y)?0:y}),oe("amt:"+i,async()=>{const{error:k}=await P.from("finance_entries").update({amount:isNaN(y)?0:y}).eq("id",i);k&&console.error(k)})}function de(i,C){Y(i,{note:C}),oe("note:"+i,async()=>{const{error:y}=await P.from("finance_entries").update({note:C}).eq("id",i);y&&console.error(y)})}async function H(i,C){Y(i,{included:C});const{error:y}=await P.from("finance_entries").update({included:C}).eq("id",i);y&&console.error(y)}async function K(i){const{error:C}=await P.from("finance_entries").delete().eq("id",i);if(C){console.error(C);return}const y=t.filter(k=>k.id!==i);y.forEach((k,_)=>{k.position=_}),b(y),f(ee(y)),await Promise.all(y.map((k,_)=>P.from("finance_entries").update({position:_}).eq("id",k.id)))}function ue(i){W.current=i}function se(i){i.preventDefault()}async function J(i){const C=W.current;if(W.current=null,!C||C===i)return;const y=t.findIndex(U=>U.id===C),k=t.findIndex(U=>U.id===i);if(y<0||k<0)return;const _=t.slice(),[je]=_.splice(y,1);_.splice(k,0,je),_.forEach((U,D)=>{U.position=D}),b(_),f(ee(_)),await Promise.all(_.map((U,D)=>P.from("finance_entries").update({position:D}).eq("id",U.id)))}return e.jsx(hn,{open:u,onClose:g,title:e.jsxs("span",{bodyClassName:"p-0",children:[e.jsx("b",{children:v})," · ",ve," ",p]}),footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn btn-outline",onClick:g,children:"Закрыть"})}),size:"md",children:e.jsxs("div",{className:"editor-body",children:[S&&e.jsx("div",{className:"loading-overlay",children:"Загрузка…"}),e.jsxs("div",{className:"editor-add",children:[e.jsx("input",{ref:O,type:"number",placeholder:"Сумма (€)",value:N,onChange:i=>F(i.target.value),onKeyPress:ne,className:"editor-input number"}),e.jsx("input",{placeholder:"Описание (необязательно)",value:I,onChange:i=>A(i.target.value),onKeyPress:ne,className:"editor-input text"}),e.jsxs("button",{className:"btn btn-outline flex items-center gap-2",onClick:q,children:[e.jsx(Ne,{className:"w-4 h-4"}),"Добавить"]})]}),e.jsxs("div",{children:[t.map(i=>e.jsxs("div",{className:"entry-row "+(i.included?"":"entry-disabled"),draggable:!0,onDragStart:()=>ue(i.id),onDragOver:se,onDrop:()=>J(i.id),children:[e.jsx("div",{className:"entry-drag",children:e.jsx(vn,{className:"w-4 h-4"})}),e.jsxs("label",{className:"chk",children:[e.jsx("input",{type:"checkbox",checked:i.included,onChange:C=>H(i.id,C.target.checked)}),e.jsx("span",{className:"box",children:e.jsx("svg",{className:"icon",viewBox:"0 0 20 20",children:e.jsx("path",{fill:"currentColor",d:"M8.143 13.314 4.829 10l-1.18 1.18 4.494 4.494 8-8-1.18-1.18z"})})})]}),e.jsx("input",{type:"number",className:"editor-input entry-amount",value:String(i.amount),onChange:C=>te(i.id,C.target.value)}),e.jsx("input",{className:"editor-input entry-note",value:i.note||"",onChange:C=>de(i.id,C.target.value)}),e.jsxs("button",{className:"btn btn-danger btn-sm flex items-center gap-1",onClick:()=>K(i.id),children:[e.jsx(ze,{className:"w-4 h-4"}),"Удалить"]})]},i.id)),!S&&t.length===0&&e.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"Ещё нет записей."})]})]})})}function Dn({value:u,onChange:g,fullWidth:m}){const[x,v]=l.useState(!1),j=l.useRef(null);l.useEffect(()=>{const f=S=>{j.current&&(j.current.contains(S.target)||v(!1))};return document.addEventListener("mousedown",f),()=>document.removeEventListener("mousedown",f)},[]);const p=u==="income"?"Доходы":"Расходы";return e.jsxs("div",{ref:j,className:`dd-wrap ${m?"block":""}`,children:[e.jsxs("button",{type:"button",className:`btn btn-outline dd-btn ${m?"full":""}`,style:{justifyContent:"flex-start"},onClick:()=>v(f=>!f),children:[e.jsx("span",{style:{pointerEvents:"none"},children:p}),e.jsx("span",{style:{marginLeft:"auto",opacity:.7},children:"▾"})]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dd-backdrop",onClick:()=>v(!1)}),e.jsxs("div",{className:`dd-menu ${m?"full":""}`,children:[e.jsx("div",{className:`dd-item ${u==="income"?"dd-active":""}`,onClick:()=>{g("income"),v(!1)},children:"Доходы"}),e.jsx("div",{className:`dd-item ${u==="expense"?"dd-active":""}`,onClick:()=>{g("expense"),v(!1)},children:"Расходы"})]})]})]})}const $e=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function An({open:u,onClose:g,year:m,incomeByMonth:x,expenseByMonth:v}){const j=x.reduce((h,t)=>h+t,0),p=v.reduce((h,t)=>h+t,0),f=j-p,S=Math.max(...x,...v,1);return e.jsxs(ge,{open:u,onClose:g,title:`Годовая статистика — ${m}`,size:"lg",footer:e.jsx(pn,{right:e.jsx(gn,{variant:"secondary",onClick:g,children:"Закрыть"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Доходы"}),e.jsx("div",{className:"text-lg font-semibold",children:j})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Расходы"}),e.jsx("div",{className:"text-lg font-semibold",children:p})]}),e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Баланс"}),e.jsx("div",{className:"text-lg font-semibold",children:f})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Доходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:x.map((h,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:$e[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${h/S*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:h})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Расходы по месяцам"}),e.jsx("div",{className:"space-y-2",children:v.map((h,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 text-xs text-gray-500",children:$e[t]}),e.jsx("div",{className:"flex-1 h-2 bg-gray-100 rounded",children:e.jsx("div",{className:"h-2 rounded bg-red-500",style:{width:`${h/S*100}%`}})}),e.jsx("div",{className:"w-14 text-right text-xs",children:h})]},t))})]})]})]})}function On({value:u,years:g,onChange:m}){const[x,v]=l.useState(!1),j=l.useRef(null);return l.useEffect(()=>{function p(f){x&&f.key==="Escape"&&v(!1)}return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[x]),e.jsxs("div",{className:"dd-wrap",children:[e.jsx("button",{ref:j,className:"btn btn-outline dd-btn",onClick:()=>v(p=>!p),children:u}),x&&e.jsx("div",{className:"dd-backdrop",onClick:()=>v(!1)}),x&&e.jsx("div",{className:"dd-menu",children:g.map(p=>e.jsx("div",{className:"dd-item "+(p===u?"dd-active":""),onClick:()=>{m(p),v(!1)},children:p},p))})]})}function Pn({year:u,years:g,onYearChange:m,onAddCategory:x,onShowStats:v}){return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(On,{value:u,years:g,onChange:m})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{className:"btn flex items-center gap-2",onClick:x,children:[e.jsx(Ne,{className:"w-4 h-4"}),"Добавить категорию"]}),e.jsxs("button",{className:"btn btn-outline text-gray-900 flex items-center gap-2",onClick:v,children:[e.jsx(jn,{className:"w-4 h-4"}),"Годовая статистика"]})]})]})}function Be({title:u,onAdd:g}){return e.jsxs("div",{className:"finance-section",children:[e.jsx("span",{children:u}),e.jsxs("button",{className:"btn btn-outline btn-xs text-gray-900 flex items-center gap-1",onClick:g,children:[e.jsx(Ne,{className:"w-3 h-3"}),"Категория"]})]})}function He({type:u,row:g,values:m,isCurrentYear:x,currentMonth:v,hasChildren:j,collapsed:p,onToggleCollapse:f,onNameContext:S,onCellContext:h,onCellEdit:t,fmt:b,ctxCatHighlight:N,ctxCellHighlight:F}){const I={id:g.id,name:g.name,type:u};return e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell "+(N===g.id?"ctx-active":""),children:e.jsxs("div",{className:"cell-head cell-name flex items-center gap-2",children:[e.jsx("button",{className:"shrink-0 rounded-md hover:bg-gray-100 w-6 h-6 flex items-center justify-center",onClick:()=>f(g.id),title:j?p?"Развернуть":"Свернуть":"Категория",children:j?p?e.jsx(yn,{className:"w-4 h-4"}):e.jsx(Cn,{className:"w-4 h-4"}):""}),e.jsx("span",{className:"flex-1 truncate",children:g.name}),e.jsx("button",{className:"icon-btn menu-btn",onClick:A=>S(A,I),onContextMenu:A=>S(A,I),"aria-label":"Действия с категорией",children:e.jsx(bn,{size:16})})]})}),m.map((A,O)=>e.jsx("div",{className:"finance-cell "+(x&&O===v?"col-current ":"")+(F&&F.type===u&&F.catId===g.id&&F.month===O?"ctx-active":""),onContextMenu:X=>h(X,u,g.id,O,A),children:e.jsx("button",{className:"cell-btn",onClick:()=>t(u,g.id,O),children:b(A)})},O))]})}function Fn({pos:u,onClose:g,onRename:m,onAddSub:x,onDelete:v,canAddSub:j=!0}){const p=l.useRef([]),[f,S]=l.useState(0);return l.useEffect(()=>{const h=t=>{t.key==="Escape"&&(t.preventDefault(),g()),t.key==="ArrowDown"&&(t.preventDefault(),S(b=>Math.min(b+1,p.current.length-1))),t.key==="ArrowUp"&&(t.preventDefault(),S(b=>Math.max(b-1,0))),(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),p.current[f]?.click())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[f,g]),l.useEffect(()=>{p.current[0]?.focus()},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:g,onContextMenu:h=>h.preventDefault(),"aria-hidden":!0}),e.jsxs("div",{className:"ctx-menu",style:{left:u.x,top:u.y,position:"fixed",zIndex:1e3},role:"menu","aria-label":"Действия с категорией",onContextMenu:h=>h.preventDefault(),children:[e.jsxs("div",{ref:h=>p.current[0]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:m,"aria-label":"Переименовать категорию","data-active":f===0,children:[e.jsx(wn,{className:"w-4 h-4"}),"Переименовать"]}),j&&e.jsxs("div",{ref:h=>p.current[1]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:x,"aria-label":"Добавить подкатегорию","data-active":f===1,children:[e.jsx(Ne,{className:"w-4 h-4"}),"Подкатегория"]}),e.jsxs("div",{ref:h=>p.current[2]=h,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:v,"aria-label":"Удалить категорию","data-active":f===2,style:{color:"#dc2626"},children:[e.jsx(ze,{className:"w-4 h-4"}),"Удалить"]})]})]})}function Tn({pos:u,onClose:g,canCopy:m,hasClipboard:x,onCopy:v,onPaste:j}){const p=l.useMemo(()=>{const t=[];return m&&t.push({label:"Копировать записи",onClick:v,aria:"Копировать записи",icon:e.jsx(En,{className:"w-4 h-4"})}),x&&t.push({label:"Вставить записи (заменить)",onClick:j,aria:"Вставить записи (заменить)",icon:e.jsx(Sn,{className:"w-4 h-4"})}),t},[m,x,v,j]),f=l.useRef([]),[S,h]=l.useState(0);return l.useEffect(()=>{const t=b=>{b.key==="Escape"&&(b.preventDefault(),g()),b.key==="ArrowDown"&&(b.preventDefault(),h(N=>Math.min(N+1,p.length-1))),b.key==="ArrowUp"&&(b.preventDefault(),h(N=>Math.max(N-1,0))),(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),f.current[S]?.click())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[S,g,p.length]),l.useEffect(()=>{f.current[0]?.focus()},[p.length]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"ctx-backdrop",onClick:g,onContextMenu:t=>t.preventDefault(),"aria-hidden":!0}),e.jsx("div",{className:"ctx-menu",style:{left:u.x,top:u.y,position:"fixed",zIndex:1e3},role:"menu","aria-label":"Действия с ячейкой",onContextMenu:t=>t.preventDefault(),children:p.map((t,b)=>e.jsxs("div",{ref:N=>f.current[b]=N,className:"ctx-item",role:"menuitem",tabIndex:0,onClick:t.onClick,"aria-label":t.aria,"data-active":S===b,children:[t.icon,t.label]},b))})]})}function Ke(u){const m={},x={};for(const f of u)m[f.id]=f,f.parent_id&&(x[f.parent_id]||=[]).push(f.id);const v={};function j(f){if(!x[f])return Array(12).fill(0);if(v[f])return v[f].slice();const S=Array(12).fill(0);for(const h of x[f]){const t=m[h];if(t)for(let N=0;N<12;N++)S[N]+=t.values?.[N]??0;const b=j(h);for(let N=0;N<12;N++)S[N]+=b[N]||0}return v[f]=S.slice(),S}const p={};for(const f of Object.keys(x))p[f]=j(f);return p}const Ue=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];function Ln(){const u=l.useCallback((x,v,j)=>{try{localStorage.setItem(Ee.FINANCE(x,v),JSON.stringify(j))}catch(p){console.warn("Failed to write finance cache:",p)}},[]),g=l.useCallback((x,v)=>{try{const j=localStorage.getItem(Ee.FINANCE(x,v));return j?JSON.parse(j):null}catch(j){return console.warn("Failed to read finance cache:",j),null}},[]),m=l.useCallback((x,v)=>{try{localStorage.removeItem(Ee.FINANCE(x,v))}catch(j){console.warn("Failed to clear finance cache:",j)}},[]);return{writeCache:u,readCache:g,clearCache:m}}function We(u,g){return g.find(m=>m.id===u)}const re=u=>kn(u);function Vn(){const{handleError:u,handleSuccess:g}=_n(),{userId:m}=Mn(),{writeCache:x,readCache:v}=Ln(),{createSimpleFooter:j,createDangerFooter:p}=Nn(),f=new Date,S=f.getFullYear(),h=f.getMonth(),[t,b]=l.useState(S),[N,F]=l.useState([]),[I,A]=l.useState([]),[O,X]=l.useState({}),oe=l.useMemo(()=>Pe(N,O),[N,O]),Se=l.useMemo(()=>Pe(I,O),[I,O]),[ve,W]=l.useState(!0),[ee,q]=l.useState(!1),[ne,Y]=l.useState(V.INCOME),[te,de]=l.useState(""),[H,K]=l.useState(null),[ue,se]=l.useState(!1),[J,i]=l.useState(null),[C,y]=l.useState(0),[k,_]=l.useState(!1),[je,U]=l.useState({x:0,y:0}),[D,ke]=l.useState(null),[ye,$]=l.useState(!1),[Ve,Xe]=l.useState({x:0,y:0}),[Ce,Je]=l.useState(null),[G,Ge]=l.useState(null),[Qe,_e]=l.useState(!1),[Ze,en]=l.useState(null),[nn,Me]=l.useState(!1),[tn,ae]=l.useState(!1),[be,Ie]=l.useState(""),[sn,me]=l.useState(!1),[Re,z]=l.useState(null),[De,B]=l.useState(null);l.useEffect(()=>{if(!m)return;const n=v(m,t);n?(F(n.income??[]),A(n.expense??[]),W(!1)):W(!0),(async()=>{const[a,o]=await Promise.all([P.from("finance_categories").select("id,name,type,parent_id").order("created_at",{ascending:!0}),P.from("finance_entries").select("category_id,month,amount,included").eq("year",t)]);if(a.error||o.error){u(a.error||o.error,"Загрузка финансовых данных"),W(!1);return}const s=a.data||[],r=o.data||[],c={};for(const d of s)c[d.id]=Array(ie).fill(0);for(const d of r){if(!d.included)continue;const R=Math.min(11,Math.max(0,d.month-1)),E=d.category_id;c[E]||(c[E]=Array(ie).fill(0)),c[E][R]+=Number(d.amount)||0}const w=s.filter(d=>d.type===V.INCOME).map(d=>({id:d.id,name:d.name,parent_id:d.parent_id,values:c[d.id]||Array(ie).fill(0)})),M=s.filter(d=>d.type===V.EXPENSE).map(d=>({id:d.id,name:d.name,parent_id:d.parent_id,values:c[d.id]||Array(ie).fill(0)}));F(w),A(M),W(!1),x(m,t,{income:w.map(({id:d,name:R,values:E,parent_id:L})=>({id:d,name:R,values:E,parent_id:L})),expense:M.map(({id:d,name:R,values:E,parent_id:L})=>({id:d,name:R,values:E,parent_id:L}))})})()},[m,t]);const fe=l.useMemo(()=>Ue.map((n,a)=>N.reduce((o,s)=>o+(s.values?.[a]??0),0)),[N]),xe=l.useMemo(()=>Ue.map((n,a)=>I.reduce((o,s)=>o+(s.values?.[a]??0),0)),[I]),an=l.useMemo(()=>fe.map((n,a)=>n-xe[a]),[fe,xe]);l.useMemo(()=>{const n={};return N.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[N]),l.useMemo(()=>{const n={};return I.forEach(a=>{a.parent_id&&(n[a.parent_id]=(n[a.parent_id]||0)+1)}),n},[I]);const Ae=l.useMemo(()=>Ke(N),[N]),Oe=l.useMemo(()=>Ke(I),[I]);function Pe(n,a){const o=n.filter(c=>!c.parent_id),s={};n.forEach(c=>{c.parent_id&&(s[c.parent_id]||=[]).push(c)});const r=[];return o.forEach(c=>{r.push(c),a[c.id]||(s[c.id]||[]).forEach(w=>r.push(w))}),n.filter(c=>c.parent_id&&!o.find(w=>w.id===c.parent_id)).forEach(c=>r.push(c)),r}async function ln(){const n=te.trim();if(!n||!m)return;const a=ne,o={user_id:m,type:a,name:n};H&&(o.parent_id=H.id);const{data:s,error:r}=await P.from("finance_categories").insert(o).select("id,name,type,parent_id").single();if(r){u(r,"Создание категории");return}const c={id:s.id,name:s.name,type:s.type,parent_id:s.parent_id,values:Array(ie).fill(0)};if(a===V.INCOME){const w=[N,c];F(w),x(m,t,{income:w.map(({id:M,name:d,values:R,parent_id:E})=>({id:M,name:d,values:R,parent_id:E})),expense:I.map(({id:M,name:d,values:R,parent_id:E})=>({id:M,name:d,values:R,parent_id:E}))})}else{const w=[I,c];A(w),x(m,t,{income:N.map(({id:M,name:d,values:R,parent_id:E})=>({id:M,name:d,values:R,parent_id:E})),expense:w.map(({id:M,name:d,values:R,parent_id:E})=>({id:M,name:d,values:R,parent_id:E}))})}g(`Категория "${n}" создана`),q(!1),de(""),Y(V.INCOME),K(null)}function Fe(n,a){n.preventDefault(),n.stopPropagation(),ye&&$(!1),B(null),z(a.id);const o=200,s=120,r=8,c=16,w=window.innerWidth,M=window.innerHeight,d=n.currentTarget.getBoundingClientRect(),R=d.left+d.width/2,E=d.top+d.height/2;let L=R+r,Z=E+r;L+o>w-c&&(L=R-o-r),Z+s>M-c&&(Z=E-s-r),L<c&&(L=c),Z<c&&(Z=c),U({x:L,y:Z}),ke(a),_(!0)}function cn(){_(!1),ke(null),z(null)}async function rn(){const n=be.trim();if(!n||!D){ae(!1);return}const{error:a}=await P.from("finance_categories").update({name:n}).eq("id",D.id);if(a){u(a,"Создание категории");return}if(D.type==="income"){const o=N.map(s=>s.id===D.id?{...s,name:n}:s);F(o),x(m,t,{income:o.map(({id:s,name:r,values:c,parent_id:w})=>({id:s,name:r,values:c,parent_id:w})),expense:I.map(({id:s,name:r,values:c,parent_id:w})=>({id:s,name:r,values:c,parent_id:w}))})}else{const o=I.map(s=>s.id===D.id?{...s,name:n}:s);A(o),x(m,t,{income:N.map(({id:s,name:r,values:c,parent_id:w})=>({id:s,name:r,values:c,parent_id:w})),expense:o.map(({id:s,name:r,values:c,parent_id:w})=>({id:s,name:r,values:c,parent_id:w}))})}ae(!1)}async function on(){if(!D)return;const{error:n}=await P.from("finance_categories").delete().eq("id",D.id);if(n){u(n,"Создание категории");return}if(D.type==="income"){const a=N.filter(o=>o.id!==D.id);F(a),x(m,t,{income:a.map(({id:o,name:s,values:r,parent_id:c})=>({id:o,name:s,values:r,parent_id:c})),expense:I.map(({id:o,name:s,values:r,parent_id:c})=>({id:o,name:s,values:r,parent_id:c}))})}else{const a=I.filter(o=>o.id!==D.id);A(a),x(m,t,{income:N.map(({id:o,name:s,values:r,parent_id:c})=>({id:o,name:s,values:r,parent_id:c})),expense:a.map(({id:o,name:s,values:r,parent_id:c})=>({id:o,name:s,values:r,parent_id:c}))})}me(!1)}async function Te(n,a,o,s,r){n.preventDefault(),n.stopPropagation(),k&&_(!1),ye&&$(!1),z(null),B({type:a,catId:o,month:s});const c={category_id:o,year:t,month:s+1},w=!!G&&G.length>0;if(!w&&(!r||r===0)){B(null);return}const M=200,d=100,R=8,E=16,L=window.innerWidth,Z=window.innerHeight,he=n.currentTarget.getBoundingClientRect(),Le=he.left+he.width/2,qe=he.top+he.height/2;let le=Le+R,ce=qe+R;le+M>L-E&&(le=Le-M-R),ce+d>Z-E&&(ce=qe-d-R),le<E&&(le=E),ce<E&&(ce=E),Je({catId:o,type:a,month:s}),Xe({x:le,y:ce}),_e(!1),$(!0);const{data:fn}=await P.from("finance_entries").select("amount, note, included, position").match(c).order("position",{ascending:!0}).order("created_at",{ascending:!0}),we=(fn||[]).map(pe=>({amount:Number(pe.amount)||0,note:pe.note,included:!!pe.included,position:pe.position??0}));if(en(we),!we.length&&!w){$(!1),B(null);return}_e(we.length>0)}async function dn(){const n=Ze||[];if(!n.length){$(!1),B(null);return}Ge(n.slice());try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{}$(!1),B(null)}async function un(){if(!Ce||!G||!G.length||!m)return;const{catId:n,type:a,month:o}=Ce,s={category_id:n,year:t,month:o+1};await P.from("finance_entries").delete().match(s);const r=G.map((M,d)=>({where:s,user_id:m,amount:M.amount,note:M.note,included:M.included,position:d}));await P.from("finance_entries").insert(r);const c=r.filter(M=>M.included).reduce((M,d)=>M+(d.amount||0),0),w=M=>M.map(d=>d.id===n?{...d,values:d.values.map((R,E)=>E===o?c:R)}:d);a==="income"?F(w(N)):A(w(I)),$(!1),B(null)}if(l.useEffect(()=>{const n=o=>{o.key==="Escape"&&(_(!1),$(!1),z(null),B(null))},a=()=>{_(!1),$(!1),z(null),B(null)};return window.addEventListener("keydown",n),window.addEventListener("wheel",a,{passive:!0}),()=>{window.removeEventListener("keydown",n),window.removeEventListener("wheel",a)}},[]),ve)return e.jsx("div",{className:"p-4",children:e.jsx(In,{rows:10})});const Q=t===S,mn=Array.from({length:7}).map((n,a)=>S-3+a);return e.jsxs(xn.Fragment,{children:[e.jsxs("div",{className:"space-y-6 finance-page",onContextMenu:n=>{n.preventDefault()},children:[e.jsx(Pn,{year:t,years:mn,onYearChange:b,onAddCategory:()=>{Y(V.INCOME),K(null),q(!0)},onShowStats:()=>Me(!0)}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Категория"})}),Ye.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsx(Be,{title:"Доходы",onAdd:()=>{Y(V.INCOME),K(null),q(!0)}}),oe.map(n=>{const a=!!Ae[n.id],o=a?Ae[n.id]:n.values;return e.jsx(He,{type:"income",row:n,values:o,isCurrentYear:Q,currentMonth:h,hasChildren:a,collapsed:!!O[n.id],onToggleCollapse:s=>X(r=>({...r,[s]:!r[s]})),onNameContext:(s,r)=>Fe(s,r),onCellContext:Te,onCellEdit:(s,r,c)=>{i({id:r,name:n.name,type:s}),y(c),se(!0)},fmt:re,ctxCatHighlight:Re,ctxCellHighlight:De})}),e.jsx(Be,{title:"Расходы",onAdd:()=>{Y(V.EXPENSE),K(null),q(!0)}}),Se.map(n=>{const a=!!Oe[n.id],o=a?Oe[n.id]:n.values;return e.jsx(He,{type:"expense",row:n,values:o,isCurrentYear:Q,currentMonth:h,hasChildren:a,collapsed:!!O[n.id],onToggleCollapse:s=>X(r=>({...r,[s]:!r[s]})),onNameContext:(s,r)=>Fe(s,r),onCellContext:Te,onCellEdit:(s,r,c)=>{i({id:r,name:n.name,type:s}),y(c),se(!0)},fmt:re,ctxCatHighlight:Re,ctxCellHighlight:De})})]}),e.jsxs("div",{className:"finance-grid",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",children:"Показатель"})}),Ye.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===h?"head-current":"finance-head"),children:e.jsxs("div",{className:"cell-head cell-right",children:[n," ",t]})},n)),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Доходы"})}),fe.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:re(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:600},children:"Расходы"})}),xe.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",children:re(n)})},a))]}),e.jsxs("div",{className:"finance-row contents",children:[e.jsx("div",{className:"finance-cell",children:e.jsx("div",{className:"cell-head",style:{fontWeight:700},children:"Баланс"})}),an.map((n,a)=>e.jsx("div",{className:"finance-cell "+(Q&&a===h?"col-current":""),children:e.jsx("div",{className:"cell-head cell-right",style:{fontWeight:700},children:re(n)})},a))]})]})]}),k&&D&&e.jsx(Fn,{pos:je,canAddSub:!(We(D.id,N)||We(D.id,I))?.parent_id,onClose:cn,onRename:()=>{Ie(D.name),ae(!0),_(!1),z(null)},onAddSub:()=>{Y(D.type),K({id:D.id,name:D.name}),q(!0),_(!1),z(null)},onDelete:()=>{me(!0),_(!1),z(null)}}),ye&&Ce&&e.jsx(Tn,{pos:Ve,onClose:()=>{$(!1),B(null)},canCopy:Qe,hasClipboard:!!(G&&G.length>0),onCopy:dn,onPaste:un}),e.jsxs(ge,{open:ee,onClose:()=>{q(!1),K(null)},title:H?"Новая подкатегория":"Новая категория",subtitle:H?`Родитель: ${H.name}`:void 0,footer:j({label:H?"Добавить подкатегорию":"Добавить категорию",onClick:ln,disabled:!te.trim()},{label:"Отмена",onClick:()=>{q(!1),K(null)}}),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Тип"}),e.jsx("div",{className:"flex-1",children:e.jsx(Dn,{value:ne,onChange:Y,fullWidth:!0})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("label",{className:"text-sm text-gray-600 w-28",children:"Название"}),e.jsx("input",{value:te,onChange:n=>de(n.target.value),placeholder:H?"Напр. Коммунальные":"Напр. Жильё",className:"border rounded-lg px-3 py-2 text-sm flex-1"})]})]}),e.jsx(ge,{open:tn,onClose:()=>ae(!1),title:"Переименовать категорию",footer:j({label:"Сохранить",onClick:rn,disabled:!be.trim()},{label:"Отмена",onClick:()=>ae(!1)}),children:e.jsx("input",{value:be,onChange:n=>Ie(n.target.value),className:"border rounded-lg px-3 py-2 text-sm w-full",autoFocus:!0})}),e.jsx(ge,{open:sn,onClose:()=>me(!1),title:"Удалить категорию?",footer:p({label:"Удалить",onClick:on},{label:"Отмена",onClick:()=>me(!1)}),children:e.jsx("div",{className:"text-sm text-gray-600",children:"Все записи в этой категории будут удалены без возможности восстановления."})}),ue&&J&&e.jsx(Rn,{open:ue,onClose:()=>se(!1),userId:m,categoryId:J.id,categoryName:J.name,monthIndex:C,year:t,onApply:n=>{const a=o=>o.map(s=>s.id===J.id?{...s,values:s.values.map((r,c)=>c===C?n:r)}:s);J.type==="income"?F(a(N)):A(a(I))}}),e.jsx(An,{open:nn,onClose:()=>Me(!1),year:t,incomeByMonth:fe,expenseByMonth:xe})]})}export{Vn as default};
