import{j as n,A as f,a as h}from"./index-BbY1QJhM.js";import{r as a}from"./vendor-CqGws4Uo.js";import"./supabase-BmeMSZYH.js";function d(){const[s,e]=a.useState(navigator.onLine),[t,r]=a.useState(!1);return a.useEffect(()=>{const i=()=>{e(!0),t&&(h("Соединение восстановлено","polite"),r(!1))},o=()=>{e(!1),r(!0),h("Соединение потеряно. Работа в автономном режиме","assertive")};return window.addEventListener("online",i),window.addEventListener("offline",o),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",o)}},[t]),{isOnline:s,wasOffline:t}}const S=()=>{const{isOnline:s}=d(),[e,t]=a.useState(!1);return a.useEffect(()=>{if(!s)t(!0);else{const r=setTimeout(()=>{t(!1)},3e3);return()=>clearTimeout(r)}},[s]),e?n.jsx("div",{className:"fixed top-0 left-0 right-0 z-50 bg-orange-500 text-white px-4 py-2 text-center text-sm",children:n.jsxs("div",{className:"flex items-center justify-center gap-2",children:[n.jsx("span",{children:"⚠️"}),n.jsx("span",{children:s?"Соединение восстановлено":"Нет подключения к интернету"})]})}):null};class m{queue=[];isProcessing=!1;add(e,t){const r={id:t||`operation_${Date.now()}_${Math.random()}`,operation:e,timestamp:Date.now(),retries:0};return this.queue.push(r),this.saveToStorage(),r.id}async process(){if(!(this.isProcessing||this.queue.length===0)){for(this.isProcessing=!0;this.queue.length>0;){const e=this.queue[0];try{await e.operation(),this.queue.shift(),this.saveToStorage()}catch(t){e.retries++,e.retries>=3?(this.queue.shift(),console.error("Operation failed after 3 retries:",e.id,t)):this.queue.push(this.queue.shift()),this.saveToStorage();break}}this.isProcessing=!1}}clear(){this.queue=[],this.saveToStorage()}getQueue(){return[...this.queue]}saveToStorage(){try{localStorage.setItem("offlineQueue",JSON.stringify(this.queue))}catch(e){console.error("Failed to save offline queue:",e)}}loadFromStorage(){try{const e=localStorage.getItem("offlineQueue");e&&(this.queue=JSON.parse(e))}catch(e){console.error("Failed to load offline queue:",e)}}}const c=new m;function p(){const{isOnline:s}=d(),[e,t]=a.useState(0);a.useEffect(()=>{c.loadFromStorage(),t(c.getQueue().length)},[]),a.useEffect(()=>{s&&e>0&&c.process().then(()=>{t(c.getQueue().length)})},[s,e]);const r=a.useCallback((l,u)=>{const g=c.add(l,u);return t(c.getQueue().length),g},[]),i=a.useCallback(async()=>{await c.process(),t(c.getQueue().length)},[]),o=a.useCallback(()=>{c.clear(),t(0)},[]);return{isOnline:s,queueLength:e,addOfflineOperation:r,processQueue:i,clearQueue:o}}const O=()=>{const{queueLength:s,processQueue:e,clearQueue:t}=p(),[r,i]=a.useState(!1);return s===0?null:n.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:n.jsxs("div",{className:"bg-blue-600 text-white rounded-lg shadow-lg p-4 max-w-sm",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsxs("span",{className:"font-medium",children:[s," операций в очереди"]}),n.jsx("button",{onClick:()=>i(!r),className:"text-white hover:text-gray-200","aria-label":r?"Свернуть":"Развернуть",children:r?"−":"+"})]}),r&&n.jsxs("div",{className:"space-y-2",children:[n.jsx("p",{className:"text-sm text-blue-100",children:"Операции будут выполнены при восстановлении соединения"}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(f,{variant:"secondary",size:"sm",onClick:e,className:"bg-blue-500 hover:bg-blue-400",children:"Попробовать сейчас"}),n.jsx(f,{variant:"ghost",size:"sm",onClick:t,className:"text-blue-100 hover:text-white",children:"Очистить"})]})]})]})})};function b(){"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(s=>{console.log("SW registered: ",s)}).catch(s=>{console.log("SW registration failed: ",s)})})}function j(s,e,t={}){const{cacheTimeout:r=5*60*1e3,offlineFallback:i}=t;return async()=>{try{const o=await s(),l={data:o,timestamp:Date.now()};try{localStorage.setItem(`cache_${e}`,JSON.stringify(l))}catch(u){console.warn("Failed to cache API result:",u)}return o}catch(o){try{const l=localStorage.getItem(`cache_${e}`);if(l){const u=JSON.parse(l);if(Date.now()-u.timestamp<r)return u.data}}catch(l){console.warn("Failed to read from cache:",l)}if(i!==void 0)return i;throw o}}}const q=OfflineSupport;export{S as OfflineIndicator,O as OfflineQueueIndicator,j as createOfflineApiCall,q as default,b as registerServiceWorker,p as useOfflineOperations,d as useOnlineStatus};
